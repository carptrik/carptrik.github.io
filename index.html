<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta name="google-site-verification" content="DbvwD_t2D1ABQ64NDUNPVEbSpcshzLXZ9KIzWLaIF7E" />
    <link rel="icon" type="image/svg+xml" href="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'%3E%3Cstyle%3E text { fill: %2310b981; font-weight: bold; font-family: sans-serif; } %3C/style%3E%3Crect width='100%25' height='100%25' fill='%230f172a' rx='20'/%3E%3Ctext x='50%25' y='50%25' dominant-baseline='central' text-anchor='middle' font-size='80'%3E‚úñ%3C/text%3E%3C/svg%3E">
    
    <title>√áARPTRƒ∞K PRO</title>
    
    <style>
        :root {
            /* Profesyonel "Deep Slate" Paleti */
            --bg-body: #0f172a;       /* √áok koyu mavi-gri */
            --bg-panel: #1e293b;      /* Panel rengi */
            --bg-card: #334155;       /* Kart/Input rengi */
            --primary: #10b981;       /* Emerald Green (Daha ≈üƒ±k bir ye≈üil) */
            --primary-hover: #059669;
            --accent: #8b5cf6;        /* Mor vurgular */
            --danger: #ef4444;        /* Kƒ±rmƒ±zƒ± */
            --text-main: #f8fafc;     /* Beyazƒ±msƒ± */
            --text-muted: #94a3b8;    /* Gri yazƒ± */
            --border: #334155;
            --shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
        }

        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; }
        
        body {
            font-family: 'Segoe UI', Inter, system-ui, sans-serif;
            background-color: var(--bg-body);
            color: var(--text-main);
            margin: 0; padding: 0;
            height: 100vh;
            display: flex;
            justify-content: center;
            overflow: hidden; /* Masa√ºst√ºnde scroll barƒ± gizle, i√ßerik kayacak */
        }

        /* --- LAYOUT GRID (DASHBOARD) --- */
        .app-layout {
            display: grid;
            grid-template-columns: 260px 1fr 300px; /* Sol - Orta - Saƒü */
            grid-template-rows: 1fr;
            width: 100%;
            max-width: 1600px;
            height: 100vh;
            gap: 20px;
            padding: 20px;
        }

        /* --- PANELS --- */
        .sidebar, .main-stage, .infobar {
            background: var(--bg-panel);
            border-radius: 16px;
            border: 1px solid rgba(255,255,255,0.05);
            box-shadow: var(--shadow);
            display: flex; flex-direction: column;
            overflow: hidden;
        }

        /* LEFT SIDEBAR */
        .sidebar { padding: 20px; gap: 20px; }
        .logo-area { text-align: center; padding-bottom: 20px; border-bottom: 1px solid var(--border); }
        .logo-text { font-size: 24px; font-weight: 900; letter-spacing: 2px; color: var(--primary); display: flex; align-items: center; justify-content: center; gap: 10px; }
        .logo-icon { font-size: 28px; }
        
        .nav-menu { display: flex; flex-direction: column; gap: 10px; flex: 1; }
        .nav-btn {
            background: transparent; border: 1px solid transparent; color: var(--text-muted);
            padding: 15px; border-radius: 12px; text-align: left; font-weight: 600; cursor: pointer;
            transition: 0.2s; display: flex; align-items: center; gap: 12px; font-size: 14px;
        }
        .nav-btn:hover { background: rgba(255,255,255,0.05); color: #fff; }
        .nav-btn.active { background: rgba(16, 185, 129, 0.1); color: var(--primary); border-color: rgba(16, 185, 129, 0.2); }
        .nav-icon { font-size: 18px; }

        .lang-switch { display: flex; gap: 10px; padding-top: 20px; border-top: 1px solid var(--border); }
        .lang-btn { flex: 1; background: var(--bg-card); border: none; color: var(--text-muted); padding: 8px; border-radius: 6px; cursor: pointer; font-weight: bold; font-size: 12px; transition: 0.2s; }
        .lang-btn.active { background: var(--primary); color: #000; }

        /* CENTER STAGE (Main Content) */
        .main-stage { position: relative; padding: 0; }
        .stage-content { flex: 1; padding: 30px; overflow-y: auto; display: flex; flex-direction: column; }
        
        /* RIGHT INFOBAR */
        .infobar { padding: 20px; gap: 20px; }
        .info-header { font-size: 12px; font-weight: 700; color: var(--text-muted); text-transform: uppercase; letter-spacing: 1px; display: flex; justify-content: space-between; align-items: center; }
        .mini-btn { background: none; border: none; color: var(--danger); font-size: 11px; font-weight: bold; cursor: pointer; opacity: 0.7; transition: 0.2s; }
        .mini-btn:hover { opacity: 1; text-decoration: underline; }
        .info-list { flex: 1; overflow-y: auto; background: rgba(0,0,0,0.2); border-radius: 8px; padding: 10px; border: 1px solid rgba(255,255,255,0.05); }
        .list-row { display: flex; justify-content: space-between; padding: 8px 5px; border-bottom: 1px solid rgba(255,255,255,0.05); font-size: 13px; }
        .list-row:last-child { border: none; }
        .col-head { display: flex; font-size: 10px; color: var(--text-muted); font-weight: bold; padding: 5px; background: rgba(255,255,255,0.05); border-radius: 4px; margin-bottom: 5px; }
        .col-item { flex: 1; text-align: center; }

        /* --- COMPONENTS --- */
        /* Section Titles */
        .section-title { font-size: 18px; font-weight: 700; color: #fff; margin-bottom: 15px; display: flex; align-items: center; gap: 10px; padding-bottom: 10px; border-bottom: 1px solid var(--border); }
        
        /* Number Grid */
        .num-grid { display: grid; grid-template-columns: repeat(8, 1fr); gap: 10px; margin-bottom: 25px; }
        .num-chk { display: none; }
        .num-box {
            background: var(--bg-card); color: var(--text-muted);
            height: 50px; display: flex; align-items: center; justify-content: center;
            border-radius: 10px; font-weight: 700; cursor: pointer; transition: 0.2s;
            border: 2px solid transparent;
        }
        .num-chk:checked + .num-box { background: var(--primary); color: #000; box-shadow: 0 0 15px rgba(16, 185, 129, 0.4); border-color: #fff; }
        
        /* Action Buttons */
        .action-row { display: flex; gap: 15px; margin-bottom: 30px; }
        .act-btn {
            background: var(--bg-card); border: 1px solid var(--border); color: var(--text-muted);
            padding: 10px 20px; border-radius: 8px; cursor: pointer; font-size: 12px; font-weight: bold; transition: 0.2s;
        }
        .act-btn:hover { background: rgba(255,255,255,0.1); color: #fff; }

        /* Mode Selection */
        .radio-group { display: flex; gap: 20px; margin-bottom: 30px; }
        .radio-card {
            flex: 1; background: var(--bg-card); padding: 15px; border-radius: 12px; cursor: pointer;
            border: 2px solid transparent; transition: 0.2s; position: relative;
        }
        .radio-card:hover { background: rgba(255,255,255,0.08); }
        .radio-card input { position: absolute; opacity: 0; }
        .radio-card.selected { border-color: var(--primary); background: rgba(16, 185, 129, 0.05); }
        .radio-title { font-weight: bold; font-size: 14px; color: #fff; margin-bottom: 5px; display: block; }
        .radio-desc { font-size: 11px; color: var(--text-muted); }
        .radio-input { background: transparent; border: none; border-bottom: 1px solid var(--primary); width: 30px; color: var(--primary); font-weight: bold; text-align: center; outline: none; }

        /* Big Start Button */
        .start-btn {
            width: 100%; padding: 20px; border-radius: 12px; border: none;
            background: linear-gradient(135deg, var(--primary), var(--primary-hover));
            color: #fff; font-size: 18px; font-weight: 800; letter-spacing: 1px;
            cursor: pointer; transition: 0.3s; box-shadow: 0 4px 20px rgba(16, 185, 129, 0.3);
            text-transform: uppercase;
        }
        .start-btn:hover { transform: translateY(-2px); box-shadow: 0 6px 25px rgba(16, 185, 129, 0.5); }

        /* GAME UI (Shared) */
        .screen { display: none; height: 100%; flex-direction: column; animation: fadeIn 0.4s ease; }
        .screen.active { display: flex; }
        @keyframes fadeIn { from{opacity:0; transform:translateY(10px)} to{opacity:1; transform:translateY(0)} }

        .hud-bar {
            display: flex; justify-content: space-between; background: rgba(0,0,0,0.3);
            padding: 15px 25px; border-radius: 12px; margin-bottom: 20px; border: 1px solid var(--border);
        }
        .hud-stat { text-align: center; }
        .hud-lbl { font-size: 10px; color: var(--text-muted); display: block; margin-bottom: 3px; }
        .hud-val { font-size: 20px; font-weight: 800; color: #fff; }

        /* Classic Game */
        .classic-q { flex: 1; display: flex; align-items: center; justify-content: center; font-size: 100px; font-weight: 900; color: #fff; text-shadow: 0 0 30px rgba(255,255,255,0.1); }
        .classic-inp { 
            width: 100%; max-width: 400px; margin: 0 auto; background: var(--bg-body); border: 2px solid var(--border);
            color: var(--primary); font-size: 50px; text-align: center; padding: 15px; border-radius: 16px;
            font-weight: bold; outline: none; font-family: monospace;
        }
        .classic-inp:focus { border-color: var(--primary); box-shadow: 0 0 20px rgba(16, 185, 129, 0.1); }
        .feedback { height: 30px; text-align: center; font-weight: bold; margin-top: 10px; font-size: 18px; }

        /* Racer Game */
        #racer-viewport { 
            flex: 1; width: 100%; background: #111; border-radius: 12px; overflow: hidden; position: relative; border: 2px solid var(--border);
        }
        canvas { width: 100%; height: 100%; display: block; }
        .racer-overlay { position: absolute; top: 15px; left: 15px; right: 15px; display: flex; justify-content: space-between; pointer-events: none; z-index: 10; font-weight: bold; font-size: 18px; text-shadow: 2px 2px 0 #000; }
        .racer-q-float {
            position: absolute; top: 20%; left: 50%; transform: translateX(-50%);
            background: rgba(15, 23, 42, 0.9); padding: 10px 30px; border-radius: 50px;
            border: 2px solid var(--primary); color: #fff; font-size: 32px; font-weight: 900;
            box-shadow: 0 0 20px rgba(16, 185, 129, 0.3); pointer-events: none; z-index: 10;
        }
        .mobile-controls { display: none; height: 120px; gap: 15px; margin-top: 15px; }
        .ctrl-btn { flex: 1; background: var(--bg-card); border: 1px solid var(--border); border-radius: 12px; font-size: 30px; color: #fff; cursor: pointer; }
        .ctrl-btn:active { background: var(--primary); color: #000; }

        /* Result Screen */
        .result-box { flex: 1; display: flex; flex-direction: column; align-items: center; justify-content: center; }
        .res-score { font-size: 80px; font-weight: 900; color: var(--primary); line-height: 1; margin-bottom: 10px; }
        .res-title { font-size: 16px; letter-spacing: 2px; color: var(--text-muted); text-transform: uppercase; }
        .res-stats { display: flex; gap: 30px; margin-top: 30px; }
        .res-stat-item { text-align: center; background: var(--bg-card); padding: 15px 25px; border-radius: 12px; }

        /* Modal */
        .modal-overlay { display: none; position: fixed; top:0; left:0; width:100%; height:100%; background: rgba(0,0,0,0.8); backdrop-filter: blur(5px); z-index: 999; justify-content: center; align-items: center; }
        .modal-box { background: var(--bg-panel); padding: 30px; border-radius: 20px; border: 1px solid var(--border); width: 90%; max-width: 400px; text-align: center; box-shadow: 0 20px 50px rgba(0,0,0,0.5); }
        .modal-btns { margin-top: 20px; display: flex; gap: 10px; justify-content: center; }
        .m-btn { padding: 10px 20px; border-radius: 8px; border: none; font-weight: bold; cursor: pointer; }
        .m-confirm { background: var(--primary); color: #000; }
        .m-cancel { background: var(--bg-card); color: #fff; }

        /* --- RESPONSIVE ADJUSTMENTS --- */
        @media (max-width: 1024px) {
            body { padding: 0; overflow-y: auto; height: auto; }
            .app-layout { display: flex; flex-direction: column; height: auto; padding: 10px; gap: 10px; }
            .sidebar { flex-direction: row; align-items: center; padding: 10px; flex-wrap: wrap; }
            .logo-area { border-bottom: none; padding: 0; padding-right: 15px; border-right: 1px solid var(--border); }
            .nav-menu { flex-direction: row; overflow-x: auto; padding-bottom: 0; }
            .lang-switch { padding-top: 0; border-top: none; margin-left: auto; border-left: 1px solid var(--border); padding-left: 15px; }
            .infobar { max-height: 400px; }
            .stage-content { min-height: 500px; }
            .num-grid { grid-template-columns: repeat(4, 1fr); }
            .mobile-controls { display: flex; } /* Show controls on mobile */
        }
    </style>
</head>
<body>

<div class="app-layout">
    
    <aside class="sidebar">
        <div class="logo-area">
            <div class="logo-text"><span class="logo-icon">‚úñ</span> √áARPTRƒ∞K</div>
        </div>
        
        <nav class="nav-menu">
            <button class="nav-btn active" onclick="setGameType('classic')" id="btn-nav-classic">
                <span class="nav-icon">üìä</span> <span data-i18n="tab_klasik">KLASƒ∞K MOD</span>
            </button>
            <button class="nav-btn" onclick="setGameType('racer')" id="btn-nav-racer">
                <span class="nav-icon">üèéÔ∏è</span> <span data-i18n="tab_yaris">YARI≈û MODU</span>
            </button>
        </nav>

        <div class="lang-switch">
            <button class="lang-btn active" id="l-tr" onclick="setLang('tr')">TR</button>
            <button class="lang-btn" id="l-en" onclick="setLang('en')">EN</button>
        </div>
    </aside>

    <main class="main-stage">
        
        <div id="view-setup" class="screen active stage-content">
            <div class="section-title"><span data-i18n="carp_sayilar">SAYI SE√áƒ∞Mƒ∞</span></div>
            <div class="num-grid">
                <label><input type="checkbox" class="num-chk" value="2" checked><div class="num-box">2</div></label>
                <label><input type="checkbox" class="num-chk" value="3" checked><div class="num-box">3</div></label>
                <label><input type="checkbox" class="num-chk" value="4" checked><div class="num-box">4</div></label>
                <label><input type="checkbox" class="num-chk" value="5" checked><div class="num-box">5</div></label>
                <label><input type="checkbox" class="num-chk" value="6" checked><div class="num-box">6</div></label>
                <label><input type="checkbox" class="num-chk" value="7" checked><div class="num-box">7</div></label>
                <label><input type="checkbox" class="num-chk" value="8" checked><div class="num-box">8</div></label>
                <label><input type="checkbox" class="num-chk" value="9" checked><div class="num-box">9</div></label>
            </div>
            
            <div class="action-row">
                <button class="act-btn" onclick="toggleAll(true)" data-i18n="tumu">T√úM√ú</button>
                <button class="act-btn" onclick="toggleAll(false)" data-i18n="temizle">TEMƒ∞ZLE</button>
            </div>

            <div class="section-title"><span data-i18n="ayarlar">OYUN AYARLARI</span></div>
            <div class="radio-group">
                <div class="radio-card selected" onclick="selectRadio(this, 'repeat')">
                    <input type="radio" name="gMode" value="repeat" checked>
                    <span class="radio-title" data-i18n="mod_tekrar_1">T√ºm√ºn√º Sor</span>
                    <span class="radio-desc"><input type="number" id="inp-repeat" value="1" class="radio-input"> <span data-i18n="mod_tekrar_2">kez tekrar et</span></span>
                </div>
                <div class="radio-card" onclick="selectRadio(this, 'limit')">
                    <input type="radio" name="gMode" value="limit">
                    <span class="radio-title" data-i18n="mod_limit_1">Rastgele</span>
                    <span class="radio-desc"><input type="number" id="inp-limit" value="20" class="radio-input"> <span data-i18n="mod_limit_2">soru sor</span></span>
                </div>
            </div>

            <div style="margin-top: auto;">
                <button class="start-btn" id="main-start-btn" onclick="startGame()">BA≈ûLAT</button>
            </div>
        </div>

        <div id="view-classic" class="screen stage-content">
            <div class="hud-bar">
                <div class="hud-stat"><span class="hud-lbl" data-i18n="tablo_puan">PUAN</span><span class="hud-val" style="color:var(--primary)" id="c-score">100</span></div>
                <div class="hud-stat"><span class="hud-lbl" data-i18n="tablo_soru">SORU</span><span class="hud-val"><span id="c-curr">1</span>/<span id="c-total">20</span></span></div>
                <div class="hud-stat"><span class="hud-lbl" data-i18n="tablo_hiz">HIZ</span><span class="hud-val" id="c-speed">0.0s</span></div>
            </div>
            
            <div class="classic-q" id="c-q-text">2 x 2</div>
            <input type="number" class="classic-inp" id="c-input" inputmode="numeric" placeholder="?" autocomplete="off">
            <div class="feedback" id="c-feedback"></div>

            <div style="margin-top: auto; display: flex; gap: 10px; width: 100%;">
                <button class="act-btn" style="flex:1" onclick="pauseGame()" data-i18n="duraklat">DURAKLAT</button>
                <button class="act-btn" style="flex:1; border-color:var(--danger); color:var(--danger);" onclick="finishConfirm()" data-i18n="bitir">Bƒ∞Tƒ∞R</button>
            </div>
        </div>

        <div id="view-racer" class="screen stage-content">
            <div id="racer-viewport">
                <canvas id="racer-canvas"></canvas>
                <div class="racer-overlay">
                    <span style="color:var(--primary)"><span data-i18n="tablo_puan">P</span>: <span id="r-score">0</span></span>
                    <span style="color:var(--danger)">HP: <span id="r-lives">3</span></span>
                </div>
                <div class="racer-q-float" id="r-q-text">---</div>
            </div>
            
            <div class="mobile-controls">
                <button class="ctrl-btn" ontouchstart="racerInput(-1)" onmousedown="racerInput(-1)">‚¨ÖÔ∏è</button>
                <button class="ctrl-btn" ontouchstart="racerInput(1)" onmousedown="racerInput(1)">‚û°Ô∏è</button>
            </div>
            
            <div style="margin-top: 10px; width: 100%;">
                <button class="act-btn" style="width:100%; border-color:var(--danger); color:var(--danger);" onclick="finishConfirm()" data-i18n="bitir">Bƒ∞Tƒ∞R</button>
            </div>
        </div>

        <div id="view-result" class="screen stage-content">
            <div class="result-box">
                <div class="res-title" data-i18n="seans_bitti">SEANS Bƒ∞TTƒ∞</div>
                <div class="res-score" id="res-score">100</div>
                
                <div class="res-stats">
                    <div class="res-stat-item">
                        <div class="res-title" style="font-size:10px" data-i18n="tablo_hiz">HIZ</div>
                        <div style="font-size:24px; font-weight:bold" id="res-speed">0.0s</div>
                    </div>
                    <div class="res-stat-item">
                        <div class="res-title" style="font-size:10px" data-i18n="tablo_hata">HATA</div>
                        <div style="font-size:24px; font-weight:bold; color:var(--danger)" id="res-err">0</div>
                    </div>
                </div>
                
                <button class="start-btn" style="margin-top: 40px; max-width: 200px;" onclick="goHome()" data-i18n="tamam_btn">TAMAM</button>
            </div>
        </div>

    </main>

    <aside class="infobar">
        <div class="info-header">
            <span data-i18n="hata_listesi">HATA Lƒ∞STESƒ∞</span>
            <button class="mini-btn" onclick="startErrorPractice()" data-i18n="hatalara_calis">√áALI≈û ‚ñ∂</button>
        </div>
        
        <div class="radio-group" style="gap:5px; margin-bottom:10px;">
            <label style="font-size:11px; cursor:pointer; color:var(--text-muted);"><input type="radio" name="errMode" value="weighted" checked> <span data-i18n="puan_kadar">Puan</span></label>
            <label style="font-size:11px; cursor:pointer; color:var(--text-muted);"><input type="radio" name="errMode" value="single"> <span data-i18n="bir_kez">1 Kez</span></label>
        </div>

        <div id="list-errors" class="info-list" style="max-height: 30%;">
            <div style="text-align:center; font-size:12px; color:#555; padding:10px;" data-i18n="liste_temiz">Temiz</div>
        </div>
        <div style="text-align:right;"><button class="mini-btn" onclick="resetData()" data-i18n="listeyi_temizle">TEMƒ∞ZLE</button></div>

        <div style="height:1px; background:var(--border); margin:10px 0;"></div>

        <div class="info-header">
            <span data-i18n="gecmis_skorlar">GE√áMƒ∞≈û</span>
        </div>
        <div class="col-head">
            <span class="col-item" data-i18n="tablo_puan">P</span>
            <span class="col-item" data-i18n="tablo_hiz">HIZ</span>
            <span class="col-item" data-i18n="tablo_hata">H</span>
            <span class="col-item" data-i18n="tablo_soru">Q</span>
        </div>
        <div id="list-history" class="info-list">
            <div style="text-align:center; font-size:12px; color:#555; padding:10px;" data-i18n="gecmis_yok">Yok</div>
        </div>
        <div style="text-align:right;"><button class="mini-btn" onclick="clearHistory()" data-i18n="gecmisi_sil">Sƒ∞L</button></div>
    </aside>

</div>

<div id="customModal" class="modal-overlay">
    <div class="modal-box">
        <div id="m-text" style="font-size:18px; margin-bottom:20px; color:#fff;">...</div>
        <div class="modal-btns" id="m-btns"></div>
    </div>
</div>

<script>
/* ================= SYSTEM ================= */
const DATA = {
    lang: 'tr',
    activeType: 'classic', // Selected in menu
    db: JSON.parse(localStorage.getItem('carptrik_data')) || {},
    history: JSON.parse(localStorage.getItem('carptrik_history')) || []
};

const TEXT = {
    tr: {
        carp_sayilar:"SAYI SE√áƒ∞Mƒ∞", tumu:"T√úM√ú", temizle:"TEMƒ∞ZLE", ayarlar:"OYUN AYARLARI",
        mod_tekrar_1:"T√ºm√ºn√º", mod_tekrar_2:"kez", mod_limit_1:"Rastgele", mod_limit_2:"soru",
        hata_listesi:"HATALAR", hatalara_calis:"√áALI≈û ‚ñ∂", liste_temiz:"Temiz.",
        gecmis_skorlar:"GE√áMƒ∞≈û", gecmisi_sil:"Sƒ∞L", tablo_puan:"P", tablo_hiz:"HIZ", tablo_hata:"H", tablo_soru:"Q",
        gecmis_yok:"Yok.", duraklat:"DURAKLAT", bitir:"Bƒ∞Tƒ∞R", seans_bitti:"SEANS Bƒ∞TTƒ∞", tamam_btn:"TAMAM",
        alert_sayi:"L√ºtfen en az bir sayƒ± se√ßin!", alert_hata:"Hata listeniz temiz.",
        confirm_bitir:"Bitirmek istediƒüinize emin misiniz?", confirm_sil:"T√ºm verileri silmek istiyor musunuz?",
        tab_klasik:"KLASƒ∞K MOD", tab_yaris:"YARI≈û MODU",
        baslat_klasik:"KLASƒ∞K BA≈ûLAT", baslat_yaris:"YARI≈û BA≈ûLAT",
        dogru:"DOƒûRU", yanlis:"YANLI≈û", puan_kadar:"Puan", bir_kez:"1 Kez", listeyi_temizle:"TEMƒ∞ZLE",
        can:"CAN", iletisim_text:"√ñneri:"
    },
    en: {
        carp_sayilar:"NUMBERS", tumu:"ALL", temizle:"CLEAR", ayarlar:"SETTINGS",
        mod_tekrar_1:"All", mod_tekrar_2:"times", mod_limit_1:"Random", mod_limit_2:"qs",
        hata_listesi:"ERRORS", hatalara_calis:"TRAIN ‚ñ∂", liste_temiz:"Clean.",
        gecmis_skorlar:"HISTORY", gecmisi_sil:"CLEAR", tablo_puan:"S", tablo_hiz:"SPD", tablo_hata:"E", tablo_soru:"Q",
        gecmis_yok:"Empty.", duraklat:"PAUSE", bitir:"END", seans_bitti:"FINISHED", tamam_btn:"OK",
        alert_sayi:"Select numbers first!", alert_hata:"No errors recorded.",
        confirm_bitir:"Are you sure?", confirm_sil:"Delete everything?",
        tab_klasik:"CLASSIC MODE", tab_yaris:"RACER MODE",
        baslat_klasik:"START CLASSIC", baslat_yaris:"START RACER",
        dogru:"CORRECT", yanlis:"WRONG", puan_kadar:"Score", bir_kez:"Once", listeyi_temizle:"CLEAR",
        can:"HP", iletisim_text:"Contact:"
    }
};

/* ================= INIT & UTILS ================= */
function init() {
    const l = localStorage.getItem('carptrik_lang');
    if(l) DATA.lang = l;
    setLang(DATA.lang);
    renderLists();
    
    // Set default tab selection visual
    setGameType('classic');
}

function setLang(l) {
    DATA.lang = l;
    localStorage.setItem('carptrik_lang', l);
    document.getElementById('l-tr').classList.toggle('active', l==='tr');
    document.getElementById('l-en').classList.toggle('active', l==='en');
    
    document.querySelectorAll('[data-i18n]').forEach(el => {
        const k = el.getAttribute('data-i18n');
        if(TEXT[l][k]) el.innerText = TEXT[l][k];
    });
    
    // Update button text dynamic
    updateStartButtonText();
    renderLists();
}

function setGameType(type) {
    DATA.activeType = type;
    document.getElementById('btn-nav-classic').classList.toggle('active', type==='classic');
    document.getElementById('btn-nav-racer').classList.toggle('active', type==='racer');
    updateStartButtonText();
}

function updateStartButtonText() {
    const btn = document.getElementById('main-start-btn');
    const labelKey = DATA.activeType === 'classic' ? 'baslat_klasik' : 'baslat_yaris';
    btn.innerText = TEXT[DATA.lang][labelKey];
}

function showScreen(id) {
    document.querySelectorAll('.screen').forEach(s => s.classList.remove('active'));
    document.getElementById('view-'+id).classList.add('active');
}

/* UI INPUTS */
function selectRadio(el, val) {
    // Visual selection for custom radio cards
    document.querySelectorAll('.radio-card').forEach(c => c.classList.remove('selected'));
    el.classList.add('selected');
    el.querySelector('input').checked = true;
}
function toggleAll(v) { document.querySelectorAll('.num-chk').forEach(c => c.checked=v); }
function getNums() { return Array.from(document.querySelectorAll('.num-chk:checked')).map(c=>parseInt(c.value)); }

/* MODAL */
function modal(msg, onYes) {
    const o = document.getElementById('customModal');
    document.getElementById('m-text').innerText = msg;
    const b = document.getElementById('m-btns');
    if(onYes) {
        b.innerHTML = `<button class="m-btn m-confirm" onclick="doYes()">${TEXT[DATA.lang].modal_evet}</button><button class="m-btn m-cancel" onclick="closeModal()">${TEXT[DATA.lang].modal_iptal}</button>`;
        window.doYes = () => { onYes(); closeModal(); };
    } else {
        b.innerHTML = `<button class="m-btn m-confirm" onclick="closeModal()">${TEXT[DATA.lang].tamam_btn}</button>`;
    }
    o.style.display = 'flex';
}
function closeModal() { document.getElementById('customModal').style.display='none'; }

/* ================= GAME ENGINE ================= */
let Game = {
    type: 'classic',
    qList: [], total:0, idx:0, score:100, errors:0, times:[], startT:0, currQ:null,
    // Racer specific
    r: { active:false, loop:null, lane:1, x:0, cars:[], parts:[], speed:5, lives:3, nextSpawn:0 }
};

function startGame() {
    const nums = getNums();
    if(nums.length === 0) return modal(TEXT[DATA.lang].alert_sayi);

    let pool = [];
    nums.forEach(n1 => nums.forEach(n2 => pool.push({n1, n2})));
    
    Game.qList = [];
    const mode = document.querySelector('input[name="gMode"]:checked').value;
    
    if(mode === 'repeat') {
        const cnt = parseInt(document.getElementById('inp-repeat').value)||1;
        for(let i=0; i<cnt; i++) Game.qList.push(...pool);
    } else {
        const lim = parseInt(document.getElementById('inp-limit').value)||20;
        for(let i=0; i<lim; i++) Game.qList.push(pool[Math.floor(Math.random()*pool.length)]);
    }
    Game.qList.sort(()=>Math.random()-0.5);

    // Reset State
    Game.type = DATA.activeType;
    Game.total = Game.qList.length;
    Game.idx = 0; Game.score = 100; Game.errors = 0; Game.times = [];
    
    if(Game.type === 'classic') {
        showScreen('classic');
        nextQClassic();
    } else {
        showScreen('racer');
        initRacer();
    }
}

function startErrorPractice() {
    const keys = Object.keys(DATA.db);
    if(keys.length === 0) return modal(TEXT[DATA.lang].alert_hata);
    
    Game.qList = [];
    const mode = document.querySelector('input[name="errMode"]:checked').value;
    keys.forEach(k => {
        const [n1, n2] = k.split('x').map(Number);
        const c = mode === 'single' ? 1 : DATA.db[k].score;
        for(let i=0; i<c; i++) Game.qList.push({n1,n2});
    });
    Game.qList.sort(()=>Math.random()-0.5);
    
    Game.type = 'classic'; // Error practice is always classic
    Game.total = Game.qList.length; Game.idx = 0; Game.score = 100; Game.errors = 0; Game.times = [];
    showScreen('classic');
    nextQClassic();
}

function finishConfirm() { modal(TEXT[DATA.lang].confirm_bitir, endGame); }

function endGame() {
    if(Game.r.loop) cancelAnimationFrame(Game.r.loop);
    
    // Proportional Score
    if(Game.total > 0 && Game.idx < Game.total) {
        Game.score = Math.round(Game.score * (Game.idx / Game.total));
    }
    const avg = Game.times.length ? (Game.times.reduce((a,b)=>a+b,0)/Game.times.length).toFixed(1) : "0.0";
    
    DATA.history.unshift({score:Game.score, speed:avg, errors:Game.errors, q:Game.idx});
    if(DATA.history.length > 20) DATA.history.pop();
    localStorage.setItem('carptrik_history', JSON.stringify(DATA.history));
    renderLists();

    document.getElementById('res-score').innerText = Game.score;
    document.getElementById('res-speed').innerText = avg+'s';
    document.getElementById('res-err').innerText = Game.errors;
    showScreen('result');
}

function goHome() { showScreen('setup'); }

/* --- CLASSIC LOGIC --- */
function nextQClassic() {
    if(Game.idx >= Game.total) return endGame();
    Game.currQ = Game.qList[Game.idx];
    
    document.getElementById('c-q-text').innerText = `${Game.currQ.n1} x ${Game.currQ.n2}`;
    document.getElementById('c-curr').innerText = Game.idx + 1;
    document.getElementById('c-total').innerText = Game.total;
    document.getElementById('c-score').innerText = Game.score;
    document.getElementById('c-feedback').innerText = "";
    
    const i = document.getElementById('c-input');
    i.value = ''; i.disabled = false; i.focus();
    Game.startT = Date.now();
}

document.getElementById('c-input').addEventListener('input', function() {
    const ans = Game.currQ.n1 * Game.currQ.n2;
    if(this.value.length >= ans.toString().length) {
        const val = parseInt(this.value);
        const k = `${Game.currQ.n1}x${Game.currQ.n2}`;
        if(!DATA.db[k]) DATA.db[k] = {score:0};
        
        if(val === ans) {
            Game.times.push((Date.now()-Game.startT)/1000);
            if(DATA.db[k].score > 0) DATA.db[k].score--;
            document.getElementById('c-feedback').innerText = TEXT[DATA.lang].dogru;
            document.getElementById('c-feedback').style.color = 'var(--primary)';
            
            const avg = Game.times.reduce((a,b)=>a+b,0)/Game.times.length;
            document.getElementById('c-speed').innerText = avg.toFixed(1)+'s';
            
            Game.idx++;
            setTimeout(nextQClassic, 300);
        } else {
            Game.errors++;
            DATA.db[k].score += 2;
            Game.score = Math.max(0, Game.score-5);
            document.getElementById('c-feedback').innerText = TEXT[DATA.lang].yanlis;
            document.getElementById('c-feedback').style.color = 'var(--danger)';
            setTimeout(nextQClassic, 800);
        }
        if(DATA.db[k].score <= 0) delete DATA.db[k];
        localStorage.setItem('carptrik_data', JSON.stringify(DATA.db));
        renderLists();
    }
});

function pauseGame() { 
    alert("PAUSED"); 
    if(Game.type === 'classic') document.getElementById('c-input').focus();
}

/* --- RACER LOGIC V3 (Rewrite) --- */
const cvs = document.getElementById('racer-canvas');
const ctx = cvs.getContext('2d');

function initRacer() {
    cvs.width = cvs.offsetWidth; cvs.height = cvs.offsetHeight;
    
    Game.r.active = true;
    Game.r.lives = 3;
    Game.r.score = 0;
    Game.r.lane = 1;
    Game.r.x = (1 * (cvs.width/4)) + (cvs.width/8); // Target X
    Game.r.currX = Game.r.x; // Actual X
    Game.r.cars = [];
    Game.r.parts = [];
    Game.r.speed = 5;
    
    spawnRacerQ();
    Game.r.loop = requestAnimationFrame(racerLoop);
}

function spawnRacerQ() {
    if(Game.idx >= Game.total) { endGame(); return; }
    
    Game.currQ = Game.qList[Game.idx];
    document.getElementById('r-q-text').innerText = `${Game.currQ.n1} x ${Game.currQ.n2}`;
    document.getElementById('r-score').innerText = Game.score;
    document.getElementById('r-lives').innerText = Game.r.lives;
    
    const ans = Game.currQ.n1 * Game.currQ.n2;
    let opts = [ans];
    while(opts.length < 4) {
        let f = ans + (Math.floor(Math.random()*10)-5);
        if(f>0 && f!==ans && !opts.includes(f)) opts.push(f);
    }
    opts.sort(()=>Math.random()-0.5);
    
    // Spawn 4 cars at once
    Game.r.cars = [];
    for(let i=0; i<4; i++) {
        Game.r.cars.push({
            lane: i,
            y: -250 - (Math.random()*150), // Staggered start
            val: opts[i],
            isCorrect: opts[i] === ans,
            color: opts[i] === ans ? '#f59e0b' : ['#ef4444','#10b981','#3b82f6'][Math.floor(Math.random()*3)]
        });
    }
    Game.startT = Date.now();
}

function racerLoop() {
    if(!Game.r.active || Game.type !== 'racer') return;
    
    ctx.clearRect(0,0,cvs.width, cvs.height);
    const lw = cvs.width/4;
    
    // Road
    ctx.fillStyle = "#1e293b"; ctx.fillRect(0,0,cvs.width,cvs.height);
    ctx.strokeStyle = "#334155"; ctx.lineWidth=2; ctx.setLineDash([20,30]);
    for(let i=1; i<4; i++) { ctx.beginPath(); ctx.moveTo(i*lw,0); ctx.lineTo(i*lw,cvs.height); ctx.stroke(); }
    
    // Player Update (Lerp)
    const tx = (Game.r.lane * lw) + (lw/2);
    Game.r.currX += (tx - Game.r.currX) * 0.15;
    const px = Game.r.currX; const py = cvs.height - 100;
    
    // Player Draw
    ctx.fillStyle = "#10b981"; ctx.fillRect(px-20, py, 40, 70);
    ctx.fillStyle = "rgba(16,185,129,0.3)"; ctx.beginPath(); ctx.moveTo(px-15,py); ctx.lineTo(px-35,py-150); ctx.lineTo(px+35,py-150); ctx.lineTo(px+15,py); ctx.fill();

    // Cars & Collision
    for(let i=Game.r.cars.length-1; i>=0; i--) {
        let c = Game.r.cars[i];
        c.y += Game.r.speed;
        const cx = (c.lane * lw) + (lw/2);
        
        ctx.fillStyle = c.color; ctx.fillRect(cx-20, c.y, 40, 70);
        ctx.fillStyle = "#fff"; ctx.font="bold 20px Arial"; ctx.textAlign="center"; ctx.fillText(c.val, cx, c.y+40);
        
        // Check Hit (Y axis intersect + Lane match)
        // Player Y: py to py+70
        // Car Y: c.y to c.y+70
        // Horizontal: using lane index logic for logic, but visual position for feel
        if(c.y + 70 > py && c.y < py + 70) {
            // Lane check (simple integer check is safest for logic)
            if(c.lane === Game.r.lane) {
                if(c.isCorrect) {
                    // Correct Hit
                    Game.times.push((Date.now()-Game.startT)/1000);
                    Game.r.speed += 0.2;
                    explode(cx, c.y, '#fff');
                    Game.idx++;
                    Game.r.cars = []; // Clear current wave
                    setTimeout(spawnRacerQ, 500); // Next wave
                } else {
                    // Wrong Hit
                    Game.r.lives--;
                    Game.score = Math.max(0, Game.score-10);
                    Game.errors++;
                    shakeCanvas();
                    Game.r.cars.splice(i, 1); // Remove only this car
                    document.getElementById('r-lives').innerText = Game.r.lives;
                    if(Game.r.lives <= 0) { endGame(); return; }
                }
            }
        }
        else if (c.y > cvs.height) {
            Game.r.cars.splice(i, 1);
            // If correct answer passed, respawn same Q
            if(c.isCorrect && Game.r.cars.length === 0) spawnRacerQ();
        }
    }

    // Particles
    for(let i=Game.r.parts.length-1; i>=0; i--) {
        let p = Game.r.parts[i];
        p.x+=p.vx; p.y+=p.vy; p.life--;
        ctx.fillStyle=p.c; ctx.fillRect(p.x,p.y,4,4);
        if(p.life<=0) Game.r.parts.splice(i,1);
    }

    Game.r.loop = requestAnimationFrame(racerLoop);
}

function racerInput(d) {
    let n = Game.r.lane + d;
    if(n>=0 && n<=3) Game.r.lane = n;
}
window.addEventListener('keydown', e => {
    if(Game.type === 'racer') {
        if(e.key === 'ArrowLeft' || e.key === 'a') racerInput(-1);
        if(e.key === 'ArrowRight' || e.key === 'd') racerInput(1);
    }
});

function explode(x,y,c) {
    for(let i=0;i<20;i++) Game.r.parts.push({x:x, y:y, vx:(Math.random()-0.5)*10, vy:(Math.random()-0.5)*10, life:30, c:c});
}
function shakeCanvas() {
    const el = document.getElementById('racer-container');
    el.classList.remove('shake'); void el.offsetWidth; el.classList.add('shake');
}

/* ================= LISTS & DATA ================= */
function renderLists() {
    // Errors
    const el = document.getElementById('list-errors');
    if(Object.keys(DATA.db).length === 0) {
        el.innerHTML = `<div style="text-align:center; padding:10px; color:#555;">${TEXT[DATA.lang].liste_temiz}</div>`;
    } else {
        let h = "";
        Object.keys(DATA.db).sort((a,b)=>DATA.db[b].score - DATA.db[a].score).forEach(k => {
            h += `<div class="list-row"><span>${k}</span><b style="color:var(--danger);">+${DATA.db[k].score}</b></div>`;
        });
        el.innerHTML = h;
    }
    // History
    const hl = document.getElementById('list-history');
    if(DATA.history.length === 0) {
        hl.innerHTML = `<div style="text-align:center; padding:10px; color:#555;">${TEXT[DATA.lang].gecmis_yok}</div>`;
    } else {
        let h = "";
        DATA.history.forEach(x => {
            h += `<div class="list-row">
                <span class="col-item" style="color:var(--primary); font-weight:bold">${x.score}</span>
                <span class="col-item">${x.speed}s</span>
                <span class="col-item" style="color:${x.errors>0?'var(--danger)':'#666'}">${x.errors}</span>
                <span class="col-item" style="color:#666">${x.q}</span>
            </div>`;
        });
        hl.innerHTML = h;
    }
}

function clearHistory() {
    modal(TEXT[DATA.lang].confirm_sil, () => {
        DATA.history = []; localStorage.setItem('carptrik_history', JSON.stringify([])); renderLists();
    });
}
function resetData() {
    modal(TEXT[DATA.lang].confirm_sil, () => {
        DATA.db = {}; localStorage.removeItem('carptrik_data'); renderLists();
    });
}

// Boot
init();
window.addEventListener('resize', () => { if(Game.type==='racer') initRacer(); });
</script>
</body>
</html>
