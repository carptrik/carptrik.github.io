<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta name="google-site-verification" content="DbvwD_t2D1ABQ64NDUNPVEbSpcshzLXZ9KIzWLaIF7E" />
    <link rel="icon" type="image/svg+xml" href="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'%3E%3Cstyle%3E text { fill: %2300ffaa; font-weight: bold; font-family: sans-serif; } %3C/style%3E%3Crect width='100%25' height='100%25' fill='%230d0d0d' rx='20'/%3E%3Ctext x='50%25' y='50%25' dominant-baseline='central' text-anchor='middle' font-size='80'%3E‚úñ%3C/text%3E%3C/svg%3E">
    
    <title>√áARPTRƒ∞K - Matematik Oyunlarƒ±</title>
    <meta name="description" content="√áarpƒ±m tablosunu oyunla √∂ƒüren. Klasik mod ve Araba Yarƒ±≈üƒ± modu.">
    <meta name="theme-color" content="#121212">
    
    <style>
        :root {
            --primary: #00ffaa; --bg: #121212; --surface: #1e1e1e; --text: #ffffff;
            --text-secondary: #aaaaaa; --accent: #a040ff; --danger: #ff4757; --border: #333;
        }
        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; }
        body { font-family: 'Inter', sans-serif; background-color: var(--bg); color: var(--text); margin: 0; padding: 0; display: flex; flex-direction: column; align-items: center; min-height: 100vh; overflow-x: hidden; }
        
        header { width: 100%; padding: 15px 20px; text-align: center; background: rgba(30,30,30,0.9); position: sticky; top: 0; z-index: 100; border-bottom: 1px solid var(--border); display:flex; justify-content:center; align-items:center; }
        h1 { margin: 0; color: var(--primary); font-size: 24px; font-weight: 900; letter-spacing: 2px; }
        .lang-switch { position: absolute; right: 20px; }
        .lang-btn { background: transparent; border: 1px solid var(--border); color: var(--text-secondary); padding: 5px 10px; border-radius: 6px; cursor: pointer; font-size: 12px; font-weight: bold; }
        .lang-btn.active { background: var(--primary); color: #000; border-color: var(--primary); }

        .mode-tabs { display: flex; justify-content: center; gap: 15px; margin: 20px 0; padding: 0 15px; width:100%; max-width:600px; }
        .tab-btn { flex: 1; background: var(--surface); border: 1px solid var(--border); color: var(--text-secondary); padding: 12px 0; border-radius: 12px; cursor: pointer; font-size: 14px; font-weight: bold; display: flex; align-items: center; justify-content: center; gap: 8px; transition: 0.2s; }
        .tab-btn.active { background: var(--primary); color: #000; border-color: var(--primary); box-shadow: 0 0 15px rgba(0,255,170,0.2); }

        .app-container { width: 100%; max-width: 1200px; padding: 0 20px; display: grid; gap: 20px; grid-template-columns: 1fr; }
        .classic-layout { grid-template-columns: 1fr; }
        .racer-layout { display: flex; flex-direction: column; align-items: center; width: 100%; max-width: 600px; margin: 0 auto; }
        @media (min-width: 900px) { .classic-layout { grid-template-columns: 280px 1fr 280px; } }

        .card { background: var(--surface); border-radius: 16px; border: 1px solid var(--border); padding: 20px; box-shadow: 0 10px 30px rgba(0,0,0,0.3); display: flex; flex-direction: column; }
        .card-title { color: var(--accent); font-size: 14px; font-weight: bold; margin-bottom: 15px; text-transform: uppercase; border-bottom: 1px solid var(--border); padding-bottom: 10px; }

        .btn-primary { background: var(--primary); color: #000; width: 100%; padding: 15px; border-radius: 12px; border: none; font-weight: 900; cursor: pointer; font-size: 16px; margin-top: 15px; text-transform: uppercase; }
        .btn-primary:active { transform: scale(0.98); }
        .btn-danger { background: rgba(255, 71, 87, 0.1); color: var(--danger); border: 1px solid var(--danger); width: 100%; padding: 10px; border-radius: 8px; font-weight: bold; cursor: pointer; font-size: 12px; margin-top: 10px; }
        
        .option-row { display: flex; align-items: center; padding: 10px; background: rgba(255,255,255,0.05); border-radius: 8px; margin-bottom: 8px; cursor: pointer; }
        .option-row input { margin-right: 10px; accent-color: var(--primary); transform: scale(1.2); }
        .num-grid { display: grid; grid-template-columns: repeat(4, 1fr); gap: 8px; margin-bottom: 20px; }
        .num-chk { display: none; }
        .num-box { background: rgba(255,255,255,0.05); padding: 15px 0; border-radius: 8px; text-align: center; font-weight: bold; cursor: pointer; border: 2px solid transparent; }
        .num-chk:checked + .num-box { background: rgba(0, 255, 170, 0.15); color: var(--primary); border-color: var(--primary); }

        .game-header { display: flex; justify-content: space-between; background: #000; padding: 15px; border-radius: 12px; margin-bottom: 20px; border: 1px solid var(--border); }
        .stat-item { text-align: center; } .stat-label { font-size: 10px; color: var(--text-secondary); display: block; } .stat-val { font-size: 16px; font-weight: bold; color: #fff; }
        .question-area { height: 100px; display: flex; align-items: center; justify-content: center; margin-bottom: 20px; }
        #question-text { font-size: 60px; font-weight: 900; color: #fff; }
        #answer-input { width: 100%; background: #000; border: 2px solid var(--border); color: var(--primary); font-size: 40px; text-align: center; padding: 15px; border-radius: 12px; font-weight: bold; outline: none; }
        
        /* RACER UI */
        #racer-area { position: relative; width: 100%; height: 500px; background: #222; border-radius: 16px; overflow: hidden; border: 4px solid #333; }
        canvas { width: 100%; height: 100%; display: block; }
        .racer-overlay { position: absolute; top: 0; left: 0; width: 100%; padding: 15px; display: flex; justify-content: space-between; font-weight: bold; pointer-events: none; z-index: 5; }
        .racer-score { color: var(--primary); font-size: 18px; text-shadow: 2px 2px 0 #000; }
        .racer-lives { color: var(--danger); font-size: 18px; text-shadow: 2px 2px 0 #000; }
        .racer-question { position: absolute; top: 60px; left: 50%; transform: translateX(-50%); background: rgba(0,0,0,0.8); border: 2px solid var(--primary); padding: 5px 25px; border-radius: 20px; font-size: 28px; font-weight: 900; color: #fff; z-index: 5; white-space: nowrap; }
        
        .mobile-controls { display: none; gap: 20px; margin-top: 15px; width: 100%; }
        .control-btn { flex: 1; padding: 25px; background: rgba(255,255,255,0.1); border: 1px solid var(--border); border-radius: 16px; color: #fff; font-size: 30px; cursor: pointer; touch-action: manipulation; }
        @media (max-width: 900px) { .mobile-controls { display: flex; } }

        .list-container { max-height: 300px; overflow-y: auto; }
        .list-row { display: flex; justify-content: space-between; padding: 10px 0; border-bottom: 1px solid rgba(255,255,255,0.1); font-size: 13px; }
        
        .modal { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.9); z-index: 1000; justify-content: center; align-items: center; }
        .modal-content { background: var(--surface); padding: 30px; border-radius: 20px; width: 90%; max-width: 400px; text-align: center; border: 1px solid var(--border); }
        .modal-btn { padding: 10px 20px; border-radius: 8px; border: none; font-weight: bold; cursor: pointer; margin: 5px; }
        .btn-confirm { background: var(--primary); color: #000; }
        .btn-cancel { background: #333; color: #fff; }

        .hidden { display: none !important; }
        .shake { animation: shake 0.4s cubic-bezier(.36,.07,.19,.97) both; border-color: var(--danger) !important; }
        @keyframes shake { 10%, 90% { transform: translate3d(-2px, 0, 0); } 20%, 80% { transform: translate3d(4px, 0, 0); } 30%, 50%, 70% { transform: translate3d(-6px, 0, 0); } 40%, 60% { transform: translate3d(6px, 0, 0); } }
        
        footer { margin-top: auto; padding: 30px 0; text-align: center; font-size: 12px; color: var(--text-secondary); width: 100%; }
        footer a { color: var(--text-secondary); text-decoration: none; }
    </style>
</head>
<body>

<header>
    <h1>√áARPTRƒ∞K</h1>
    <div class="lang-switch">
        <button class="lang-btn active" id="lang-tr" onclick="setLanguage('tr')">TR</button>
        <button class="lang-btn" id="lang-en" onclick="setLanguage('en')">EN</button>
    </div>
</header>

<div class="mode-tabs">
    <button class="tab-btn active" id="tab-classic" onclick="setMode('classic')">
        <span style="font-size:18px">üìä</span> <span data-i18n="tab_klasik">KLASƒ∞K</span>
    </button>
    <button class="tab-btn" id="tab-racer" onclick="setMode('racer')">
        <span style="font-size:18px">üèéÔ∏è</span> <span data-i18n="tab_yaris">YARI≈û</span>
    </button>
</div>

<div id="view-classic" class="app-container classic-layout">
    <div class="card">
        <div class="card-title" data-i18n="hata_listesi">HATA Lƒ∞STESƒ∞</div>
        <div id="error-list" class="list-container" data-i18n="liste_temiz">Liste temiz.</div>
        <div style="margin-top:20px;">
            <label class="option-row"><input type="radio" name="errorMode" value="weighted" checked><span data-i18n="puan_kadar">Puan Kadar</span></label>
            <label class="option-row"><input type="radio" name="errorMode" value="single"><span data-i18n="bir_kez">1 Kez</span></label>
        </div>
        <button class="btn-primary" style="background:var(--accent); color:#fff;" onclick="startErrorPractice()" data-i18n="hatalara_calis">HATALARA √áALI≈û</button>
        <button class="btn-danger" onclick="resetData()" data-i18n="listeyi_temizle">TEMƒ∞ZLE</button>
    </div>

    <div class="card">
        <div id="classic-setup">
            <div class="card-title" data-i18n="carp_sayilar">SAYI SE√áƒ∞Mƒ∞</div>
            <div class="num-grid">
                <label><input type="checkbox" class="num-chk" value="2" checked><div class="num-box">2</div></label>
                <label><input type="checkbox" class="num-chk" value="3" checked><div class="num-box">3</div></label>
                <label><input type="checkbox" class="num-chk" value="4" checked><div class="num-box">4</div></label>
                <label><input type="checkbox" class="num-chk" value="5" checked><div class="num-box">5</div></label>
                <label><input type="checkbox" class="num-chk" value="6" checked><div class="num-box">6</div></label>
                <label><input type="checkbox" class="num-chk" value="7" checked><div class="num-box">7</div></label>
                <label><input type="checkbox" class="num-chk" value="8" checked><div class="num-box">8</div></label>
                <label><input type="checkbox" class="num-chk" value="9" checked><div class="num-box">9</div></label>
            </div>
            <div style="display:flex; gap:10px; margin-bottom:20px;">
                <button class="lang-btn" onclick="toggleAll(true)" style="flex:1" data-i18n="tumu">T√úM√ú</button>
                <button class="lang-btn" onclick="toggleAll(false)" style="flex:1" data-i18n="temizle">TEMƒ∞ZLE</button>
            </div>
            <div class="card-title" data-i18n="oyun_modu">OYUN MODU</div>
            <label class="option-row"><input type="radio" name="gameMode" value="repeat" checked><span><span data-i18n="mod_tekrar_1">T√ºm√ºn√º</span> <input type="number" id="inp-repeat" value="1" style="width:40px; background:transparent; border:none; color:var(--primary); font-weight:bold;"> <span data-i18n="mod_tekrar_2">kez</span></span></label>
            <label class="option-row"><input type="radio" name="gameMode" value="limit"><span><span data-i18n="mod_limit_1">Rastgele</span> <input type="number" id="inp-limit" value="20" style="width:40px; background:transparent; border:none; color:var(--primary); font-weight:bold;"> <span data-i18n="mod_limit_2">soru</span></span></label>
            <button class="btn-primary" onclick="startClassic()" data-i18n="baslat">BA≈ûLAT</button>
        </div>

        <div id="classic-play" class="hidden">
            <div class="game-header">
                <div class="stat-item"><span class="stat-label" data-i18n="tablo_puan">PUAN</span><span class="stat-val" style="color:var(--primary);" id="disp-score">100</span></div>
                <div class="stat-item"><span class="stat-label" data-i18n="tablo_soru">SORU</span><span class="stat-val"><span id="disp-q">0</span>/<span id="disp-total">0</span></span></div>
                <div class="stat-item"><span class="stat-label" data-i18n="tablo_hiz">HIZ</span><span class="stat-val" id="disp-speed">0.0s</span></div>
            </div>
            <div class="question-area"><div id="question-text">2 x 2</div></div>
            <input type="number" id="answer-input" placeholder="?" inputmode="numeric" autocomplete="off">
            <div id="feedback"></div>
            <div style="display:flex; gap:10px; margin-top:20px;">
                <button class="btn-danger" style="background:#333; color:#fff; border-color:#444;" onclick="pauseGame()" data-i18n="duraklat">DURAKLAT</button>
                <button class="btn-danger" onclick="finishGameConfirm()" data-i18n="bitir">Bƒ∞Tƒ∞R</button>
            </div>
        </div>

        <div id="classic-result" class="hidden" style="text-align:center;">
            <div class="card-title" style="border:none; font-size:24px;" data-i18n="seans_bitti">SEANS Bƒ∞TTƒ∞</div>
            <div style="font-size:60px; font-weight:900; color:var(--primary); margin:20px 0;" id="final-score">100</div>
            <div style="display:grid; grid-template-columns:1fr 1fr; gap:10px; margin-bottom:20px;">
                <div style="background:#222; padding:10px; border-radius:8px;"><div style="font-size:10px; color:#888;" data-i18n="tablo_hiz">HIZ</div><div style="font-size:18px; font-weight:bold;" id="final-speed">0.0s</div></div>
                <div style="background:#222; padding:10px; border-radius:8px;"><div style="font-size:10px; color:#888;" data-i18n="tablo_hata">HATA</div><div style="font-size:18px; font-weight:bold; color:var(--danger);" id="final-errors">0</div></div>
            </div>
            <button class="btn-primary" onclick="backToSetup()" data-i18n="tamam_btn">TAMAM</button>
        </div>
    </div>

    <div class="card">
        <div class="card-title" data-i18n="gecmis_skorlar">GE√áMƒ∞≈û</div>
        <div id="history-list" class="list-container" data-i18n="gecmis_yok">Kayƒ±t yok.</div>
        <button class="btn-danger" onclick="clearHistory()" data-i18n="gecmisi_sil">Sƒ∞L</button>
    </div>
</div>

<div id="view-racer" class="app-container racer-layout hidden">
    <div class="card" style="padding:0; border:none; background:transparent; box-shadow:none; width:100%;">
        <div id="racer-area">
            <canvas id="racerCanvas"></canvas>
            <div class="racer-overlay">
                <span class="racer-score"><span data-i18n="tablo_puan">PUAN</span>: <span id="r-score">0</span></span>
                <span class="racer-lives"><span data-i18n="can">CAN</span>: <span id="r-lives">3</span></span>
            </div>
            <div class="racer-question" id="r-question">---</div>
            
            <div id="racer-menu" style="position:absolute; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.85); display:flex; flex-direction:column; align-items:center; justify-content:center; z-index:10;">
                <h1 style="font-size:32px; margin-bottom:10px;" data-i18n="racer_baslik">YARI≈û MODU</h1>
                <p style="color:#aaa; text-align:center; padding:0 20px; margin-bottom:20px;" data-i18n="racer_aciklama">Doƒüru cevaba √ßarp!</p>
                <button class="btn-primary" style="width:200px;" onclick="startRacer()" data-i18n="baslat">BA≈ûLA</button>
            </div>

            <div id="racer-over" style="position:absolute; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.9); display:none; flex-direction:column; align-items:center; justify-content:center; z-index:11;">
                <h1 style="color:var(--danger);" data-i18n="oyun_bitti">OYUN Bƒ∞TTƒ∞</h1>
                <div style="font-size:40px; font-weight:bold; color:var(--primary); margin-bottom:20px;" id="r-final-score">0</div>
                <button class="btn-primary" style="width:200px;" onclick="startRacer()" data-i18n="tekrar_oyna">TEKRAR</button>
                <button class="btn-danger" style="width:200px; background:transparent;" onclick="exitRacer()" data-i18n="menu">MEN√ú</button>
            </div>
        </div>
        <div class="mobile-controls">
            <button class="control-btn" ontouchstart="moveCar(-1)" onmousedown="moveCar(-1)">‚¨ÖÔ∏è</button>
            <button class="control-btn" ontouchstart="moveCar(1)" onmousedown="moveCar(1)">‚û°Ô∏è</button>
        </div>
    </div>
</div>

<div id="mainModal" class="modal">
    <div class="modal-content">
        <div class="modal-text" id="modalMsg">...</div>
        <div class="modal-actions" id="modalActions"></div>
    </div>
</div>

<footer>
    <div>¬© 2026 √áarptrik.</div>
    <div style="margin-top:5px;"><span data-i18n="iletisim_text">√ñneri:</span> <a href="mailto:carptrik@gmail.com">carptrik@gmail.com</a></div>
</footer>

<script>
/* GLOBAL & UTILS */
const state = {
    mode: 'classic', lang: 'tr',
    db: JSON.parse(localStorage.getItem('carptrik_data')) || {},
    history: JSON.parse(localStorage.getItem('carptrik_history')) || [],
    classic: { activeList: [], total: 0, currentIdx: 0, score: 100, times: [], errors: 0, paused: false, startTime: 0, pauseTime: 0, currentQ: null },
    racer: { active: false, lane: 1, currentX: 0, score: 0, lives: 3, speed: 5, cars: [], particles: [], q: null }
};

const text = {
    tr: {
        alert_sayi_sec: "L√ºtfen sayƒ± se√ßin!", alert_hata_yok: "Listeniz temiz!", confirm_bitir: "Bitirmek istiyor musun?", confirm_sil: "Silmek istiyor musun?",
        dogru: "DOƒûRU!", yanlis: "YANLI≈û!", yavas: "YAVA≈û!", hata_listesi: "HATA Lƒ∞STESƒ∞", liste_temiz: "Temiz.", hata_tekrar: "TEKRAR",
        hatalara_calis: "HATALARA √áALI≈û", listeyi_temizle: "TEMƒ∞ZLE", carp_sayilar: "SAYI SE√áƒ∞Mƒ∞", oyun_modu: "MOD", baslat: "BA≈ûLAT", seans_bitti: "Bƒ∞TTƒ∞",
        gecmis_skorlar: "GE√áMƒ∞≈û", gecmis_yok: "Bo≈ü.", gecmisi_sil: "Sƒ∞L", iletisim_text: "ƒ∞leti≈üim:", tab_klasik: "KLASƒ∞K", tab_yaris: "YARI≈û",
        puan_kadar: "Puan Kadar", bir_kez: "1 Kez", tumu: "T√úM√ú", temizle: "TEMƒ∞ZLE", mod_tekrar_1: "T√ºm√ºn√º", mod_tekrar_2: "kez", mod_limit_1: "Rastgele", mod_limit_2: "soru",
        tablo_puan: "PUAN", tablo_soru: "SORU", tablo_hiz: "HIZ", tablo_hata: "HATA", duraklat: "DURAKLAT", bitir: "Bƒ∞Tƒ∞R", tamam_btn: "TAMAM",
        modal_tamam: "TAMAM", modal_evet: "EVET", modal_iptal: "ƒ∞PTAL", racer_baslik: "YARI≈û MODU", racer_aciklama: "Doƒüru cevaba √ßarp!", can: "CAN", oyun_bitti: "Bƒ∞TTƒ∞", tekrar_oyna: "TEKRAR", menu: "MEN√ú"
    },
    en: {
        alert_sayi_sec: "Select numbers!", alert_hata_yok: "List clean!", confirm_bitir: "Finish game?", confirm_sil: "Delete all?",
        dogru: "CORRECT!", yanlis: "WRONG!", yavas: "SLOW!", hata_listesi: "ERRORS", liste_temiz: "Clean.", hata_tekrar: "REPEAT",
        hatalara_calis: "PRACTICE", listeyi_temizle: "CLEAR", carp_sayilar: "NUMBERS", oyun_modu: "MODE", baslat: "START", seans_bitti: "DONE",
        gecmis_skorlar: "HISTORY", gecmis_yok: "Empty.", gecmisi_sil: "CLEAR", iletisim_text: "Contact:", tab_klasik: "CLASSIC", tab_yaris: "RACER",
        puan_kadar: "By Score", bir_kez: "Once", tumu: "ALL", temizle: "CLEAR", mod_tekrar_1: "All", mod_tekrar_2: "times", mod_limit_1: "Random", mod_limit_2: "qs",
        tablo_puan: "SCORE", tablo_soru: "Q", tablo_hiz: "SPD", tablo_hata: "ERR", duraklat: "PAUSE", bitir: "END", tamam_btn: "OK",
        modal_tamam: "OK", modal_evet: "YES", modal_iptal: "CANCEL", racer_baslik: "RACER MODE", racer_aciklama: "Hit correct answer!", can: "HP", oyun_bitti: "GAME OVER", tekrar_oyna: "REPLAY", menu: "MENU"
    }
};

function init() {
    const s = localStorage.getItem('carptrik_lang');
    if (s) state.lang = s;
    setLanguage(state.lang);
    updateLists();
}

function setLanguage(l) {
    state.lang = l;
    localStorage.setItem('carptrik_lang', l);
    document.querySelectorAll('.lang-btn').forEach(b => b.classList.remove('active'));
    document.getElementById('lang-'+l).classList.add('active');
    
    document.querySelectorAll('[data-i18n]').forEach(el => {
        const k = el.getAttribute('data-i18n');
        if(text[l][k]) el.innerText = text[l][k];
    });
    updateLists(); // Re-render lists for translations
}

function setMode(m) {
    state.mode = m;
    document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
    document.getElementById('tab-'+m).classList.add('active');
    document.getElementById('view-classic').classList.add('hidden');
    document.getElementById('view-racer').classList.add('hidden');
    document.getElementById('view-'+m).classList.remove('hidden');
    if(m === 'racer') setTimeout(initRacerCanvas, 50);
    else state.racer.active = false;
}

function modal(msg, onYes) {
    const m = document.getElementById('mainModal');
    document.getElementById('modalMsg').innerText = msg;
    const acts = document.getElementById('modalActions');
    if(onYes) {
        acts.innerHTML = `<button class="modal-btn btn-confirm" onclick="runYes()">${text[state.lang].modal_evet}</button><button class="modal-btn btn-cancel" onclick="closeModal()">${text[state.lang].modal_iptal}</button>`;
        window.runYes = () => { onYes(); closeModal(); };
    } else {
        acts.innerHTML = `<button class="modal-btn btn-confirm" onclick="closeModal()">${text[state.lang].modal_tamam}</button>`;
    }
    m.style.display = 'flex';
}
function closeModal() { document.getElementById('mainModal').style.display = 'none'; }

/* CLASSIC MODE */
const inputEl = document.getElementById('answer-input');
function toggleAll(val) { document.querySelectorAll('.num-chk').forEach(c => c.checked = val); }
function getNums() { return Array.from(document.querySelectorAll('.num-chk:checked')).map(c => parseInt(c.value)); }

function startClassic() {
    const nums = getNums();
    if(nums.length === 0) return modal(text[state.lang].alert_sayi_sec);
    state.classic.activeList = [];
    const mode = document.querySelector('input[name="gameMode"]:checked').value;
    let pool = [];
    nums.forEach(n1 => { nums.forEach(n2 => pool.push({n1, n2})); });
    
    if(mode === 'repeat') {
        const cnt = parseInt(document.getElementById('inp-repeat').value) || 1;
        for(let i=0; i<cnt; i++) state.classic.activeList.push(...pool);
    } else {
        const lim = parseInt(document.getElementById('inp-limit').value) || 20;
        for(let i=0; i<lim; i++) state.classic.activeList.push(pool[Math.floor(Math.random()*pool.length)]);
    }
    state.classic.activeList.sort(()=>Math.random()-0.5);
    state.classic.total = state.classic.activeList.length;
    state.classic.currentIdx = 0; state.classic.score = 100; state.classic.times = []; state.classic.errors = 0;
    
    document.getElementById('classic-setup').classList.add('hidden');
    document.getElementById('classic-result').classList.add('hidden');
    document.getElementById('classic-play').classList.remove('hidden');
    nextQ();
}

function nextQ() {
    if(state.classic.currentIdx >= state.classic.total) return finishClassic();
    const q = state.classic.activeList[state.classic.currentIdx];
    state.classic.currentQ = q;
    document.getElementById('question-text').innerText = `${q.n1} x ${q.n2}`;
    document.getElementById('disp-q').innerText = state.classic.currentIdx + 1;
    document.getElementById('disp-total').innerText = state.classic.total;
    document.getElementById('disp-score').innerText = state.classic.score;
    document.getElementById('feedback').innerText = "";
    inputEl.value = ''; inputEl.disabled = false; inputEl.focus();
    state.classic.startTime = Date.now();
}

inputEl.addEventListener('input', () => {
    const ans = state.classic.currentQ.n1 * state.classic.currentQ.n2;
    if(inputEl.value.length >= ans.toString().length) {
        const val = parseInt(inputEl.value);
        const time = (Date.now() - state.classic.startTime) / 1000;
        const k = `${state.classic.currentQ.n1}x${state.classic.currentQ.n2}`;
        if(!state.db[k]) state.db[k] = {score: 0};
        
        if(val === ans) {
            state.classic.times.push(time);
            document.getElementById('feedback').innerText = text[state.lang].dogru;
            document.getElementById('feedback').style.color = 'var(--primary)';
            if(state.db[k].score > 0) state.db[k].score--;
            state.classic.currentIdx++;
            setTimeout(nextQ, 500);
        } else {
            document.getElementById('feedback').innerText = text[state.lang].yanlis;
            document.getElementById('feedback').style.color = 'var(--danger)';
            state.db[k].score += 2;
            state.classic.score = Math.max(0, state.classic.score - 5);
            state.classic.errors++;
            setTimeout(nextQ, 1000);
        }
        if(state.db[k].score <= 0) delete state.db[k];
        saveDB();
    }
});

function finishGameConfirm() { modal(text[state.lang].confirm_bitir, finishClassic); }
function finishClassic() {
    if(state.classic.total > 0 && state.classic.currentIdx < state.classic.total) {
        state.classic.score = Math.round(state.classic.score * (state.classic.currentIdx / state.classic.total));
    }
    const avg = state.classic.times.length ? (state.classic.times.reduce((a,b)=>a+b,0)/state.classic.times.length).toFixed(2) : "0.0";
    state.history.unshift({score:state.classic.score, speed:avg, errors:state.classic.errors, q:state.classic.currentIdx});
    if(state.history.length > 20) state.history.pop();
    localStorage.setItem('carptrik_history', JSON.stringify(state.history));
    updateLists();
    document.getElementById('classic-play').classList.add('hidden');
    document.getElementById('classic-result').classList.remove('hidden');
    document.getElementById('final-score').innerText = state.classic.score;
    document.getElementById('final-speed').innerText = avg+'s';
    document.getElementById('final-errors').innerText = state.classic.errors;
}
function backToSetup() { document.getElementById('classic-result').classList.add('hidden'); document.getElementById('classic-setup').classList.remove('hidden'); }
function startErrorPractice() {
    const keys = Object.keys(state.db);
    if(keys.length === 0) return modal(text[state.lang].alert_hata_yok);
    state.classic.activeList = [];
    const mode = document.querySelector('input[name="errorMode"]:checked').value;
    keys.forEach(k => {
        const [n1, n2] = k.split('x').map(Number);
        const c = mode === 'single' ? 1 : state.db[k].score;
        for(let i=0; i<c; i++) state.classic.activeList.push({n1,n2});
    });
    state.classic.activeList.sort(()=>Math.random()-0.5);
    state.classic.total = state.classic.activeList.length; state.classic.currentIdx=0; state.classic.score=100; state.classic.times=[]; state.classic.errors=0;
    document.getElementById('classic-setup').classList.add('hidden');
    document.getElementById('classic-play').classList.remove('hidden');
    nextQ();
}
function pauseGame() {
    state.classic.paused = true; document.getElementById('question-text').classList.add('blur'); inputEl.disabled=true;
    state.classic.pauseTime = Date.now();
    modal(text[state.lang].duraklat, () => {
        state.classic.paused = false; document.getElementById('question-text').classList.remove('blur'); inputEl.disabled=false; inputEl.focus();
        state.classic.startTime += (Date.now() - state.classic.pauseTime);
    });
}

/* RACER MODE */
const cvs = document.getElementById('racerCanvas');
const ctx = cvs.getContext('2d');
let racerReq;

function initRacerCanvas() {
    const box = document.getElementById('racer-area');
    cvs.width = box.offsetWidth; cvs.height = box.offsetHeight;
}

function startRacer() {
    const nums = getNums();
    if(nums.length===0) return modal(text[state.lang].alert_sayi_sec);
    document.getElementById('racer-menu').style.display='none';
    document.getElementById('racer-over').style.display='none';
    
    state.racer.active = true;
    state.racer.score = 0;
    state.racer.lives = 3;
    state.racer.speed = 4;
    state.racer.cars = [];
    state.racer.particles = [];
    state.racer.lane = 1;
    // X pozisyonunu ba≈ülat (yumu≈üak ge√ßi≈ü i√ßin)
    state.racer.currentX = (1 * (cvs.width/4)) + (cvs.width/8); 
    
    updRacerStats();
    spawnRacerQ();
    racerReq = requestAnimationFrame(racerLoop);
}

function spawnRacerQ() {
    const nums = getNums();
    const n1 = nums[Math.floor(Math.random()*nums.length)];
    const n2 = Math.floor(Math.random()*9)+2;
    const ans = n1*n2;
    state.racer.q = {ans:ans};
    document.getElementById('r-question').innerText = `${n1} x ${n2}`;
    
    let opts = [ans];
    while(opts.length<4) {
        let f = ans + (Math.floor(Math.random()*10)-5);
        if(f>0 && f!==ans && !opts.includes(f)) opts.push(f);
    }
    opts.sort(()=>Math.random()-0.5);
    
    for(let i=0; i<4; i++) {
        state.racer.cars.push({
            lane: i, y: -200, val: opts[i],
            isCorrect: opts[i] === ans,
            color: opts[i] === ans ? '#ffaa00' : ['#ff4757','#2ed573','#1e90ff'][Math.floor(Math.random()*3)]
        });
    }
}

function racerLoop() {
    if(!state.racer.active) return;
    ctx.clearRect(0,0,cvs.width,cvs.height);
    const lw = cvs.width/4;
    
    // Yolu √áiz
    ctx.fillStyle = "#222"; ctx.fillRect(0,0,cvs.width,cvs.height);
    ctx.strokeStyle = "#444"; ctx.setLineDash([20,20]); ctx.lineWidth=2;
    for(let i=1; i<4; i++) { ctx.beginPath(); ctx.moveTo(i*lw,0); ctx.lineTo(i*lw,cvs.height); ctx.stroke(); }
    
    // Player Update (Lerp)
    const targetX = (state.racer.lane * lw) + (lw/2);
    state.racer.currentX += (targetX - state.racer.currentX) * 0.15; // Yumu≈üak ge√ßi≈ü katsayƒ±sƒ±
    const pX = state.racer.currentX;
    const pY = cvs.height - 100;
    
    // Player Draw
    ctx.fillStyle = "#00ffaa"; ctx.fillRect(pX-20, pY, 40, 70);
    ctx.fillStyle = "#000"; ctx.fillRect(pX-15, pY+10, 30, 15);
    ctx.fillStyle = "rgba(0,255,170,0.5)"; ctx.beginPath(); ctx.moveTo(pX-15,pY); ctx.lineTo(pX-30,pY-100); ctx.lineTo(pX+30,pY-100); ctx.lineTo(pX+15,pY); ctx.fill();
    
    // Arabalar
    for(let i=state.racer.cars.length-1; i>=0; i--) {
        let c = state.racer.cars[i];
        c.y += state.racer.speed;
        const cX = (c.lane * lw) + (lw/2);
        
        ctx.fillStyle = c.color; ctx.fillRect(cX-20, c.y, 40, 70);
        ctx.fillStyle = "#fff"; ctx.font="bold 20px Arial"; ctx.textAlign="center"; ctx.fillText(c.val, cX, c.y+45);
        
        // √áarpƒ±≈üma: Basit AABB yerine merkez noktasƒ± kontrol√º
        // Oyuncunun merkezi pX, pY+35. D√º≈ümanƒ±n merkezi cX, c.y+35
        // ≈ûerit kontrol√º + Y ekseni √ßakƒ±≈ümasƒ±
        if(c.y + 70 > pY && c.y < pY + 70) {
            // ≈ûerit √ßakƒ±≈üƒ±yor mu? (Hassas kontrol i√ßin ≈üerit indeksi yeterli)
            // Ancak yumu≈üak ge√ßi≈üte g√∂rsel olarak √ßarpma hissi i√ßin mesafe bakƒ±yoruz
            if(Math.abs(pX - cX) < 30) {
                if(c.isCorrect) {
                    state.racer.score += 10; state.racer.speed += 0.2;
                    createExplosion(cX, c.y);
                    state.racer.cars = []; // Hepsini temizle, yeni soru gelecek
                    setTimeout(spawnRacerQ, 200);
                } else {
                    state.racer.lives--;
                    shakeScreen();
                    state.racer.cars.splice(i, 1); // Sadece bunu sil, oyun devam etsin
                    if(state.racer.lives <= 0) { gameOverRacer(); return; }
                }
                updRacerStats();
            }
        }
        else if(c.y > cvs.height) {
            state.racer.cars.splice(i, 1);
            if(c.isCorrect && state.racer.cars.length===0) spawnRacerQ(); // Doƒüru ka√ßarsa yenisini sor
        }
    }
    
    // Par√ßacƒ±klar
    for(let i=state.racer.particles.length-1; i>=0; i--) {
        let p = state.racer.particles[i];
        p.x += p.vx; p.y += p.vy; p.life--;
        ctx.fillStyle = p.color; ctx.fillRect(p.x, p.y, p.size, p.size);
        if(p.life<=0) state.racer.particles.splice(i,1);
    }
    
    if(state.racer.active) requestAnimationFrame(racerLoop);
}

function moveCar(d) {
    let n = state.racer.lane + d;
    if(n>=0 && n<=3) state.racer.lane = n;
}
window.addEventListener('keydown', e => {
    if(!state.racer.active) return;
    if(e.key==='a'||e.key==='ArrowLeft') moveCar(-1);
    if(e.key==='d'||e.key==='ArrowRight') moveCar(1);
});

function createExplosion(x,y) {
    for(let i=0;i<15;i++) state.racer.particles.push({x:x,y:y,vx:(Math.random()-0.5)*10,vy:(Math.random()-0.5)*10,life:30,size:Math.random()*5+2,color:'#fff'});
}
function shakeScreen() {
    const el = document.getElementById('racer-area');
    el.classList.remove('shake'); void el.offsetWidth; el.classList.add('shake');
}
function updRacerStats() {
    document.getElementById('r-score').innerText = state.racer.score;
    document.getElementById('r-lives').innerText = state.racer.lives;
}
function gameOverRacer() {
    state.racer.active = false;
    document.getElementById('r-final-score').innerText = state.racer.score;
    document.getElementById('racer-over').style.display='flex';
}
function exitRacer() {
    document.getElementById('racer-menu').style.display='flex';
    document.getElementById('racer-over').style.display='none';
}

/* DATA */
function saveDB() { localStorage.setItem('carptrik_data', JSON.stringify(state.db)); updateLists(); }
function resetData() { modal(text[state.lang].confirm_sil, () => { state.db = {}; saveDB(); }); }
function clearHistory() { modal(text[state.lang].confirm_sil, () => { state.history = []; localStorage.setItem('carptrik_history', JSON.stringify([])); updateLists(); }); }

function updateLists() {
    // Errors
    const el = document.getElementById('error-list');
    if(Object.keys(state.db).length===0) el.innerHTML=`<div style="text-align:center;color:#555;padding:10px;">${text[state.lang].liste_temiz}</div>`;
    else {
        let h = "";
        Object.keys(state.db).sort((a,b)=>state.db[b].score-state.db[a].score).forEach(k=>{
            h+=`<div class="list-row"><span>${k}</span><b>+${state.db[k].score}</b></div>`;
        });
        el.innerHTML=h;
    }
    // History
    const hl = document.getElementById('history-list');
    if(state.history.length===0) hl.innerHTML=`<div style="text-align:center;color:#555;padding:10px;">${text[state.lang].gecmis_yok}</div>`;
    else {
        let h="";
        state.history.forEach(i=>{
            h+=`<div class="list-row"><b style="flex:1;text-align:center;">${i.score}</b><span style="flex:1;text-align:center;">${i.speed}s</span><span style="flex:1;text-align:center;color:${i.errors>0?'var(--danger)':'#666'}">${i.errors}</span><span style="flex:1;text-align:center;color:#666">${i.q}</span></div>`;
        });
        hl.innerHTML=h;
    }
}

init();
</script>
</body>
</html>
