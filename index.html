<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    
    <meta name="google-site-verification" content="DbvwD_t2D1ABQ64NDUNPVEbSpcshzLXZ9KIzWLaIF7E" />
    
    <title>√áARPTRƒ∞K - √áarpƒ±m Tablosu Oyunu & Araba Yarƒ±≈üƒ±</title>
    
    <style>
        :root {
            --bg-body: #0f172a;
            --bg-panel: #1e293b;
            --bg-card: #334155;
            --bg-dark: #020617;
            --primary: #10b981;
            --primary-glow: rgba(16, 185, 129, 0.4);
            --accent: #8b5cf6;
            --danger: #ef4444;
            --warning: #f59e0b;
            --text-main: #f1f5f9;
            --text-muted: #94a3b8;
            --border: #334155;
            --radius: 14px;
        }

        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; user-select: none; }
        
        body {
            font-family: 'Inter', system-ui, sans-serif;
            background-color: var(--bg-body);
            color: var(--text-main);
            margin: 0; padding: 0;
            width: 100vw;
            height: 100dvh;
            display: flex; flex-direction: column;
            overflow: hidden;
            padding-top: env(safe-area-inset-top);
            padding-bottom: env(safe-area-inset-bottom);
            padding-left: env(safe-area-inset-left);
            padding-right: env(safe-area-inset-right);
        }

        /* SCROLLBAR Gƒ∞ZLEME (PC ƒ∞√áƒ∞N) */
        .setup-container::-webkit-scrollbar, 
        .list-content::-webkit-scrollbar,
        .dashboard::-webkit-scrollbar {
            display: none;
        }
        .setup-container, .list-content, .dashboard {
            -ms-overflow-style: none;  /* IE and Edge */
            scrollbar-width: none;  /* Firefox */
        }

        /* --- HEADER --- */
        header {
            height: auto; min-height: 70px; flex-shrink: 0;
            background: rgba(30, 41, 59, 0.95); border-bottom: 1px solid var(--border);
            display: grid; grid-template-columns: 1fr auto 1fr; align-items: center;
            padding: 10px 25px; backdrop-filter: blur(10px); z-index: 50;
        }
        .header-left { justify-self: start; }
        .logo { font-size: 22px; font-weight: 900; letter-spacing: 1px; color: var(--primary); display: flex; align-items: center; gap: 8px; text-transform: uppercase; }
        
        .header-center { justify-self: center; }
        .mode-switch { 
            display: flex; background: var(--bg-body); padding: 5px; border-radius: 12px; border: 1px solid var(--border); transform: scale(1.1);
        }
        .m-btn {
            padding: 10px 25px; border: none; background: transparent; color: var(--text-muted);
            border-radius: 8px; font-weight: 800; font-size: 14px; cursor: pointer; transition: 0.2s;
            display: flex; align-items: center; gap: 8px;
        }
        .m-btn.active { background: var(--bg-card); color: #fff; box-shadow: 0 2px 8px rgba(0,0,0,0.2); }
        .m-btn:hover:not(.active) { color: #fff; }

        .header-right { justify-self: end; display: flex; align-items: center; gap: 15px; }
        
        .sound-btn {
            background: transparent; border: 1px solid var(--border); color: var(--text-muted);
            padding: 5px 10px; border-radius: 8px; font-size: 16px; cursor: pointer;
            display: flex; align-items: center; justify-content: center;
        }
        .sound-btn.active { color: var(--primary); border-color: var(--primary); background: rgba(16,185,129,0.1); }

        .lang-switch { display: flex; gap: 5px; }
        .lang-btn { background: transparent; border: 1px solid var(--border); color: var(--text-muted); padding: 5px 12px; border-radius: 8px; font-size: 11px; font-weight: bold; cursor: pointer; }
        .lang-btn.active { border-color: var(--primary); color: var(--primary); background: rgba(16, 185, 129, 0.1); }

        /* --- DASHBOARD --- */
        .dashboard {
            display: grid; grid-template-columns: 280px 1fr 280px;
            gap: 25px; padding: 25px;
            flex: 1; 
            max-width: 1600px; margin: 0 auto; width: 100%;
            overflow: hidden; 
        }

        .panel {
            background: var(--bg-panel); border-radius: var(--radius); border: 1px solid var(--border);
            display: flex; flex-direction: column; overflow: hidden; box-shadow: 0 10px 30px rgba(0,0,0,0.2);
            position: relative;
        }

        /* --- SIDEBAR COMPONENTS --- */
        .panel-head {
            padding: 15px 20px; background: rgba(0,0,0,0.15); border-bottom: 1px solid var(--border);
            font-size: 12px; font-weight: 800; color: var(--text-muted); text-transform: uppercase; letter-spacing: 1px;
            display: flex; justify-content: space-between; align-items: center; flex-shrink: 0;
        }
        
        .practice-area { padding: 20px; border-bottom: 1px solid var(--border); background: rgba(139, 92, 246, 0.05); }
        .pill-group { display: flex; background: var(--bg-body); padding: 4px; border-radius: 10px; border: 1px solid var(--border); margin-bottom: 15px; }
        .pill { flex: 1; text-align: center; padding: 10px; cursor: pointer; border-radius: 8px; font-size: 13px; font-weight: bold; color: var(--text-muted); transition: 0.2s; }
        .pill:hover { color: #fff; }
        .pill.selected { background: var(--accent); color: #fff; }
        .pill input { display: none; }

        .btn-purple { width: 100%; padding: 14px; background: var(--accent); color: #fff; border: none; border-radius: 10px; font-weight: 800; cursor: pointer; display: flex; justify-content: center; gap: 8px; transition: 0.2s; font-size: 13px; box-shadow: 0 4px 15px rgba(139, 92, 246, 0.2); }
        .btn-purple:hover { transform: translateY(-2px); }

        .list-content { flex: 1; overflow-y: auto; padding: 0; }
        .err-row { display: flex; justify-content: space-between; padding: 12px 20px; border-bottom: 1px solid rgba(255,255,255,0.05); font-size: 13px; color: var(--text-muted); }
        
        .grid-header, .grid-row { display: grid; grid-template-columns: 1fr 1fr 1fr 1fr; padding: 10px 15px; font-size: 11px; text-align: center; align-items: center; }
        .grid-header { background: rgba(255,255,255,0.03); color: var(--text-muted); font-weight: 800; border-bottom: 1px solid var(--border); }
        .grid-row { border-bottom: 1px solid rgba(255,255,255,0.05); font-size: 13px; color: var(--text-muted); }
        .grid-row b { color: #fff; }

        .graph-area { height: 120px; padding: 0 15px; border-bottom: 1px solid var(--border); background: rgba(0,0,0,0.1); display: flex; align-items: center; justify-content: center; }
        svg { width: 100%; height: 100%; overflow: visible; }
        .chart-line { fill: none; stroke: var(--primary); stroke-width: 2px; stroke-linecap: round; }
        .chart-dot { fill: var(--bg-panel); stroke: #fff; stroke-width: 2px; r: 3; }

        .mini-btn { background: none; border: none; color: var(--danger); font-size: 10px; font-weight: bold; cursor: pointer; }
        .mini-btn:hover { text-decoration: underline; }

        /* --- CENTER PANEL --- */
        .setup-container { padding: 30px 40px; overflow-y: auto; height: 100%; display: flex; flex-direction: column; gap: 30px; }
        
        .section-header { 
            font-size: 16px; font-weight: 800; color: #fff; text-transform: uppercase; text-align: center; letter-spacing: 1px; margin-bottom: 10px;
        }

        /* Number Grid */
        .num-grid { display: grid; grid-template-columns: repeat(8, 1fr); gap: 12px; margin-bottom: 15px; }
        .num-chk { display: none; }
        .num-label {
            display: flex; align-items: center; justify-content: center; height: 50px;
            background: var(--bg-card); border-radius: 10px; font-weight: bold; font-size: 18px; cursor: pointer;
            border: 2px solid transparent; color: var(--text-muted); transition: 0.2s;
        }
        .num-chk:checked + .num-label { background: var(--primary); color: #000; border-color: #fff; box-shadow: 0 0 15px rgba(16,185,129,0.3); }
        
        .grid-actions { display: flex; justify-content: center; gap: 10px; }
        .action-btn { padding: 8px 20px; background: transparent; border: 1px solid var(--border); color: var(--text-muted); border-radius: 8px; font-size: 11px; font-weight: bold; cursor: pointer; }
        .action-btn:hover { color: #fff; border-color: #fff; }

        /* SETTINGS BOXES */
        .settings-box { 
            background: rgba(0,0,0,0.2); border: 1px solid var(--border); border-radius: 16px; padding: 25px; 
            display: flex; flex-direction: column; gap: 15px;
        }
        .sb-title { font-size: 14px; font-weight: 800; color: var(--text-muted); text-transform: uppercase; text-align: center; margin-bottom: 5px; letter-spacing: 1px; }
        
        .toggle-group { 
            display: flex; background: var(--bg-dark); padding: 5px; border-radius: 12px; border: 1px solid var(--border);
            min-height: 75px; 
        }
        
        .toggle-opt { 
            flex: 1; text-align: center; padding: 0 15px; cursor: pointer; border-radius: 8px; 
            font-size: 13px; font-weight: 700; color: var(--text-muted); transition: 0.2s; 
            display: flex; align-items: center; justify-content: center; gap: 12px;
        }
        .toggle-opt:hover { color: #fff; background: rgba(255,255,255,0.03); }
        .toggle-opt.selected { background: var(--bg-card); color: #fff; box-shadow: 0 4px 10px rgba(0,0,0,0.3); border: 1px solid rgba(255,255,255,0.1); }
        .toggle-opt input[type="radio"] { display: none; }
        
        .input-box {
            width: 70px; height: 40px; 
            background: #000; border: 2px solid var(--border); border-radius: 8px;
            color: var(--primary); font-weight: 800; text-align: center; font-size: 18px; 
            outline: none; transition: 0.2s; flex-shrink: 0;
        }
        .input-box:focus { border-color: var(--primary); box-shadow: 0 0 15px rgba(16, 185, 129, 0.2); }
        
        input[type=number]::-webkit-inner-spin-button, input[type=number]::-webkit-outer-spin-button { -webkit-appearance: none; margin: 0; }
        input[type=number] { -moz-appearance: textfield; }

        .total-info { font-size: 12px; color: var(--primary); margin-left: 5px; font-weight: 600; opacity: 0.9; }

        .btn-start {
            width: 100%; padding: 22px; border-radius: 14px; border: none; margin-top: auto;
            font-size: 20px; font-weight: 900; cursor: pointer; transition: 0.2s;
            display: flex; align-items: center; justify-content: center; gap: 10px; text-transform: uppercase;
            box-shadow: 0 5px 20px rgba(0,0,0,0.3);
        }
        .btn-start.classic { background: var(--primary); color: #000; box-shadow: 0 10px 40px var(--primary-glow); }
        .btn-start.racer { background: #f59e0b; color: #000; box-shadow: 0 10px 40px rgba(245, 158, 11, 0.3); }
        .btn-start:hover { transform: translateY(-3px); }

        .screen { display: none; height: 100%; flex-direction: column; }
        .screen.active { display: flex; animation: fade 0.3s ease; }
        @keyframes fade { from{opacity:0;transform:translateY(10px)}to{opacity:1;transform:translateY(0)} }

        /* Effects */
        @keyframes shakeAnim {
            0% { transform: translate(1px, 1px) rotate(0deg); } 20% { transform: translate(-3px, 0px) rotate(1deg); }
            40% { transform: translate(1px, -1px) rotate(1deg); } 60% { transform: translate(-3px, 1px) rotate(0deg); }
            80% { transform: translate(-1px, -1px) rotate(1deg); } 100% { transform: translate(1px, -2px) rotate(-1deg); }
        }
        .shake { animation: shakeAnim 0.5s; }
        .damage-flash { position:fixed; top:0; left:0; width:100%; height:100%; pointer-events:none; box-shadow: inset 0 0 80px var(--danger); border: 4px solid var(--danger); z-index:9999; opacity:0.8; animation: fadeOut 0.5s forwards; }
        @keyframes fadeOut { from{opacity:0.8} to{opacity:0} }

        .hud { display: flex; justify-content: space-between; padding: 20px 30px; background: rgba(0,0,0,0.2); border-radius: 16px; margin: 20px; border: 1px solid var(--border); }
        .hud-val { font-size: 26px; font-weight: 900; color: #fff; text-align: center; }
        .hud-lbl { font-size: 11px; color: var(--text-muted); text-align: center; display: block; margin-bottom: 2px; }

        .q-area { flex: 1; display: flex; flex-direction: column; align-items: center; justify-content: center; }
        .q-text { font-size: 120px; font-weight: 900; color: #fff; margin-bottom: 30px; text-shadow: 0 0 50px rgba(255,255,255,0.05); }
        .ans-inp { width: 100%; max-width: 400px; background: #000; border: 3px solid var(--border); color: var(--primary); font-size: 60px; padding: 20px; text-align: center; border-radius: 20px; outline: none; font-family: monospace; font-weight: bold; transition: 0.2s; }
        .ans-inp:focus { border-color: var(--primary); box-shadow: 0 0 30px var(--primary-glow); }
        .ans-inp[readonly] { caret-color: transparent; }

        .feedback { 
            min-height: 80px; margin-top: 20px; font-weight: 900; font-size: 40px; 
            text-align: center; line-height: 1.2; display: flex; flex-direction: column; justify-content: center;
        }

        #racer-wrap { flex: 1; margin: 20px; background: #111; border-radius: 16px; position: relative; overflow: hidden; border: 2px solid var(--border); }
        canvas { width: 100%; height: 100%; display: block; }
        
        .progress-strip {
            position: absolute; left: 15px; top: 70px; bottom: 40px; width: 4px;
            background: rgba(255,255,255,0.2); border-radius: 2px; z-index: 50;
            display: flex; flex-direction: column; justify-content: space-between; align-items: center;
        }
        .prog-flag { position: absolute; left: -6px; font-size: 16px; line-height: 1; }
        .pf-start { bottom: -20px; } .pf-end { top: -20px; }
        
        .prog-car {
            position: absolute; left: -8px; bottom: 0%; font-size: 20px; line-height: 1;
            transition: bottom 0.5s cubic-bezier(0.175, 0.885, 0.32, 1.275);
            text-shadow: 0 0 5px rgba(0,0,0,0.5);
        }

        .r-header {
            position: absolute; top: 15px; left: 15px; right: 15px;
            display: flex; justify-content: space-between; align-items: center;
            z-index: 20; pointer-events: none;
        }
        .r-stat {
            font-weight: 900; font-size: 22px; text-shadow: 2px 2px 0 #000; color: #fff;
            background: rgba(0,0,0,0.5); padding: 5px 15px; border-radius: 12px;
        }
        .r-q-box {
            background: rgba(15, 23, 42, 0.9); border: 2px solid var(--primary); color: #fff;
            padding: 8px 25px; border-radius: 25px; font-size: 28px; font-weight: 900;
            box-shadow: 0 5px 20px rgba(0,0,0,0.6); letter-spacing: 2px;
        }

        .mob-ctrl { display: none; gap: 15px; padding: 0 25px 25px 25px; height: 100px; }
        .c-btn { flex: 1; background: var(--bg-card); border: 1px solid var(--border); border-radius: 12px; font-size: 30px; color: #fff; cursor: pointer; }

        .res-box { flex: 1; display: flex; flex-direction: column; align-items: center; justify-content: center; }
        .res-score { font-size: 100px; font-weight: 900; color: var(--primary); margin: 10px 0; }
        .res-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin-bottom: 40px; }
        .res-item { background: var(--bg-card); padding: 20px 40px; border-radius: 16px; text-align: center; border: 1px solid var(--border); }

        .foot-btns { display: flex; gap: 15px; padding: 25px; }
        .f-btn { flex: 1; padding: 15px; background: var(--bg-card); border: 1px solid var(--border); color: #fff; border-radius: 10px; cursor: pointer; font-weight: 800; font-size: 13px; }
        .f-btn:hover { background: var(--bg-panel); }
        .f-btn.danger { border-color: var(--danger); color: var(--danger); background: rgba(239,68,68,0.05); }

        #pause-overlay {
            display: none; position: fixed; top:0; left:0; width:100%; height:100%;
            background: rgba(15, 23, 42, 0.95); z-index: 2000;
            justify-content: center; align-items: center; flex-direction: column; gap: 20px;
        }
        .paused-text { font-size: 40px; font-weight: 900; color: #fff; text-shadow: 0 0 20px rgba(0,0,0,0.5); letter-spacing: 2px; }
        .pause-menu { display: flex; flex-direction: column; gap: 15px; width: 250px; }
        .btn-resume { padding: 15px 30px; background: var(--primary); color: #000; border: none; border-radius: 12px; font-size: 18px; font-weight: 900; cursor: pointer; box-shadow: 0 0 30px var(--primary-glow); transition: 0.2s; width: 100%; }
        .btn-quit { padding: 15px 30px; background: transparent; border: 2px solid var(--danger); color: var(--danger); border-radius: 12px; font-size: 18px; font-weight: 900; cursor: pointer; transition: 0.2s; width: 100%; }

        .modal-wrap { display: none; position: fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.85); z-index: 3000; justify-content: center; align-items: center; backdrop-filter: blur(5px); }
        .modal { background: var(--bg-panel); padding: 40px; border-radius: 20px; width: 90%; max-width: 400px; text-align: center; border: 1px solid var(--border); box-shadow: 0 20px 60px rgba(0,0,0,0.6); }
        .m-btns { margin-top: 30px; display: flex; gap: 15px; justify-content: center; }
        .mb { padding: 12px 30px; border-radius: 10px; border: none; font-weight: 800; cursor: pointer; font-size: 14px; }
        .mb-ok { background: var(--primary); color: #000; }
        .mb-no { background: var(--bg-card); color: #fff; border: 1px solid var(--border); }

        footer { margin-top: auto; padding: 15px; text-align: center; font-size: 11px; color: var(--text-muted); background: var(--bg-body); border-top: 1px solid var(--border); transition: transform 0.3s ease; }
        footer a { color: var(--text-muted); text-decoration: none; }

        .mobile-keypad { display: none; }
        .mobile-stats-btn { display: none; }
        .mobile-stats-back { display: none; }

        /* --- MOBILE STYLES --- */
        @media (max-width: 900px) {
            body { 
                padding: 0; padding-top: env(safe-area-inset-top); padding-bottom: env(safe-area-inset-bottom); height: 100dvh; 
            }
            
            header { display: flex; flex-wrap: wrap; justify-content: space-between; align-items: center; height: auto; padding: 10px 15px; }
            .header-left { order: 1; flex: 0 0 auto; }
            .header-right { order: 2; flex: 0 0 auto; gap: 8px; }
            .header-center { order: 3; width: 100%; margin-top: 10px; display: flex; justify-content: center; }
            
            .mode-switch { transform: scale(1); width: 100%; } 
            .m-btn { flex: 1; justify-content: center; }
            
            .dashboard { display: flex; flex-direction: column; height: auto; padding: 10px; gap: 10px; overflow-y: auto; }
            
            /* D√úZELTME: Yan Panelleri Ba≈ülangƒ±√ßta KESƒ∞N Gƒ∞ZLE */
            #panel-errors, #panel-history { display: none; }
            #panel-game { display: flex; flex: 1; min-height: 0; }

            /* --- ƒ∞STATƒ∞STƒ∞K MODU --- */
            body.stats-active .dashboard {
                display: block; /* Flex yerine block, scroll i√ßin */
                overflow-y: auto;
                padding-bottom: 80px;
            }
            body.stats-active #panel-game { display: none !important; }
            body.stats-active #panel-errors { 
                display: flex !important; 
                height: auto; 
                min-height: 400px; /* ƒ∞√ßerik kadar yer kaplasƒ±n */
                margin-bottom: 20px;
            }
            body.stats-active #panel-history { 
                display: flex !important; 
                height: auto;
                min-height: 400px;
            }
            body.stats-active .mobile-stats-back { display: block; margin-bottom: 15px; }

            /* --- KOMPAKT SETUP --- */
            .setup-container { padding: 15px; gap: 12px; height: auto; }
            .section-header { font-size: 14px; margin-bottom: 5px; }
            .num-grid { gap: 8px; margin-bottom: 10px; }
            .num-label { height: 40px; font-size: 16px; }
            
            .settings-box { padding: 12px; gap: 8px; }
            .sb-title { font-size: 12px; margin-bottom: 2px; }
            .toggle-group { flex-direction: row; min-height: 50px; padding: 2px; flex-wrap: nowrap; }
            .toggle-opt { padding: 5px; font-size: 11px; flex-direction: row; gap: 5px; }
            .input-box { width: 50px; height: 30px; font-size: 14px; }
            .btn-start { padding: 15px; font-size: 16px; margin-top: 10px; }

            .mobile-stats-btn {
                display: flex; width: 100%; background: rgba(255,255,255,0.1);
                border: 1px solid var(--border); color: var(--text-muted);
                padding: 10px; border-radius: 10px; font-weight: 800;
                justify-content: center; align-items: center; gap: 10px; cursor: pointer; margin-bottom: 10px;
            }
            .mobile-stats-back {
                width: 100%; background: var(--primary); color: #000;
                padding: 12px; border-radius: 10px; font-weight: 900; text-align: center; cursor: pointer; border: none;
            }

            /* --- OYUN MODU --- */
            .r-stat { font-size: 16px; padding: 4px 10px; }
            .r-q-box { font-size: 20px; padding: 5px 15px; }
            #racer-wrap { margin: 15px; height: 40vh; min-height: 300px; } 
            .mob-ctrl { display: flex; } .q-text { font-size: 80px; } .num-grid { grid-template-columns: repeat(4, 1fr); }
            .ans-inp { font-size: 40px; padding: 15px; }

            body.game-active { overflow: hidden; padding-top: env(safe-area-inset-top) !important; }
            body.game-active header, body.game-active footer { display: none !important; }
            body.game-active .dashboard { padding: 0; height: 100%; margin: 0; max-width: 100%; display: block; overflow: hidden; }
            body.game-active .panel { display: none; }
            body.game-active #panel-game { display: flex; height: 100%; border-radius: 0; border: none; }
            
            body.game-active #view-classic { display: flex; flex-direction: column; height: 100%; padding-bottom: 0; }
            body.game-active #view-classic .hud { margin: 10px; padding: 10px 15px; }
            body.game-active #view-classic .q-area { justify-content: center; margin-bottom: 0; }
            body.game-active #view-classic .q-text { font-size: 80px; margin-bottom: 10px; }
            body.game-active #view-classic .ans-inp { max-width: 80%; font-size: 50px; background: #0f172a; }
            body.game-active #view-classic .feedback { font-size: 24px; min-height: 40px; margin-top: 10px; }
            body.game-active #view-classic .foot-btns { display: none !important; }

            .mobile-keypad {
                display: flex; flex-direction: column; background: #0f172a;
                border-top: 1px solid var(--border); padding: 10px;
                padding-bottom: calc(40px + env(safe-area-inset-bottom)); 
                gap: 8px; margin-top: auto; flex-shrink: 0; z-index: 100;
            }
            .key-row { display: flex; gap: 8px; flex: 1; }
            .key-btn {
                flex: 1; background: var(--bg-card); border: 1px solid var(--border); color: #fff;
                font-size: 24px; font-weight: bold; border-radius: 8px; padding: 12px 0;
                cursor: pointer; display: flex; align-items: center; justify-content: center; touch-action: manipulation;
            }
            .key-btn:active { background: var(--primary); color: #000; }
            .key-btn.k-del { color: #fff; background: var(--bg-card); border-color: var(--border); }
            .key-btn.k-action { font-size: 14px; font-weight: 800; text-transform: uppercase; }
            .key-btn.k-pause { background: var(--warning); color: #000; }
            .key-btn.k-end { background: var(--danger); color: #fff; }
            .key-btn.k-sound { font-size: 20px; }
            .key-btn.k-sound.muted { opacity: 0.5; text-decoration: line-through; }
        }
    </style>
</head>
<body>

<header>
    <div class="header-left">
        <div class="logo">‚úñ √áARPTRƒ∞K</div>
    </div>
    
    <div class="header-center">
        <div class="mode-switch">
            <button class="m-btn active" id="tab-classic" onclick="requestModeChange('classic'); AudioSys.playClick()">
                <span>üìä</span> <span data-i18n="tab_klasik">KLASƒ∞K</span>
            </button>
            <button class="m-btn" id="tab-racer" onclick="requestModeChange('racer'); AudioSys.playClick()">
                <span>üèéÔ∏è</span> <span data-i18n="tab_yaris">YARI≈û</span>
            </button>
        </div>
    </div>

    <div class="header-right">
        <button class="sound-btn" id="btn-sound" onclick="toggleSound()">üîä</button>
        
        <div class="lang-switch">
            <button class="lang-btn active" id="l-tr" onclick="setLang('tr'); AudioSys.playClick()">TR</button>
            <button class="lang-btn" id="l-en" onclick="setLang('en'); AudioSys.playClick()">EN</button>
        </div>
    </div>
</header>

<div class="dashboard">
    
    <button class="mobile-stats-back" onclick="toggleStats()">‚¨Ö GERƒ∞ D√ñN</button>

    <aside class="panel" id="panel-errors">
        <div class="practice-area">
            <div class="pill-group">
                <div class="pill selected" onclick="setErrMode('weighted', this); AudioSys.playClick()">
                    <span data-i18n="puan_kadar">Puan</span>
                    <input type="radio" name="errMode" value="weighted" checked>
                </div>
                <div class="pill" onclick="setErrMode('single', this); AudioSys.playClick()">
                    <span data-i18n="bir_kez">1 Kez</span>
                    <input type="radio" name="errMode" value="single">
                </div>
            </div>
            <button class="btn-purple" onclick="startErrorPractice(); AudioSys.playClick()">
                <span>‚ö†Ô∏è</span> <span data-i18n="hatalara_calis">HATALARA √áALI≈û</span>
            </button>
        </div>

        <div class="panel-head">
            <span data-i18n="hata_listesi">HATA Lƒ∞STESƒ∞</span>
            <button class="mini-btn" onclick="resetData(); AudioSys.playClick()" data-i18n="temizle">TEMƒ∞ZLE</button>
        </div>
        <div class="list-content" id="list-errors">
            <div style="text-align:center; padding:20px; color:#555;" data-i18n="liste_temiz">Temiz</div>
        </div>
    </aside>

    <main class="panel" id="panel-game">
        
        <div id="view-setup" class="screen active">
            <div class="setup-container">
                
                <div class="mobile-stats-btn" onclick="toggleStats(); AudioSys.playClick()">
                    üìä ƒ∞STATƒ∞STƒ∞KLER & GE√áMƒ∞≈û
                </div>

                <div class="section-header" data-i18n="carp_sayilar">√áARPILACAK SAYILAR</div>
                <div class="num-grid">
                    <label><input type="checkbox" class="num-chk" value="2" checked onchange="calcTotal(); AudioSys.playClick()"><div class="num-label">2</div></label>
                    <label><input type="checkbox" class="num-chk" value="3" checked onchange="calcTotal(); AudioSys.playClick()"><div class="num-label">3</div></label>
                    <label><input type="checkbox" class="num-chk" value="4" checked onchange="calcTotal(); AudioSys.playClick()"><div class="num-label">4</div></label>
                    <label><input type="checkbox" class="num-chk" value="5" checked onchange="calcTotal(); AudioSys.playClick()"><div class="num-label">5</div></label>
                    <label><input type="checkbox" class="num-chk" value="6" checked onchange="calcTotal(); AudioSys.playClick()"><div class="num-label">6</div></label>
                    <label><input type="checkbox" class="num-chk" value="7" checked onchange="calcTotal(); AudioSys.playClick()"><div class="num-label">7</div></label>
                    <label><input type="checkbox" class="num-chk" value="8" checked onchange="calcTotal(); AudioSys.playClick()"><div class="num-label">8</div></label>
                    <label><input type="checkbox" class="num-chk" value="9" checked onchange="calcTotal(); AudioSys.playClick()"><div class="num-label">9</div></label>
                </div>
                <div class="grid-actions">
                    <button class="action-btn" onclick="toggleAll(true); AudioSys.playClick()" data-i18n="tumu">T√úM√ú SE√á</button>
                    <button class="action-btn" onclick="toggleAll(false); AudioSys.playClick()" data-i18n="temizle">TEMƒ∞ZLE</button>
                </div>

                <div class="settings-box">
                    <div class="sb-title" data-i18n="soru_sayisi">SORU SAYISI</div>
                    <div class="toggle-group">
                        <div class="toggle-opt selected" onclick="selectToggle(this); AudioSys.playClick()">
                            <span data-i18n="mod_tekrar_1">T√ºm√ºn√º</span>
                            <input type="number" id="inp-repeat" value="1" class="input-box" onchange="calcTotal()" onclick="event.stopPropagation()">
                            <span id="total-info" class="total-info">(1)</span>
                            <input type="radio" name="gMode" value="repeat" checked>
                        </div>
                        <div class="toggle-opt" onclick="selectToggle(this); AudioSys.playClick()">
                            <span data-i18n="mod_limit_1">Rastgele</span>
                            <input type="number" id="inp-limit" value="20" class="input-box" onclick="event.stopPropagation()">
                            <input type="radio" name="gMode" value="limit">
                        </div>
                    </div>
                </div>

                <div class="settings-box">
                    <div class="sb-title" data-i18n="hiz_ayari">S√úRE / HIZ</div>
                    
                    <div id="opt-speed-classic" class="toggle-group">
                        <div class="toggle-opt" onclick="selectToggle(this); AudioSys.playClick()">
                            <span data-i18n="otomatik">ORTALAMA</span>
                            <input type="radio" name="cSpeed" value="auto">
                        </div>
                        <div class="toggle-opt selected" onclick="selectToggle(this); AudioSys.playClick()">
                            <span data-i18n="sabit">SABƒ∞T</span>
                            <input type="number" id="inp-speed" value="4" class="input-box" onclick="event.stopPropagation()">
                            <span style="font-size:12px;color:var(--text-muted)">sn</span>
                            <input type="radio" name="cSpeed" value="manual" checked>
                        </div>
                    </div>

                    <div id="opt-speed-racer" class="toggle-group" style="display:none;">
                        <div class="toggle-opt" onclick="selectToggle(this); AudioSys.playClick()">
                            <span data-i18n="yavas">YAVA≈û</span>
                            <input type="radio" name="rSpeed" value="2.5">
                        </div>
                        <div class="toggle-opt selected" onclick="selectToggle(this); AudioSys.playClick()">
                            <span data-i18n="normal">NORMAL</span>
                            <input type="radio" name="rSpeed" value="4.5" checked>
                        </div>
                        <div class="toggle-opt" onclick="selectToggle(this); AudioSys.playClick()">
                            <span data-i18n="hizli">HIZLI</span>
                            <input type="radio" name="rSpeed" value="7">
                        </div>
                    </div>
                </div>

                <button class="btn-start classic" id="btn-start" onclick="startGame(); AudioSys.playClick()">
                    <span>‚ñ∂</span> <span data-i18n="baslat_klasik">KLASƒ∞K BA≈ûLAT</span>
                </button>
            </div>
        </div>

        <div id="view-classic" class="screen">
            <div class="hud">
                <div><span class="hud-lbl" data-i18n="tablo_puan">PUAN</span><div class="hud-val" style="color:var(--primary)" id="c-score">0</div></div>
                <div><span class="hud-lbl" data-i18n="tablo_soru">SORU</span><div class="hud-val"><span id="c-curr">0</span>/<span id="c-total">0</span></div></div>
                <div><span class="hud-lbl" data-i18n="tablo_hiz">HIZ</span><div class="hud-val" id="c-speed">0.0s</div></div>
            </div>
            
            <div class="q-area">
                <div class="q-text" id="c-q-text">2 x 2</div>
                <input type="number" class="ans-inp" id="c-input" inputmode="numeric" placeholder="?" autocomplete="off">
                <div class="feedback" id="c-feedback"></div>
            </div>

            <div class="foot-btns">
                <button class="f-btn" onclick="togglePause(); AudioSys.playClick()" data-i18n="duraklat">DURAKLAT</button>
                <button class="f-btn danger" onclick="confirmFinish(); AudioSys.playClick()" data-i18n="bitir">Bƒ∞Tƒ∞R</button>
            </div>

            <div class="mobile-keypad">
                <div class="key-row">
                    <button class="key-btn" onpointerdown="handleKeyInput(1)">1</button>
                    <button class="key-btn" onpointerdown="handleKeyInput(2)">2</button>
                    <button class="key-btn" onpointerdown="handleKeyInput(3)">3</button>
                </div>
                <div class="key-row">
                    <button class="key-btn" onpointerdown="handleKeyInput(4)">4</button>
                    <button class="key-btn" onpointerdown="handleKeyInput(5)">5</button>
                    <button class="key-btn" onpointerdown="handleKeyInput(6)">6</button>
                </div>
                <div class="key-row">
                    <button class="key-btn" onpointerdown="handleKeyInput(7)">7</button>
                    <button class="key-btn" onpointerdown="handleKeyInput(8)">8</button>
                    <button class="key-btn" onpointerdown="handleKeyInput(9)">9</button>
                </div>
                <div class="key-row">
                    <button class="key-btn k-sound" id="m-sound-btn" onclick="toggleSound(); handleKeyAction('sound')">üîä</button>
                    <button class="key-btn" onpointerdown="handleKeyInput(0)">0</button>
                    <button class="key-btn k-del" onpointerdown="handleKeyAction('del')">‚å´</button>
                </div>
                <div class="key-row">
                    <button class="key-btn k-action k-pause" onclick="togglePause(); AudioSys.playClick()" data-i18n="duraklat">II</button>
                    <button class="key-btn k-action k-end" onclick="confirmFinish(); AudioSys.playClick()" data-i18n="bitir">X</button>
                </div>
            </div>
        </div>

        <div id="view-racer" class="screen">
            <div id="racer-wrap">
                <canvas id="racerCanvas"></canvas>
                
                <div class="progress-strip">
                    <div class="prog-flag pf-end">üèÅ</div>
                    <div class="prog-car" id="prog-car">üèéÔ∏è</div>
                    <div class="prog-flag pf-start">üè≥Ô∏è</div>
                </div>

                <div class="r-header">
                    <div class="r-stat" style="color:var(--primary)">P: <span id="r-score">0</span></div>
                    <div class="r-q-box" id="r-q-text">2 x 2</div>
                    <div class="r-stat" style="color:var(--danger)">‚ù§Ô∏è <span id="r-lives">3</span></div>
                </div>

            </div>
            <div class="mob-ctrl">
                <button class="c-btn" onpointerdown="racerInput(-1); event.preventDefault()">‚¨ÖÔ∏è</button>
                <button class="c-btn" onpointerdown="racerInput(1); event.preventDefault()">‚û°Ô∏è</button>
            </div>
            <div class="foot-btns">
                <button class="f-btn" onclick="togglePause(); AudioSys.stopEngine(); AudioSys.playClick()" data-i18n="duraklat">DURAKLAT</button>
                <button class="f-btn danger" onclick="confirmFinish(); AudioSys.playClick()" data-i18n="bitir">Bƒ∞Tƒ∞R</button>
            </div>
        </div>

        <div id="view-result" class="screen">
            <div class="res-box">
                <span class="section-header" style="font-size:16px;" data-i18n="seans_bitti">SEANS Bƒ∞TTƒ∞</span>
                <div class="res-score" id="res-score">100</div>
                <div class="res-grid">
                    <div class="res-item">
                        <span class="hud-lbl" data-i18n="tablo_hiz">HIZ</span>
                        <div style="font-size:24px; font-weight:bold" id="res-speed">0.0s</div>
                    </div>
                    <div class="res-item">
                        <span class="hud-lbl" data-i18n="tablo_hata">HATA</span>
                        <div style="font-size:24px; font-weight:bold; color:var(--danger)" id="res-err">0</div>
                    </div>
                </div>
                <button class="btn-start classic" style="max-width:200px;" onclick="showSetup(); AudioSys.playClick()" data-i18n="tamam_btn">TAMAM</button>
            </div>
        </div>

    </main>

    <aside class="panel" id="panel-history">
        <div class="graph-area" id="score-graph"></div>
        <div class="panel-head">
            <span data-i18n="gecmis_skorlar">GE√áMƒ∞≈û</span>
            <button class="mini-btn" onclick="clearHistory(); AudioSys.playClick()" data-i18n="sil">Sƒ∞L</button>
        </div>
        <div class="grid-header">
            <span>P</span> <span>HZ</span> <span>HT</span> <span>SR</span>
        </div>
        <div class="list-content" id="list-history">
            <div style="text-align:center; padding:20px; color:#555;" data-i18n="gecmis_yok">Yok</div>
        </div>
    </aside>

</div>

<div id="pause-overlay">
    <div class="paused-text" data-i18n="duraklatildi">DURAKLATILDI</div>
    <div class="pause-menu">
        <button class="btn-resume" onclick="resumeGame(); AudioSys.playClick()" data-i18n="devam_et">DEVAM ET</button>
        <button class="btn-quit" onclick="confirmFinish(); AudioSys.playClick()" data-i18n="bitir">Bƒ∞Tƒ∞R</button>
    </div>
</div>

<div id="mainModal" class="modal-wrap">
    <div class="modal">
        <div id="m-text" style="font-size:18px; color:#fff; margin-bottom:10px;">...</div>
        <div class="m-btns" id="m-actions"></div>
    </div>
</div>

<footer>
    <div>¬© 2026 √áarptrik</div>
    <a href="mailto:carptrik@gmail.com" style="margin-left:10px;">carptrik@gmail.com</a>
</footer>

<script>
const AudioSys = {
    ctx: null, osc: null, gain: null,
    init: function() {
        if(!this.ctx) {
            window.AudioContext = window.AudioContext || window.webkitAudioContext;
            this.ctx = new AudioContext();
        }
        if(this.ctx.state === 'suspended') this.ctx.resume();
    },
    playTone: function(freq, type, duration, vol=0.1) {
        if(!DATA.sound) return;
        this.init();
        const o = this.ctx.createOscillator();
        const g = this.ctx.createGain();
        o.type = type;
        o.frequency.setValueAtTime(freq, this.ctx.currentTime);
        g.gain.setValueAtTime(vol, this.ctx.currentTime);
        g.gain.exponentialRampToValueAtTime(0.01, this.ctx.currentTime + duration);
        o.connect(g); g.connect(this.ctx.destination);
        o.start(); o.stop(this.ctx.currentTime + duration);
    },
    playClick: function() { this.playTone(800, 'sine', 0.1, 0.05); },
    playCorrect: function() { 
        if(!DATA.sound) return;
        this.init();
        const now = this.ctx.currentTime;
        const o = this.ctx.createOscillator();
        const g = this.ctx.createGain();
        o.frequency.setValueAtTime(600, now);
        o.frequency.exponentialRampToValueAtTime(1200, now + 0.1);
        g.gain.setValueAtTime(0.1, now);
        g.gain.exponentialRampToValueAtTime(0.01, now + 0.3);
        o.connect(g); g.connect(this.ctx.destination);
        o.start(); o.stop(now + 0.3);
    },
    playWrong: function() { this.playTone(150, 'sawtooth', 0.3, 0.1); },
    startEngine: function() {
        if(!DATA.sound || this.osc) return;
        this.init();
        this.osc = this.ctx.createOscillator();
        this.gain = this.ctx.createGain();
        this.osc.type = 'sawtooth';
        this.osc.frequency.value = 60; 
        const filter = this.ctx.createBiquadFilter();
        filter.type = 'lowpass'; filter.frequency.value = 120;
        this.gain.gain.value = 0.05; 
        this.osc.connect(filter); filter.connect(this.gain);
        this.gain.connect(this.ctx.destination);
        this.osc.start();
    },
    stopEngine: function() {
        if(this.osc) { this.osc.stop(); this.osc.disconnect(); this.osc = null; }
    }
};

const DATA = {
    lang: 'tr', mode: 'classic', sound: true,
    classic: { db: JSON.parse(localStorage.getItem('carptrik_classic_db')) || {}, history: JSON.parse(localStorage.getItem('carptrik_classic_history')) || [] },
    racer: { db: JSON.parse(localStorage.getItem('carptrik_racer_db')) || {}, history: JSON.parse(localStorage.getItem('carptrik_racer_history')) || [] }
};
if(localStorage.getItem('carptrik_sound') === 'false') DATA.sound = false;

const TEXT = {
    tr: {
        carp_sayilar:"√áARPILACAK SAYILAR", tumu:"T√úM√ú SE√á", temizle:"TEMƒ∞ZLE", ayarlar:"OYUN AYARLARI",
        mod_tekrar_1:"T√ºm√ºn√º", mod_tekrar_2:"kez", mod_limit_1:"Rastgele", soru_sayisi:"SORU SAYISI",
        baslat_klasik:"KLASƒ∞K BA≈ûLAT", baslat_yaris:"YARI≈û BA≈ûLAT", hata_listesi:"HATA Lƒ∞STESƒ∞",
        hatalara_calis:"HATALARA √áALI≈û", liste_temiz:"Hata listeniz temiz.", gecmis_skorlar:"GE√áMƒ∞≈û",
        gecmisi_sil:"Sƒ∞L", tablo_puan:"P", tablo_hiz:"HZ", tablo_hata:"H", tablo_soru:"S",
        gecmis_yok:"Kayƒ±t yok.", geri:"GERƒ∞", duraklat:"DURAKLAT", devam_et:"DEVAM ET", duraklatildi:"DURAKLATILDI", bitir:"Bƒ∞Tƒ∞R", seans_bitti:"SEANS Bƒ∞TTƒ∞", tamam_btn:"TAMAM",
        alert_sayi:"L√ºtfen en az bir sayƒ± se√ßin!", alert_hata:"Hata listeniz temiz.",
        confirm_bitir:"Bitirmek istediƒüinize emin misiniz?", confirm_sil:"Silmek istiyor musunuz?",
        tab_klasik:"KLASƒ∞K", tab_yaris:"YARI≈û", dogru:"DOƒûRU", yanlis:"YANLI≈û!",
        puan_kadar:"Puan", bir_kez:"1 Kez", can:"CAN", modal_evet:"EVET", modal_iptal:"ƒ∞PTAL", sil:"Sƒ∞L",
        hiz_ayari:"S√úRE / HIZ", otomatik:"ORTALAMA", sabit:"SABƒ∞T", yavas:"YAVA≈û", normal:"NORMAL", hizli:"HIZLI",
        mod_limit_2: "tane sor", sure_yavas:"YAVA≈û",
        mod_degistir_onay: "Mod deƒüi≈ütirmek mevcut oyunu sonlandƒ±racak. Emin misiniz?"
    },
    en: {
        carp_sayilar:"NUMBERS TO MULTIPLY", tumu:"SELECT ALL", temizle:"CLEAR", ayarlar:"GAME SETTINGS",
        mod_tekrar_1:"All", mod_tekrar_2:"times", mod_limit_1:"Random", soru_sayisi:"QUESTION COUNT",
        baslat_klasik:"START CLASSIC", baslat_yaris:"START RACER", hata_listesi:"ERRORS",
        hatalara_calis:"PRACTICE ERRORS", liste_temiz:"Clean.", gecmis_skorlar:"HISTORY",
        gecmisi_sil:"DEL", tablo_puan:"S", tablo_hiz:"SP", tablo_hata:"E", tablo_soru:"Q",
        gecmis_yok:"Empty.", geri:"BACK", duraklat:"PAUSE", devam_et:"RESUME", duraklatildi:"PAUSED", bitir:"FINISH", seans_bitti:"FINISHED", tamam_btn:"OK",
        alert_sayi:"Select numbers first!", alert_hata:"No errors recorded.",
        confirm_bitir:"Are you sure?", confirm_sil:"Delete all?",
        tab_klasik:"CLASSIC", tab_yaris:"RACER", dogru:"CORRECT", yanlis:"WRONG!",
        puan_kadar:"Score", bir_kez:"Once", can:"HP", modal_evet:"YES", modal_iptal:"CANCEL", sil:"DEL",
        hiz_ayari:"SPEED", otomatik:"AVERAGE", sabit:"FIXED", yavas:"SLOW", normal:"NORMAL", hizli:"FAST",
        mod_limit_2: "questions", sure_yavas:"TOO SLOW",
        mod_degistir_onay: "Switching modes will end current game. Are you sure?"
    }
};

function init() {
    const l = localStorage.getItem('carptrik_lang');
    if(l) DATA.lang = l;
    setLang(DATA.lang);
    setMode('classic');
    updateSoundBtn();
}

function toggleSound() {
    DATA.sound = !DATA.sound;
    localStorage.setItem('carptrik_sound', DATA.sound);
    updateSoundBtn();
    if(DATA.sound) AudioSys.init(); else AudioSys.stopEngine();
}

function updateSoundBtn() {
    const btn = document.getElementById('btn-sound');
    btn.innerHTML = DATA.sound ? 'üîä' : 'üîá';
    btn.classList.toggle('active', DATA.sound);
    const kBtn = document.getElementById('m-sound-btn');
    if(kBtn) {
        kBtn.innerText = DATA.sound ? 'üîä' : 'üîá';
        if(!DATA.sound) kBtn.classList.add('muted'); else kBtn.classList.remove('muted');
    }
}

function setLang(l) {
    DATA.lang = l;
    localStorage.setItem('carptrik_lang', l);
    document.getElementById('l-tr').classList.toggle('active', l==='tr');
    document.getElementById('l-en').classList.toggle('active', l==='en');
    document.querySelectorAll('[data-i18n]').forEach(el => {
        const k = el.getAttribute('data-i18n');
        if(TEXT[l][k]) el.innerText = TEXT[l][k];
    });
    renderLists();
    updateStartBtn();
}

function requestModeChange(m) {
    if(DATA.mode === m) return;
    if(document.getElementById('view-setup').classList.contains('active')) {
        setMode(m);
    } else {
        modal(TEXT[DATA.lang].mod_degistir_onay, () => { showSetup(); setMode(m); });
    }
}

function setMode(m) {
    DATA.mode = m;
    document.getElementById('tab-classic').classList.toggle('active', m==='classic');
    document.getElementById('tab-racer').classList.toggle('active', m==='racer');
    document.getElementById('opt-speed-classic').style.display = m==='classic' ? 'flex' : 'none';
    document.getElementById('opt-speed-racer').style.display = m==='racer' ? 'flex' : 'none';
    updateStartBtn(); renderLists(); calcTotal();
}

function updateStartBtn() {
    const btn = document.getElementById('btn-start');
    if(DATA.mode === 'classic') {
        btn.className = "btn-start classic";
        btn.innerHTML = `<span>‚ñ∂</span> <span>${TEXT[DATA.lang].baslat_klasik}</span>`;
    } else {
        btn.className = "btn-start racer";
        btn.innerHTML = `<span>üèéÔ∏è</span> <span>${TEXT[DATA.lang].baslat_yaris}</span>`;
    }
}

function selectToggle(el) {
    el.parentElement.querySelectorAll('.toggle-opt').forEach(c => c.classList.remove('selected'));
    el.classList.add('selected'); el.querySelector('input').checked = true; calcTotal();
}

function setErrMode(val, el) {
    document.querySelectorAll('.pill').forEach(p => p.classList.remove('selected'));
    el.classList.add('selected'); el.querySelector('input').checked = true;
}

function toggleAll(v) { document.querySelectorAll('.num-chk').forEach(c => c.checked=v); calcTotal(); }
function getNums() { return Array.from(document.querySelectorAll('.num-chk:checked')).map(c=>parseInt(c.value)); }

function calcTotal() {
    const nums = getNums().length;
    const rep = parseInt(document.getElementById('inp-repeat').value) || 1;
    const total = nums * nums * rep;
    const mode = document.querySelector('input[name="gMode"]:checked').value;
    const infoSpan = document.getElementById('total-info');
    if (mode === 'repeat') { infoSpan.style.display = 'inline'; infoSpan.innerText = `(${total})`; } else { infoSpan.style.display = 'none'; }
}

function toggleStats() { document.body.classList.toggle('stats-active'); }

function showScreen(id) {
    document.querySelectorAll('.screen').forEach(s => s.classList.remove('active'));
    document.getElementById('view-'+id).classList.add('active');
}
function showSetup() { 
    Game.isPaused = false; AudioSys.stopEngine(); if(Game.r.loop) cancelAnimationFrame(Game.r.loop);
    document.body.classList.remove('game-active'); document.body.classList.remove('stats-active');
    document.getElementById('pause-overlay').style.display = 'none';
    document.querySelectorAll('.q-area, #racer-wrap').forEach(el => el.style.filter = 'none');
    document.querySelectorAll('.foot-btns').forEach(b => b.style.display = 'flex');
    showScreen('setup'); 
}

function modal(msg, onYes) {
    const w = document.querySelector('.modal-wrap');
    document.getElementById('m-text').innerText = msg;
    const a = document.getElementById('m-actions');
    if(onYes) {
        a.innerHTML = `<button class="mb mb-ok" onclick="doYes(); AudioSys.playClick()">${TEXT[DATA.lang].modal_evet}</button><button class="mb mb-no" onclick="closeModal(); AudioSys.playClick()">${TEXT[DATA.lang].modal_iptal}</button>`;
        window.doYes = () => { onYes(); closeModal(); };
    } else {
        a.innerHTML = `<button class="mb mb-ok" onclick="closeModal(); AudioSys.playClick()">${TEXT[DATA.lang].tamam_btn}</button>`;
    }
    w.style.display = 'flex';
}
function closeModal() { document.querySelector('.modal-wrap').style.display = 'none'; }

function shakeScreen() {
    document.body.classList.add('shake');
    const flash = document.createElement('div'); flash.className = 'damage-flash';
    document.body.appendChild(flash);
    setTimeout(() => { document.body.classList.remove('shake'); if(flash) flash.remove(); }, 500);
}

function updateProgress() {
    const p = (Game.total > 0) ? Math.min(100, (Game.idx / Game.total) * 100) : 0;
    const car = document.getElementById('prog-car'); if(car) car.style.bottom = p + '%';
}

function handleKeyInput(val) {
    if(Game.isPaused || document.getElementById('c-input').disabled) return;
    const i = document.getElementById('c-input'); i.value += val; AudioSys.playClick();
    i.dispatchEvent(new Event('input'));
}

function handleKeyAction(action) {
    if(Game.isPaused) return;
    if(action === 'del') {
        const i = document.getElementById('c-input'); i.value = i.value.slice(0, -1);
        AudioSys.playClick(); i.dispatchEvent(new Event('input'));
    }
}

let Game = {
    type: null, qList:[], total:0, idx:0, score:0, unitScore:0, errors:0, times:[], startT:0, currQ:null,
    slowLimit: 0, isPaused: false, pauseStart: 0,
    r: { loop:null, lane:1, x:0, cars:[], speed:6, lives:3, particles:[], isWaveActive:true, inputLocked: false, lastTime: 0 } 
};

function startGame() {
    const nums = getNums();
    if(nums.length === 0) return modal(TEXT[DATA.lang].alert_sayi);
    if(window.innerWidth <= 900) document.body.classList.add('game-active');
    
    let pool = []; nums.forEach(n1 => nums.forEach(n2 => pool.push({n1, n2})));
    Game.qList = [];
    const mode = document.querySelector('input[name="gMode"]:checked').value;
    if(mode === 'repeat') {
        const cnt = parseInt(document.getElementById('inp-repeat').value)||1;
        for(let i=0; i<cnt; i++) Game.qList.push(...pool);
    } else {
        const lim = parseInt(document.getElementById('inp-limit').value)||20;
        for(let i=0; i<lim; i++) Game.qList.push(pool[Math.floor(Math.random()*pool.length)]);
    }
    Game.qList.sort(()=>Math.random()-0.5);
    resetState(DATA.mode, Game.qList.length);
    if(Game.type === 'classic') { showScreen('classic'); nextQClassic(); } else { showScreen('racer'); initRacer(); }
}

function startErrorPractice() {
    const currentDB = DATA[DATA.mode].db;
    const keys = Object.keys(currentDB);
    if(keys.length === 0) return modal(TEXT[DATA.lang].alert_hata);
    if(window.innerWidth <= 900) document.body.classList.add('game-active');

    Game.qList = [];
    const mode = document.querySelector('input[name="errMode"]:checked').value;
    keys.forEach(k => {
        const [n1, n2] = k.split('x').map(Number);
        const c = mode === 'single' ? 1 : currentDB[k].score;
        for(let i=0; i<c; i++) Game.qList.push({n1,n2});
    });
    Game.qList.sort(()=>Math.random()-0.5);
    resetState(DATA.mode, Game.qList.length);
    if(DATA.mode === 'classic') { showScreen('classic'); nextQClassic(); } else { showScreen('racer'); initRacer(); }
}

function resetState(t, len) {
    Game.type = t; Game.total = len; Game.idx = 0; Game.score = 0; 
    Game.unitScore = (len > 0) ? (100 / len) : 0; Game.errors = 0; Game.times = [];
    Game.isPaused = false; document.getElementById('pause-overlay').style.display = 'none';
    document.querySelectorAll('.q-area, #racer-wrap').forEach(el => el.style.filter = 'none');
    document.querySelectorAll('.foot-btns').forEach(b => b.style.display = 'flex');
}

function togglePause() { if(Game.isPaused) resumeGame(); else pauseGame(); }

function pauseGame() {
    Game.isPaused = true; Game.pauseStart = Date.now();
    document.getElementById('pause-overlay').style.display = 'flex';
    document.querySelectorAll('.foot-btns').forEach(b => b.style.display = 'none');
    if(Game.type === 'classic') {
         const qArea = document.querySelector('#view-classic .q-area');
         if(qArea) qArea.style.filter = 'blur(30px)';
         document.getElementById('c-input').disabled = true;
    } else if(Game.type === 'racer') {
         document.querySelector('#racer-wrap').style.filter = 'blur(30px)';
         if(Game.r.loop) cancelAnimationFrame(Game.r.loop);
         AudioSys.stopEngine(); Game.r.lastTime = 0; 
    }
}

function resumeGame() {
    Game.isPaused = false;
    Game.startT += (Date.now() - Game.pauseStart);
    document.getElementById('pause-overlay').style.display = 'none';
    document.querySelectorAll('.foot-btns').forEach(b => b.style.display = 'flex');
    if(Game.type === 'classic') {
        const qArea = document.querySelector('#view-classic .q-area');
        if(qArea) qArea.style.filter = 'none';
        document.getElementById('c-input').disabled = false;
        if(window.innerWidth > 900) document.getElementById('c-input').focus();
    } else if(Game.type === 'racer') {
        document.querySelector('#racer-wrap').style.filter = 'none';
        AudioSys.startEngine(); Game.r.lastTime = 0; 
        Game.r.loop = requestAnimationFrame(racerLoop);
    }
}

function confirmFinish() { document.getElementById('pause-overlay').style.display = 'none'; modal(TEXT[DATA.lang].confirm_bitir, endGame); }

function endGame() {
    Game.isPaused = false; document.body.classList.remove('game-active');
    document.getElementById('pause-overlay').style.display = 'none';
    document.querySelectorAll('.foot-btns').forEach(b => b.style.display = 'flex');
    document.querySelectorAll('.q-area, #racer-wrap').forEach(el => el.style.filter = 'none');
    if(Game.r.loop) cancelAnimationFrame(Game.r.loop); AudioSys.stopEngine();
    
    Game.score = Math.round(Math.max(0, Math.min(100, Game.score)));
    const avg = Game.times.length ? (Game.times.reduce((a,b)=>a+b,0)/Game.times.length).toFixed(1) : "0.0";
    
    const activeData = DATA[DATA.mode];
    activeData.history.unshift({score:Game.score, speed:avg, errors:Game.errors, q:Game.idx});
    if(activeData.history.length > 20) activeData.history.pop();
    localStorage.setItem(`carptrik_${DATA.mode}_history`, JSON.stringify(activeData.history));
    renderLists();
    
    document.getElementById('res-score').innerText = Game.score;
    document.getElementById('res-speed').innerText = avg+'s';
    document.getElementById('res-err').innerText = Game.errors;
    showScreen('result');
}

function nextQClassic() {
    if(Game.idx >= Game.total) return endGame();
    Game.currQ = Game.qList[Game.idx];
    document.getElementById('c-q-text').innerText = `${Game.currQ.n1} x ${Game.currQ.n2}`;
    document.getElementById('c-curr').innerText = Game.idx + 1;
    document.getElementById('c-total').innerText = Game.total;
    document.getElementById('c-score').innerText = Math.round(Game.score);
    document.getElementById('c-feedback').innerText = "";
    const i = document.getElementById('c-input'); i.value = ''; i.disabled = false; 
    if(window.innerWidth <= 900) i.readOnly = true; else { i.readOnly = false; i.focus(); }
    
    Game.startT = Date.now();
    const speedMode = document.querySelector('input[name="cSpeed"]:checked').value;
    if(speedMode === 'manual') Game.slowLimit = parseFloat(document.getElementById('inp-speed').value) || 4;
    else {
        if(Game.times.length < 3) Game.slowLimit = 5; 
        else {
            const avg = Game.times.reduce((a,b)=>a+b,0) / Game.times.length;
            Game.slowLimit = Math.max(2, avg * 1.5); 
        }
    }
}

document.getElementById('c-input').addEventListener('input', function() {
    if(Game.isPaused) return;
    const ans = Game.currQ.n1 * Game.currQ.n2;
    if(this.value.length >= ans.toString().length) {
        const elapsed = (Date.now() - Game.startT) / 1000;
        const isSlow = elapsed > Game.slowLimit;
        const val = parseInt(this.value);
        const k = `${Game.currQ.n1}x${Game.currQ.n2}`;
        const db = DATA.classic.db; if(!db[k]) db[k]={score:0};
        const fb = document.getElementById('c-feedback');
        
        if(val === ans) {
            Game.times.push(elapsed);
            const avg = Game.times.reduce((a,b)=>a+b,0)/Game.times.length;
            document.getElementById('c-speed').innerText = avg.toFixed(1)+'s';
            if (isSlow) {
                Game.errors++; db[k].score += 1; Game.score += (Game.unitScore / 2);
                fb.innerHTML = `<span style="color:var(--warning)">${TEXT[DATA.lang].sure_yavas}</span>`; AudioSys.playWrong(); 
            } else {
                if(db[k].score > 0) db[k].score--; Game.score += Game.unitScore;
                fb.innerText = TEXT[DATA.lang].dogru; fb.style.color = 'var(--primary)'; AudioSys.playCorrect();
            }
            Game.idx++; setTimeout(nextQClassic, 500); 
        } else {
            Game.errors++; db[k].score += 2; Game.score -= (Game.unitScore / 2); if(Game.score < 0) Game.score = 0;
            fb.innerHTML = `${TEXT[DATA.lang].yanlis}<br>${ans}`; fb.style.color = 'var(--danger)'; AudioSys.playWrong();
            const i = document.getElementById('c-input'); i.disabled = true;
            setTimeout(() => { if(!Game.isPaused) { i.disabled = false; Game.idx++; nextQClassic(); } }, 1500);
        }
        if(db[k].score <= 0) delete db[k];
        localStorage.setItem('carptrik_classic_db', JSON.stringify(db));
        renderLists();
    }
});

function initRacer() {
    if(window.innerWidth <= 900) setTimeout(() => { document.getElementById('racer-wrap').scrollIntoView({ behavior: 'smooth', block: 'center' }); }, 100);
    cvs.width = document.getElementById('racer-wrap').offsetWidth;
    cvs.height = document.getElementById('racer-wrap').offsetHeight;
    const spdOpt = document.querySelector('input[name="rSpeed"]:checked').value;
    Game.r.speed = parseFloat(spdOpt) || 2.5;
    Game.r.lives=3; Game.r.lane=1;
    const lw = cvs.width/4; Game.r.x = (1 * lw) + (lw/2); Game.r.currX = Game.r.x;
    Game.r.cars=[]; Game.r.particles=[]; Game.r.inputLocked = false; Game.r.lastTime = 0; 
    AudioSys.startEngine(); updateProgress(); spawnRacerQ(); Game.r.loop = requestAnimationFrame(racerLoop);
}

function spawnRacerQ() {
    if(Game.idx >= Game.total) { endGame(); return; }
    updateProgress();
    Game.r.cars = []; Game.r.isWaveActive = true; Game.r.inputLocked = false;
    Game.currQ = Game.qList[Game.idx];
    document.getElementById('r-q-text').innerText = `${Game.currQ.n1} x ${Game.currQ.n2}`;
    document.getElementById('r-score').innerText = Math.round(Game.score);
    document.getElementById('r-lives').innerText = Game.r.lives;
    const ans = Game.currQ.n1 * Game.currQ.n2;
    let opts = [ans];
    while(opts.length < 4) { let f = ans + (Math.floor(Math.random()*10)-5); if(f>0 && f!==ans && !opts.includes(f)) opts.push(f); }
    opts.sort(()=>Math.random()-0.5);
    const colors = ['#ef4444', '#10b981', '#3b82f6', '#f59e0b', '#8b5cf6'];
    for(let i=0; i<4; i++) {
        Game.r.cars.push({ lane: i, y: -300, val: opts[i], isCorrect: opts[i]===ans, color: colors[Math.floor(Math.random()*colors.length)], hit: false, driftX: 0, driftY: 0 });
    }
    Game.startT = Date.now(); 
}

function spawnParticles(x, y, color) {
    for(let i=0; i<20; i++) { Game.r.particles.push({ x: x, y: y, vx: (Math.random()-0.5) * 15, vy: (Math.random()-0.5) * 15, life: 40, color: color }); }
}

function drawCar(x, y, color, isPlayer=false) {
    const w = 70; const h = 90;
    if(isPlayer && y > -150 && y < cvs.height + 100) { 
        ctx.save(); ctx.beginPath();
        ctx.moveTo(x - (w/2) + 10, y); ctx.lineTo(x - (w/2) - 15, y - 200); ctx.lineTo(x - (w/2) + 35, y - 200);
        ctx.fillStyle = "rgba(255, 255, 255, 0.08)"; ctx.fill();
        if (Game.r.lives > 1) {
            ctx.beginPath(); ctx.moveTo(x + (w/2) - 10, y); ctx.lineTo(x + (w/2) - 35, y - 200); ctx.lineTo(x + (w/2) + 15, y - 200); ctx.fill();
        }
        ctx.restore();
    }
    ctx.fillStyle = color; ctx.beginPath(); ctx.roundRect(x - w/2, y, w, h, 10); ctx.fill();
    ctx.fillStyle = "rgba(0,0,0,0.5)"; ctx.beginPath(); ctx.roundRect(x - (w/2)+5, y + 20, w-10, 20, 5); ctx.fill();
    if(isPlayer) {
        if (Game.r.lives <= 2) { ctx.strokeStyle = "rgba(0,0,0,0.7)"; ctx.lineWidth=3; ctx.beginPath(); ctx.moveTo(x-10, y+30); ctx.lineTo(x+15, y+40); ctx.stroke(); }
        if (Game.r.lives <= 1) { ctx.beginPath(); ctx.moveTo(x+10, y+25); ctx.lineTo(x-15, y+45); ctx.lineTo(x+5, y+55); ctx.stroke(); }
    }
    ctx.fillStyle = "rgba(0,0,0,0.3)"; ctx.beginPath(); ctx.roundRect(x - (w/2)+5, y + 45, w-10, 35, 5); ctx.fill();
    ctx.fillStyle = "#fff"; ctx.beginPath(); ctx.arc(x - (w/2) + 10, y + 5, 4, 0, Math.PI*2); ctx.fill(); 
    if (!isPlayer || Game.r.lives > 1) { ctx.beginPath(); ctx.arc(x + (w/2) - 10, y + 5, 4, 0, Math.PI*2); ctx.fill(); } 
    else { ctx.fillStyle = "#333"; ctx.beginPath(); ctx.arc(x + (w/2) - 10, y + 5, 4, 0, Math.PI*2); ctx.fill(); }
}

function racerLoop(timestamp) {
    if(Game.type !== 'racer' || Game.isPaused) return; 
    if (!Game.r.lastTime) Game.r.lastTime = timestamp;
    const dt = (timestamp - Game.r.lastTime) / 16.67; Game.r.lastTime = timestamp;
    const safeDt = Math.min(dt, 3);
    const lw = cvs.width/4;

    ctx.clearRect(0,0,cvs.width, cvs.height);
    ctx.fillStyle = "#1e293b"; ctx.fillRect(0,0,cvs.width,cvs.height);
    ctx.strokeStyle = "#334155"; ctx.lineWidth=2; ctx.setLineDash([20,30]);
    for(let i=1; i<4; i++) { ctx.beginPath(); ctx.moveTo(i*lw,0); ctx.lineTo(i*lw,cvs.height); ctx.stroke(); }
    
    const tx = (Game.r.lane * lw) + (lw/2);
    Game.r.currX += (tx - Game.r.currX) * (0.2 * safeDt);
    const px = Game.r.currX; const py = cvs.height - 120;
    
    drawCar(px, py, "#10b981", true); 

    for(let i=Game.r.particles.length-1; i>=0; i--) {
        let p = Game.r.particles[i]; p.x += p.vx * safeDt; p.y += p.vy * safeDt; p.life -= 1 * safeDt;
        ctx.fillStyle = p.color; ctx.fillRect(p.x, p.y, p.life/5, p.life/5);
        if(p.life <= 0) Game.r.particles.splice(i,1);
    }

    for(let i=Game.r.cars.length-1; i>=0; i--) {
        let c = Game.r.cars[i];
        if (c.hit) { c.x += c.driftX * safeDt; c.y += c.driftY * safeDt; } else { c.y += Game.r.speed * safeDt; }
        let drawX = c.hit ? c.x : (c.lane * lw) + (lw/2);
        if (c.y > cvs.height + 100) { Game.r.cars.splice(i, 1); continue; }
        drawCar(drawX, c.y, c.color, false); 
        if(!c.hit) { ctx.fillStyle = "#fff"; ctx.font="900 24px Arial"; ctx.textAlign="center"; ctx.fillText(c.val, drawX, c.y + 70); }

        if(Game.r.isWaveActive && !c.hit && c.y+90 > py && c.y < py+90 && Math.abs(px - drawX) < 50) {
            Game.r.isWaveActive = false; Game.r.inputLocked = true;
            const k = `${Game.currQ.n1}x${Game.currQ.n2}`; const db = DATA.racer.db; if(!db[k]) db[k]={score:0};

            if(c.isCorrect) {
                spawnParticles(drawX, c.y + 45, c.color); Game.r.cars.splice(i, 1); 
                Game.times.push((Date.now()-Game.startT)/1000); Game.idx++; AudioSys.playCorrect();
                if(db[k].score > 0) db[k].score--; Game.score += Game.unitScore;
                setTimeout(spawnRacerQ, 800); 
            } else {
                c.hit = true; c.x = drawX; c.driftX = (drawX < px) ? -8 : 8; c.driftY = Game.r.speed * 1.2; 
                shakeScreen(); spawnParticles(px, py + 45, "#ef4444"); AudioSys.playWrong();
                Game.r.lives--; Game.errors++; db[k].score += 2; document.getElementById('r-lives').innerText = Game.r.lives;
                if(Game.r.lives <= 0) { spawnParticles(px, py, "#10b981"); setTimeout(endGame, 1000); } else { Game.idx++; setTimeout(spawnRacerQ, 1500); }
            }
            if(db[k].score <= 0) delete db[k]; localStorage.setItem('carptrik_racer_db', JSON.stringify(db)); renderLists();
        }
    }
    Game.r.loop = requestAnimationFrame(racerLoop);
}

function racerInput(d) {
    if(Game.r.inputLocked || Game.isPaused) return; 
    let n = Game.r.lane + d; if(n>=0 && n<=3) Game.r.lane = n;
}

window.addEventListener('keydown', e => {
    if(Game.type === 'racer') {
        const k = e.key.toLowerCase(); 
        if(k === 'arrowleft' || k === 'a') racerInput(-1); if(k === 'arrowright' || k === 'd') racerInput(1);
    }
});

function renderLists() {
    const activeData = DATA[DATA.mode];
    const el = document.getElementById('list-errors');
    if(Object.keys(activeData.db).length === 0) el.innerHTML=`<div style="text-align:center; padding:10px;">${TEXT[DATA.lang].liste_temiz}</div>`;
    else {
        let h = "";
        Object.keys(activeData.db).sort((a,b)=>activeData.db[b].score - activeData.db[a].score).forEach(k => {
            h += `<div class="err-row"><span>${k}</span><b style="color:var(--danger)">+${activeData.db[k].score}</b></div>`;
        });
        el.innerHTML = h;
    }
    
    const hl = document.getElementById('list-history');
    const graphBox = document.getElementById('score-graph');
    if(activeData.history.length === 0) {
        hl.innerHTML=`<div style="text-align:center; padding:10px;">${TEXT[DATA.lang].gecmis_yok}</div>`; graphBox.innerHTML = "";
    } else {
        let h = "";
        const points = activeData.history.slice(0, 10).reverse().map(x => x.score);
        if(points.length > 1) {
            const w = graphBox.offsetWidth; const hg = graphBox.offsetHeight;
            let d = `M 0 ${hg - (points[0]/100 * hg)}`; const step = w / (points.length - 1);
            let circles = "";
            points.forEach((p, i) => {
                const x = i * step; const y = hg - (p/100 * hg);
                d += ` L ${x} ${y}`; circles += `<circle cx="${x}" cy="${y}" class="chart-dot" />`;
            });
            graphBox.innerHTML = `<svg><path d="${d}" class="chart-line" />${circles}</svg>`;
        }
        activeData.history.forEach(x => {
            h += `<div class="grid-row"><span class="col" style="color:var(--primary);font-weight:bold">${x.score}</span><span class="col">${x.speed}s</span><span class="col" style="color:${x.errors>0?'var(--danger)':'#666'}">${x.errors}</span><span class="col">${x.q}</span></div>`;
        });
        hl.innerHTML = h;
    }
}

function clearHistory() { modal(TEXT[DATA.lang].confirm_sil, () => { DATA[DATA.mode].history = []; localStorage.setItem(`carptrik_${DATA.mode}_history`, JSON.stringify([])); renderLists(); }); }
function resetData() { modal(TEXT[DATA.lang].confirm_sil, () => { DATA[DATA.mode].db = {}; localStorage.removeItem(`carptrik_${DATA.mode}_db`); renderLists(); }); }

calcTotal(); init();
window.addEventListener('resize', ()=>{ 
    if(Game.type==='racer') { cvs.width=document.getElementById('racer-wrap').offsetWidth; cvs.height=document.getElementById('racer-wrap').offsetHeight; }
    renderLists();
});
</script>
</body>
</html>
