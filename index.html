<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta name="google-site-verification" content="DbvwD_t2D1ABQ64NDUNPVEbSpcshzLXZ9KIzWLaIF7E" />
    <link rel="icon" type="image/svg+xml" href="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'%3E%3Cstyle%3E text { fill: %2300ffaa; font-weight: bold; font-family: sans-serif; } %3C/style%3E%3Crect width='100%25' height='100%25' fill='%230d0d0d' rx='20'/%3E%3Ctext x='50%25' y='50%25' dominant-baseline='central' text-anchor='middle' font-size='80'%3E‚úñ%3C/text%3E%3C/svg%3E">
    
    <title>√áARPTRƒ∞K - Matematik Platformu</title>
    <meta name="theme-color" content="#121212">
    
    <style>
        :root {
            --primary: #00ffaa; --bg: #121212; --surface: #1e1e1e; --text: #ffffff;
            --text-sec: #888; --accent: #a040ff; --danger: #ff4757; --border: #333;
        }
        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; }
        body { font-family: 'Inter', sans-serif; background: var(--bg); color: var(--text); margin: 0; display: flex; flex-direction: column; min-height: 100vh; overflow-x: hidden; }
        
        /* HEADER */
        header { padding: 15px; background: rgba(30,30,30,0.9); border-bottom: 1px solid var(--border); display: flex; justify-content: center; align-items: center; position: sticky; top: 0; z-index: 50; backdrop-filter: blur(10px); }
        h1 { margin: 0; color: var(--primary); font-size: 22px; font-weight: 900; letter-spacing: 2px; }
        .lang-switch { position: absolute; right: 15px; }
        .lang-btn { background: transparent; border: 1px solid var(--border); color: var(--text-sec); padding: 4px 8px; border-radius: 6px; cursor: pointer; font-size: 11px; font-weight: bold; }
        .lang-btn.active { background: var(--primary); color: #000; border-color: var(--primary); }

        /* LAYOUT */
        .main-layout { display: grid; grid-template-columns: 1fr; gap: 20px; padding: 20px; max-width: 1200px; margin: 0 auto; width: 100%; }
        @media (min-width: 900px) { .main-layout { grid-template-columns: 260px 1fr 260px; align-items: start; } }

        /* CARDS */
        .card { background: var(--surface); border: 1px solid var(--border); border-radius: 16px; padding: 20px; display: flex; flex-direction: column; box-shadow: 0 10px 40px rgba(0,0,0,0.3); }
        .card-head { font-size: 13px; font-weight: bold; color: var(--accent); margin-bottom: 15px; text-transform: uppercase; border-bottom: 1px solid var(--border); padding-bottom: 8px; letter-spacing: 1px; }

        /* UI ELEMENTS */
        .btn { width: 100%; padding: 14px; border-radius: 10px; border: none; font-weight: 800; cursor: pointer; font-size: 14px; transition: 0.2s; text-transform: uppercase; display: flex; align-items: center; justify-content: center; gap: 8px; }
        .btn:active { transform: scale(0.98); }
        .btn-primary { background: var(--primary); color: #000; box-shadow: 0 4px 15px rgba(0,255,170,0.2); }
        .btn-racer { background: #ff9f43; color: #000; box-shadow: 0 4px 15px rgba(255, 159, 67, 0.2); }
        .btn-danger { background: rgba(255,71,87,0.1); color: var(--danger); border: 1px solid var(--danger); font-size: 12px; padding: 10px; margin-top: 10px; }
        .btn-icon { font-size: 18px; }

        .opt-row { display: flex; align-items: center; padding: 10px; background: rgba(255,255,255,0.03); border-radius: 8px; margin-bottom: 8px; cursor: pointer; border: 1px solid transparent; transition: 0.2s; }
        .opt-row:hover { background: rgba(255,255,255,0.06); }
        .opt-row input { margin-right: 10px; accent-color: var(--primary); transform: scale(1.2); }
        .opt-row span { font-size: 13px; color: #ddd; }
        .small-inp { width: 40px; background: transparent; border: none; border-bottom: 1px solid var(--primary); color: var(--primary); font-weight: bold; text-align: center; margin: 0 5px; outline: none; }

        /* NUMBER GRID */
        .num-grid { display: grid; grid-template-columns: repeat(4, 1fr); gap: 8px; margin-bottom: 15px; }
        .num-chk { display: none; }
        .num-box { background: rgba(255,255,255,0.03); padding: 12px 0; border-radius: 8px; text-align: center; font-weight: bold; cursor: pointer; border: 1px solid var(--border); color: #888; transition: 0.2s; }
        .num-chk:checked + .num-box { background: rgba(0,255,170,0.15); color: var(--primary); border-color: var(--primary); box-shadow: 0 0 10px rgba(0,255,170,0.1); }

        /* LISTS */
        .list-wrap { max-height: 350px; overflow-y: auto; }
        .list-row { display: flex; justify-content: space-between; padding: 8px 5px; border-bottom: 1px solid rgba(255,255,255,0.05); font-size: 13px; }
        .list-header { display: flex; padding: 5px; background: #252525; border-radius: 6px; font-size: 10px; color: #aaa; font-weight: bold; margin-bottom: 5px; }
        .col { flex: 1; text-align: center; }

        /* GAME CONTAINERS */
        #game-classic, #game-racer, #result-screen { display: none; width: 100%; height: 100%; flex-direction: column; }
        .active-view { display: flex !important; }

        /* CLASSIC GAME UI */
        .hud { display: flex; justify-content: space-between; background: #000; padding: 15px; border-radius: 12px; margin-bottom: 20px; border: 1px solid var(--border); }
        .hud-item { text-align: center; } .hud-lbl { font-size: 10px; color: #666; display: block; } .hud-val { font-size: 18px; font-weight: bold; color: #fff; }
        .q-area { height: 140px; display: flex; align-items: center; justify-content: center; }
        #q-text { font-size: 70px; font-weight: 900; color: #fff; line-height: 1; }
        #ans-input { width: 100%; background: #000; border: 2px solid var(--border); color: var(--primary); font-size: 40px; text-align: center; padding: 15px; border-radius: 12px; font-weight: bold; outline: none; margin-bottom: 10px; font-family: monospace; }
        #ans-input:focus { border-color: var(--primary); }
        #feedback { height: 20px; text-align: center; font-weight: bold; margin-bottom: 10px; }

        /* RACER GAME UI */
        #racer-container { position: relative; width: 100%; height: 500px; background: #222; border-radius: 16px; overflow: hidden; border: 4px solid #333; margin-bottom: 15px; }
        canvas { width: 100%; height: 100%; display: block; }
        .racer-hud { position: absolute; top: 0; left: 0; width: 100%; padding: 10px 15px; display: flex; justify-content: space-between; font-weight: bold; z-index: 5; text-shadow: 2px 2px 0 #000; pointer-events: none; }
        .racer-q-box { position: absolute; top: 60px; left: 50%; transform: translateX(-50%); background: rgba(0,0,0,0.8); border: 2px solid var(--primary); padding: 5px 20px; border-radius: 50px; font-size: 28px; font-weight: 900; color: #fff; z-index: 5; }
        .mobile-btns { display: flex; gap: 10px; }
        .m-btn { flex: 1; padding: 20px; background: rgba(255,255,255,0.1); border: 1px solid var(--border); border-radius: 12px; font-size: 24px; cursor: pointer; color: #fff; }
        .m-btn:active { background: rgba(255,255,255,0.2); }

        /* RESULT & MODAL */
        .res-val { font-size: 50px; font-weight: 900; color: var(--primary); margin: 20px 0; }
        .modal { display: none; position: fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.9); z-index:1000; justify-content:center; align-items:center; }
        .modal-box { background:var(--surface); padding:25px; border-radius:15px; width:90%; max-width:350px; text-align:center; border:1px solid var(--border); }
        .modal-btns { display:flex; gap:10px; justify-content:center; margin-top:20px; }
        .m-act { padding:10px 20px; border-radius:8px; border:none; font-weight:bold; cursor:pointer; }
        
        .blur { filter: blur(8px); opacity: 0.6; }
        .shake { animation: shake 0.4s cubic-bezier(.36,.07,.19,.97) both; }
        @keyframes shake { 10%, 90% { transform: translate3d(-2px, 0, 0); } 20%, 80% { transform: translate3d(4px, 0, 0); } 30%, 50%, 70% { transform: translate3d(-6px, 0, 0); } 40%, 60% { transform: translate3d(6px, 0, 0); } }

        footer { margin-top: auto; padding: 30px; text-align: center; font-size: 12px; color: var(--text-sec); }
        footer a { color: var(--text-sec); }
    </style>
</head>
<body>

<header>
    <h1>√áARPTRƒ∞K</h1>
    <div class="lang-switch">
        <button class="lang-btn active" id="lang-tr" onclick="setLanguage('tr')">TR</button>
        <button class="lang-btn" id="lang-en" onclick="setLanguage('en')">EN</button>
    </div>
</header>

<div class="main-layout">
    
    <div class="card">
        <div class="card-head" data-i18n="hata_listesi">HATA Lƒ∞STESƒ∞</div>
        <div id="error-list" class="list-wrap" data-i18n="liste_temiz">Liste temiz.</div>
        <div style="margin-top:15px;">
            <label class="opt-row"><input type="radio" name="errMode" value="weighted" checked><span data-i18n="puan_kadar">Puan Kadar</span></label>
            <label class="opt-row"><input type="radio" name="errMode" value="single"><span data-i18n="bir_kez">1 Kez</span></label>
        </div>
        <button class="btn-danger" onclick="resetData()" data-i18n="listeyi_temizle">TEMƒ∞ZLE</button>
    </div>

    <div class="card" style="min-height: 500px;">
        
        <div id="setup-view" class="active-view">
            <div class="card-head" data-i18n="carp_sayilar">SAYI SE√áƒ∞Mƒ∞</div>
            <div class="num-grid">
                <label><input type="checkbox" class="num-chk" value="2" checked><div class="num-box">2</div></label>
                <label><input type="checkbox" class="num-chk" value="3" checked><div class="num-box">3</div></label>
                <label><input type="checkbox" class="num-chk" value="4" checked><div class="num-box">4</div></label>
                <label><input type="checkbox" class="num-chk" value="5" checked><div class="num-box">5</div></label>
                <label><input type="checkbox" class="num-chk" value="6" checked><div class="num-box">6</div></label>
                <label><input type="checkbox" class="num-chk" value="7" checked><div class="num-box">7</div></label>
                <label><input type="checkbox" class="num-chk" value="8" checked><div class="num-box">8</div></label>
                <label><input type="checkbox" class="num-chk" value="9" checked><div class="num-box">9</div></label>
            </div>
            <div style="display:flex; gap:10px; margin-bottom:20px;">
                <button class="lang-btn" style="flex:1; border-color:var(--border);" onclick="toggleAll(true)" data-i18n="tumu">T√úM√ú</button>
                <button class="lang-btn" style="flex:1; border-color:var(--border);" onclick="toggleAll(false)" data-i18n="temizle">TEMƒ∞ZLE</button>
            </div>

            <div class="card-head" data-i18n="ayarlar">AYARLAR</div>
            <label class="opt-row"><input type="radio" name="gMode" value="repeat" checked><span><span data-i18n="mod_tekrar_1">T√ºm√ºn√º</span> <input type="number" id="inp-repeat" value="1" class="small-inp"> <span data-i18n="mod_tekrar_2">kez sor</span></span></label>
            <label class="opt-row"><input type="radio" name="gMode" value="limit"><span><span data-i18n="mod_limit_1">Rastgele</span> <input type="number" id="inp-limit" value="20" class="small-inp"> <span data-i18n="mod_limit_2">soru</span></span></label>
            
            <div style="margin-top:auto;">
                <button class="btn btn-primary" onclick="startGame('classic')"><span class="btn-icon">üìä</span> <span data-i18n="baslat_klasik">KLASƒ∞K BA≈ûLAT</span></button>
                <button class="btn btn-racer" style="margin-top:10px;" onclick="startGame('racer')"><span class="btn-icon">üèéÔ∏è</span> <span data-i18n="baslat_yaris">YARI≈û BA≈ûLAT</span></button>
                <button class="btn" style="background:var(--accent); color:#fff; margin-top:10px;" onclick="startErrorPractice()" data-i18n="hatalara_calis">HATALARA √áALI≈û</button>
            </div>
        </div>

        <div id="game-classic">
            <div class="hud">
                <div class="hud-item"><span class="hud-lbl" data-i18n="tablo_puan">PUAN</span><span class="hud-val" style="color:var(--primary);" id="c-score">100</span></div>
                <div class="hud-item"><span class="hud-lbl" data-i18n="tablo_soru">SORU</span><span class="hud-val"><span id="c-q">0</span>/<span id="c-total">0</span></span></div>
                <div class="hud-item"><span class="hud-lbl" data-i18n="tablo_hiz">HIZ</span><span class="hud-val" id="c-speed">0.0s</span></div>
            </div>
            <div class="q-area"><div id="q-text"></div></div>
            <input type="number" id="ans-input" placeholder="?" inputmode="numeric" autocomplete="off">
            <div id="feedback"></div>
            
            <div style="margin-top:auto; display:flex; gap:10px;">
                <button class="btn-danger" style="background:#333; color:#fff; border-color:#444;" onclick="pauseClassic()" data-i18n="duraklat">DURAKLAT</button>
                <button class="btn-danger" onclick="finishGameConfirm()" data-i18n="bitir">Bƒ∞Tƒ∞R</button>
            </div>
        </div>

        <div id="game-racer">
            <div id="racer-container">
                <canvas id="racerCanvas"></canvas>
                <div class="racer-hud">
                    <span style="color:var(--primary);"><span data-i18n="tablo_puan">PUAN</span>: <span id="r-score">0</span></span>
                    <span style="color:var(--danger);"><span data-i18n="can">CAN</span>: <span id="r-lives">3</span></span>
                </div>
                <div class="racer-q-box" id="r-text"></div>
            </div>
            <div style="text-align:center; color:#666; font-size:12px; margin-bottom:10px;">WASD / OK TU≈ûLARI</div>
            
            <div class="mobile-btns">
                <button class="m-btn" ontouchstart="moveRacer(-1)" onmousedown="moveRacer(-1)">‚¨ÖÔ∏è</button>
                <button class="m-btn" ontouchstart="moveRacer(1)" onmousedown="moveRacer(1)">‚û°Ô∏è</button>
            </div>
            <button class="btn-danger" style="margin-top:auto;" onclick="finishGameConfirm()" data-i18n="bitir">Bƒ∞Tƒ∞R</button>
        </div>

        <div id="result-screen" style="text-align:center; justify-content:center;">
            <div class="card-head" style="border:none; font-size:18px;" data-i18n="seans_bitti">SEANS Bƒ∞TTƒ∞</div>
            <div class="res-val" id="res-score">0</div>
            <div style="display:flex; justify-content:center; gap:20px; margin-bottom:30px;">
                <div><span style="display:block; font-size:10px; color:#888;" data-i18n="tablo_hiz">HIZ</span><span style="font-weight:bold; font-size:18px;" id="res-speed">0.0s</span></div>
                <div><span style="display:block; font-size:10px; color:#888;" data-i18n="tablo_hata">HATA</span><span style="font-weight:bold; font-size:18px; color:var(--danger);" id="res-err">0</span></div>
            </div>
            <button class="btn btn-primary" onclick="showSetup()" data-i18n="tamam_btn">TAMAM</button>
        </div>

    </div>

    <div class="card">
        <div class="card-head" data-i18n="gecmis_skorlar">GE√áMƒ∞≈û</div>
        <div class="list-header">
            <span class="col" data-i18n="tablo_puan">PUAN</span>
            <span class="col" data-i18n="tablo_hiz">HIZ</span>
            <span class="col" data-i18n="tablo_hata">HATA</span>
            <span class="col" data-i18n="tablo_soru">SORU</span>
        </div>
        <div id="history-list" class="list-wrap" data-i18n="gecmis_yok">Kayƒ±t yok.</div>
        <button class="btn-danger" onclick="clearHistory()" data-i18n="gecmisi_sil">Sƒ∞L</button>
    </div>

</div>

<div id="mainModal" class="modal">
    <div class="modal-box">
        <div style="font-size:16px; margin-bottom:20px;" id="modalMsg">...</div>
        <div class="modal-btns" id="modalActions"></div>
    </div>
</div>

<footer>
    <div>¬© 2026 √áarptrik.</div>
    <div style="margin-top:5px;"><span data-i18n="iletisim_text">√ñneri:</span> <a href="mailto:carptrik@gmail.com">carptrik@gmail.com</a></div>
</footer>

<script>
/* ================= STATE ================= */
const state = {
    lang: 'tr',
    gameType: null, // 'classic' or 'racer'
    db: JSON.parse(localStorage.getItem('carptrik_data')) || {},
    history: JSON.parse(localStorage.getItem('carptrik_history')) || [],
    qList: [],
    totalQ: 0,
    currIdx: 0,
    score: 100,
    errors: 0,
    times: [],
    startTime: 0,
    pauseTime: 0,
    currQ: null,
    paused: false,
    // Racer specific
    racer: { loop: null, lane: 1, currentX: 0, cars: [], particles: [], lives: 3, speed: 5, changingQ: false }
};

const text = {
    tr: {
        alert_sayi_sec: "L√ºtfen sayƒ± se√ßin!", alert_hata_yok: "Listeniz temiz!", confirm_bitir: "Bitirmek istiyor musun?", confirm_sil: "Silmek istiyor musun?",
        dogru: "DOƒûRU!", yanlis: "YANLI≈û!", yavas: "YAVA≈û!", hata_listesi: "HATA Lƒ∞STESƒ∞", liste_temiz: "Temiz.", hata_tekrar: "HATA TEKRARI",
        hatalara_calis: "HATALARA √áALI≈û", listeyi_temizle: "TEMƒ∞ZLE", carp_sayilar: "SAYI SE√áƒ∞Mƒ∞", ayarlar: "AYARLAR",
        baslat_klasik: "KLASƒ∞K BA≈ûLAT", baslat_yaris: "YARI≈û BA≈ûLAT", seans_bitti: "SEANS Bƒ∞TTƒ∞",
        gecmis_skorlar: "GE√áMƒ∞≈û", gecmis_yok: "Bo≈ü.", gecmisi_sil: "Sƒ∞L", iletisim_text: "ƒ∞leti≈üim:",
        puan_kadar: "Puan Kadar", bir_kez: "1 Kez", tumu: "T√úM√ú", temizle: "TEMƒ∞ZLE", mod_tekrar_1: "T√ºm√ºn√º", mod_tekrar_2: "kez", mod_limit_1: "Rastgele", mod_limit_2: "soru",
        tablo_puan: "PUAN", tablo_soru: "SORU", tablo_hiz: "HIZ", tablo_hata: "HATA", duraklat: "DURAKLAT", bitir: "Bƒ∞Tƒ∞R", tamam_btn: "TAMAM",
        modal_tamam: "TAMAM", modal_evet: "EVET", modal_iptal: "ƒ∞PTAL", can: "CAN"
    },
    en: {
        alert_sayi_sec: "Select numbers!", alert_hata_yok: "List clean!", confirm_bitir: "Finish game?", confirm_sil: "Delete all?",
        dogru: "CORRECT!", yanlis: "WRONG!", yavas: "SLOW!", hata_listesi: "ERRORS", liste_temiz: "Clean.", hata_tekrar: "ERROR MODE",
        hatalara_calis: "PRACTICE", listeyi_temizle: "CLEAR", carp_sayilar: "NUMBERS", ayarlar: "SETTINGS",
        baslat_klasik: "START CLASSIC", baslat_yaris: "START RACER", seans_bitti: "DONE",
        gecmis_skorlar: "HISTORY", gecmis_yok: "Empty.", gecmisi_sil: "CLEAR", iletisim_text: "Contact:",
        puan_kadar: "By Score", bir_kez: "Once", tumu: "ALL", temizle: "CLEAR", mod_tekrar_1: "All", mod_tekrar_2: "times", mod_limit_1: "Random", mod_limit_2: "qs",
        tablo_puan: "SCORE", tablo_soru: "Q", tablo_hiz: "SPD", tablo_hata: "ERR", duraklat: "PAUSE", bitir: "END", tamam_btn: "OK",
        modal_tamam: "OK", modal_evet: "YES", modal_iptal: "CANCEL", can: "HP"
    }
};

/* ================= INIT & UTILS ================= */
function init() {
    const s = localStorage.getItem('carptrik_lang');
    if (s) state.lang = s;
    setLanguage(state.lang);
}

function setLanguage(l) {
    state.lang = l;
    localStorage.setItem('carptrik_lang', l);
    document.querySelectorAll('.lang-btn').forEach(b => b.classList.remove('active'));
    document.getElementById('lang-'+l).classList.add('active');
    document.querySelectorAll('[data-i18n]').forEach(el => {
        const k = el.getAttribute('data-i18n');
        if(text[l][k]) el.innerText = text[l][k];
    });
    updateLists();
}

function switchView(id) {
    document.querySelectorAll('.active-view').forEach(e => e.classList.remove('active-view'));
    document.getElementById(id).classList.add('active-view');
}

function modal(msg, onYes) {
    const m = document.getElementById('mainModal');
    document.getElementById('modalMsg').innerText = msg;
    const acts = document.getElementById('modalActions');
    if(onYes) {
        acts.innerHTML = `<button class="m-act btn-primary" onclick="runYes()">${text[state.lang].modal_evet}</button><button class="m-act btn-danger" onclick="closeModal()">${text[state.lang].modal_iptal}</button>`;
        window.runYes = () => { onYes(); closeModal(); };
    } else {
        acts.innerHTML = `<button class="m-act btn-primary" onclick="closeModal()">${text[state.lang].modal_tamam}</button>`;
    }
    m.style.display = 'flex';
}
function closeModal() { document.getElementById('mainModal').style.display = 'none'; }

function toggleAll(val) { document.querySelectorAll('.num-chk').forEach(c => c.checked = val); }
function getNums() { return Array.from(document.querySelectorAll('.num-chk:checked')).map(c => parseInt(c.value)); }

/* ================= GAME LOGIC ================= */
function prepareQuestions() {
    const nums = getNums();
    if(nums.length === 0) return null;
    
    let list = [];
    let pool = [];
    nums.forEach(n1 => { nums.forEach(n2 => pool.push({n1, n2})); });
    
    const mode = document.querySelector('input[name="gMode"]:checked').value;
    if(mode === 'repeat') {
        const cnt = parseInt(document.getElementById('inp-repeat').value) || 1;
        for(let i=0; i<cnt; i++) list.push(...pool);
    } else {
        const lim = parseInt(document.getElementById('inp-limit').value) || 20;
        for(let i=0; i<lim; i++) list.push(pool[Math.floor(Math.random()*pool.length)]);
    }
    return list.sort(()=>Math.random()-0.5);
}

function startGame(type) {
    const q = prepareQuestions();
    if(!q) return modal(text[state.lang].alert_sayi_sec);
    
    // Reset Shared State
    state.gameType = type;
    state.qList = q;
    state.totalQ = q.length;
    state.currIdx = 0;
    state.score = 100;
    state.errors = 0;
    state.times = [];
    state.paused = false;

    if(type === 'classic') {
        switchView('game-classic');
        nextQClassic();
    } else {
        switchView('game-racer');
        startRacerEngine();
    }
}

function startErrorPractice() {
    const keys = Object.keys(state.db);
    if(keys.length === 0) return modal(text[state.lang].alert_hata_yok);
    
    let list = [];
    const mode = document.querySelector('input[name="errMode"]:checked').value;
    keys.forEach(k => {
        const [n1, n2] = k.split('x').map(Number);
        const c = mode === 'single' ? 1 : state.db[k].score;
        for(let i=0; i<c; i++) list.push({n1,n2});
    });
    list.sort(()=>Math.random()-0.5);
    
    state.gameType = 'classic'; // Error practice is always classic for now
    state.qList = list;
    state.totalQ = list.length;
    state.currIdx = 0; state.score = 100; state.errors = 0; state.times = [];
    switchView('game-classic');
    nextQClassic();
}

function finishGameConfirm() { modal(text[state.lang].confirm_bitir, finishGame); }

function finishGame() {
    if(state.racer.loop) cancelAnimationFrame(state.racer.loop);
    
    // Proportional Score
    if(state.totalQ > 0 && state.currIdx < state.totalQ) {
        state.score = Math.round(state.score * (state.currIdx / state.totalQ));
    }
    const avg = state.times.length ? (state.times.reduce((a,b)=>a+b,0)/state.times.length).toFixed(2) : "0.0";
    
    // Save
    state.history.unshift({score:state.score, speed:avg, errors:state.errors, q:state.currIdx, date:new Date().toLocaleTimeString([],{hour:'2-digit',minute:'2-digit'})});
    if(state.history.length > 20) state.history.pop();
    localStorage.setItem('carptrik_history', JSON.stringify(state.history));
    updateLists();

    // Show UI
    document.getElementById('res-score').innerText = state.score;
    document.getElementById('res-speed').innerText = avg + 's';
    document.getElementById('res-err').innerText = state.errors;
    switchView('result-screen');
}

function showSetup() { switchView('setup-view'); }

/* ================= CLASSIC SPECIFIC ================= */
function nextQClassic() {
    if(state.currIdx >= state.totalQ) return finishGame();
    state.currQ = state.qList[state.currIdx];
    
    document.getElementById('q-text').innerText = `${state.currQ.n1} x ${state.currQ.n2}`;
    document.getElementById('c-q').innerText = state.currIdx + 1;
    document.getElementById('c-total').innerText = state.totalQ;
    document.getElementById('c-score').innerText = state.score;
    document.getElementById('feedback').innerText = "";
    
    const inp = document.getElementById('ans-input');
    inp.value = ''; inp.disabled = false; inp.focus();
    state.startTime = Date.now();
}

document.getElementById('ans-input').addEventListener('input', function() {
    const ans = state.currQ.n1 * state.currQ.n2;
    if(this.value.length >= ans.toString().length) {
        const val = parseInt(this.value);
        const time = (Date.now() - state.startTime) / 1000;
        const k = `${state.currQ.n1}x${state.currQ.n2}`;
        if(!state.db[k]) state.db[k] = {score: 0};
        
        const fb = document.getElementById('feedback');
        if(val === ans) {
            state.times.push(time);
            fb.innerText = text[state.lang].dogru; fb.style.color = 'var(--primary)';
            if(state.db[k].score > 0) state.db[k].score--;
            const avg = state.times.reduce((a,b)=>a+b,0) / state.times.length;
            document.getElementById('c-speed').innerText = avg.toFixed(1) + 's';
            state.currIdx++;
            setTimeout(nextQClassic, 500);
        } else {
            fb.innerText = text[state.lang].yanlis; fb.style.color = 'var(--danger)';
            state.db[k].score += 2;
            state.score = Math.max(0, state.score - 5);
            state.errors++;
            setTimeout(nextQClassic, 1000);
        }
        if(state.db[k].score <= 0) delete state.db[k];
        saveDB();
    }
});

function pauseClassic() {
    state.paused = true; document.getElementById('q-text').classList.add('blur');
    document.getElementById('ans-input').disabled=true;
    state.pauseTime = Date.now();
    modal(text[state.lang].duraklat, () => {
        state.paused = false; document.getElementById('q-text').classList.remove('blur');
        document.getElementById('ans-input').disabled=false; document.getElementById('ans-input').focus();
        state.startTime += (Date.now() - state.pauseTime);
    });
}

/* ================= RACER SPECIFIC ================= */
function startRacerEngine() {
    state.racer.lives = 3;
    state.racer.speed = 5;
    state.racer.cars = [];
    state.racer.particles = [];
    state.racer.lane = 1;
    state.racer.changingQ = false;
    
    // Canvas sizing
    const c = document.getElementById('racerCanvas');
    const box = document.getElementById('racer-container');
    c.width = box.offsetWidth; c.height = box.offsetHeight;
    state.racer.currentX = (1 * (c.width/4)) + (c.width/8);
    
    updateRacerHUD();
    spawnRacerQ();
    state.racer.loop = requestAnimationFrame(racerLoop);
}

function spawnRacerQ() {
    if(state.currIdx >= state.totalQ) { finishGame(); return; }
    
    state.currQ = state.qList[state.currIdx];
    document.getElementById('r-text').innerText = `${state.currQ.n1} x ${state.currQ.n2}`;
    state.startTime = Date.now();
    state.racer.changingQ = false;

    const ans = state.currQ.n1 * state.currQ.n2;
    let opts = [ans];
    while(opts.length<4) {
        let f = ans + (Math.floor(Math.random()*10)-5);
        if(f>0 && f!==ans && !opts.includes(f)) opts.push(f);
    }
    opts.sort(()=>Math.random()-0.5);

    state.racer.cars = [];
    for(let i=0; i<4; i++) {
        state.racer.cars.push({
            lane: i, y: -250 - (Math.random()*100), val: opts[i], isCorrect: opts[i]===ans,
            color: opts[i]===ans ? '#ffaa00' : ['#ff4757','#2ed573','#1e90ff'][Math.floor(Math.random()*3)]
        });
    }
}

function racerLoop() {
    if(state.gameType !== 'racer') return;
    const cvs = document.getElementById('racerCanvas');
    const ctx = cvs.getContext('2d');
    const lw = cvs.width/4;

    ctx.clearRect(0,0,cvs.width,cvs.height);
    
    // Road
    ctx.fillStyle = "#222"; ctx.fillRect(0,0,cvs.width,cvs.height);
    ctx.strokeStyle = "#444"; ctx.setLineDash([20,20]); ctx.lineWidth=2;
    for(let i=1; i<4; i++) { ctx.beginPath(); ctx.moveTo(i*lw,0); ctx.lineTo(i*lw,cvs.height); ctx.stroke(); }

    // Player (Lerp)
    const targetX = (state.racer.lane * lw) + (lw/2);
    state.racer.currentX += (targetX - state.racer.currentX) * 0.15;
    const pX = state.racer.currentX; const pY = cvs.height - 100;
    
    ctx.fillStyle = "#00ffaa"; ctx.fillRect(pX-20, pY, 40, 70);
    ctx.fillStyle = "rgba(0,255,170,0.3)"; ctx.beginPath(); ctx.moveTo(pX-15,pY); ctx.lineTo(pX-40,pY-120); ctx.lineTo(pX+40,pY-120); ctx.lineTo(pX+15,pY); ctx.fill();

    // Cars & Collision
    if(!state.racer.changingQ) {
        for(let i=state.racer.cars.length-1; i>=0; i--) {
            let c = state.racer.cars[i];
            c.y += state.racer.speed;
            const cX = (c.lane * lw) + (lw/2);
            
            ctx.fillStyle = c.color; ctx.fillRect(cX-20, c.y, 40, 70);
            ctx.fillStyle = "#fff"; ctx.font="bold 20px Arial"; ctx.textAlign="center"; ctx.fillText(c.val, cX, c.y+45);

            // Hit Check
            if(c.y+70 > pY && c.y < pY+70 && Math.abs(pX - cX) < 35) {
                if(c.isCorrect) {
                    // Correct
                    state.times.push((Date.now()-state.startTime)/1000);
                    state.racer.speed += 0.2;
                    explode(cX, c.y, '#fff');
                    state.currIdx++;
                    state.racer.changingQ = true;
                    state.racer.cars = []; // Clear
                    setTimeout(spawnRacerQ, 800);
                } else {
                    // Wrong
                    state.racer.lives--;
                    state.score = Math.max(0, state.score - 5);
                    state.errors++;
                    shakeRacer();
                    state.racer.cars.splice(i, 1);
                    if(state.racer.lives <= 0) finishGame();
                }
                updateRacerHUD();
            } else if (c.y > cvs.height) {
                state.racer.cars.splice(i, 1);
                // If correct missed, respawn same question
                if(c.isCorrect && state.racer.cars.length === 0) spawnRacerQ();
            }
        }
    }

    // Particles
    for(let i=state.racer.particles.length-1; i>=0; i--) {
        let p = state.racer.particles[i];
        p.x+=p.vx; p.y+=p.vy; p.life--;
        ctx.fillStyle=p.color; ctx.fillRect(p.x,p.y,p.s,p.s);
        if(p.life<=0) state.racer.particles.splice(i,1);
    }

    state.racer.loop = requestAnimationFrame(racerLoop);
}

function moveRacer(d) {
    let n = state.racer.lane + d;
    if(n>=0 && n<=3) state.racer.lane = n;
}
window.addEventListener('keydown', e => {
    if(state.gameType==='racer') {
        if(e.key==='a'||e.key==='ArrowLeft') moveRacer(-1);
        if(e.key==='d'||e.key==='ArrowRight') moveRacer(1);
    }
});

function explode(x,y,c) {
    for(let i=0;i<20;i++) state.racer.particles.push({x:x,y:y,vx:(Math.random()-0.5)*12,vy:(Math.random()-0.5)*12,life:40,s:Math.random()*6+2,color:c});
}
function shakeRacer() {
    const el = document.getElementById('racer-container');
    el.classList.remove('shake'); void el.offsetWidth; el.classList.add('shake');
}
function updateRacerHUD() {
    document.getElementById('r-score').innerText = state.score;
    document.getElementById('r-lives').innerText = state.racer.lives;
}

/* ================= DATA ================= */
function saveDB() { localStorage.setItem('carptrik_data', JSON.stringify(state.db)); updateLists(); }
function resetData() { modal(text[state.lang].confirm_sil, () => { state.db = {}; saveDB(); }); }
function clearHistory() { modal(text[state.lang].confirm_sil, () => { state.history = []; localStorage.setItem('carptrik_history', JSON.stringify([])); updateLists(); }); }

function updateLists() {
    // Errors
    const el = document.getElementById('error-list');
    if(Object.keys(state.db).length===0) el.innerHTML=`<div style="text-align:center;color:#555;padding:10px;">${text[state.lang].liste_temiz}</div>`;
    else {
        let h = "";
        Object.keys(state.db).sort((a,b)=>state.db[b].score-state.db[a].score).forEach(k=>{
            h+=`<div class="list-row"><span>${k}</span><b>+${state.db[k].score}</b></div>`;
        });
        el.innerHTML=h;
    }
    // History
    const hl = document.getElementById('history-list');
    if(state.history.length===0) hl.innerHTML=`<div style="text-align:center;color:#555;padding:10px;">${text[state.lang].gecmis_yok}</div>`;
    else {
        let h="";
        state.history.forEach(i=>{
            h+=`<div class="list-row"><b class="col">${i.score}</b><span class="col">${i.speed}s</span><span class="col" style="color:${i.errors>0?'var(--danger)':'#666'}">${i.errors}</span><span class="col" style="color:#666">${i.q}</span></div>`;
        });
        hl.innerHTML=h;
    }
}

init();
</script>
</body>
</html>
