<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    
    <meta name="google-site-verification" content="DbvwD_t2D1ABQ64NDUNPVEbSpcshzLXZ9KIzWLaIF7E" />
    
    <link rel="icon" type="image/svg+xml" href="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'%3E%3Cstyle%3E text { fill: %2300ffaa; font-weight: bold; font-family: sans-serif; } %3C/style%3E%3Crect width='100%25' height='100%25' fill='%230d0d0d' rx='20'/%3E%3Ctext x='50%25' y='50%25' dominant-baseline='central' text-anchor='middle' font-size='80'%3E‚úñ%3C/text%3E%3C/svg%3E">
    
    <title>√áARPTRƒ∞K - Matematik Oyunlarƒ±</title>
    <meta name="description" content="√áarpƒ±m tablosunu oyunla √∂ƒüren. Klasik mod ve Araba Yarƒ±≈üƒ± modu ile matematik antrenmanƒ±.">
    <meta name="theme-color" content="#121212">
    
    <style>
        :root {
            --primary: #00ffaa;
            --bg: #121212;
            --surface: #1e1e1e;
            --text: #ffffff;
            --text-secondary: #aaaaaa;
            --accent: #a040ff;
            --danger: #ff4757;
            --border: #333;
        }
        
        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; }

        body { 
            font-family: 'Inter', system-ui, -apple-system, sans-serif; 
            background-color: var(--bg); color: var(--text); 
            margin: 0; padding: 0;
            display: flex; flex-direction: column; align-items: center; 
            min-height: 100vh;
        }

        /* --- HEADER & NAV --- */
        header { width: 100%; padding: 20px; text-align: center; background: rgba(30,30,30,0.8); backdrop-filter: blur(10px); position: sticky; top: 0; z-index: 100; border-bottom: 1px solid var(--border); }
        h1 { margin: 0; color: var(--primary); font-size: 24px; letter-spacing: 2px; text-transform: uppercase; font-weight: 900; text-shadow: 0 0 15px rgba(0, 255, 170, 0.4); }
        
        /* Language Switcher */
        .lang-switch { position: absolute; top: 20px; right: 20px; }
        .lang-btn { background: transparent; border: 1px solid var(--border); color: var(--text-secondary); padding: 5px 10px; border-radius: 6px; cursor: pointer; font-size: 12px; font-weight: bold; }
        .lang-btn.active { background: var(--primary); color: #000; border-color: var(--primary); }

        /* --- MODE TABS --- */
        .mode-tabs { display: flex; justify-content: center; gap: 15px; margin: 20px 0; padding: 0 15px; }
        .tab-btn {
            background: var(--surface); border: 1px solid var(--border); color: var(--text-secondary);
            padding: 12px 25px; border-radius: 12px; cursor: pointer;
            font-size: 14px; font-weight: bold; transition: 0.3s;
            display: flex; align-items: center; gap: 8px;
        }
        .tab-btn:hover { border-color: var(--primary); color: #fff; }
        .tab-btn.active { background: var(--primary); color: #000; border-color: var(--primary); box-shadow: 0 0 20px rgba(0,255,170,0.3); }

        /* --- MAIN LAYOUT --- */
        .app-container {
            width: 100%; max-width: 1200px; padding: 20px;
            display: grid; gap: 20px;
            /* Default: Tek s√ºtun (Mobile first) */
            grid-template-columns: 1fr;
        }
        /* Desktop Layout */
        @media (min-width: 900px) {
            .app-container.classic-layout { grid-template-columns: 280px 1fr 280px; }
            .app-container.racer-layout { grid-template-columns: 1fr; max-width: 600px; }
        }

        /* --- CARDS --- */
        .card { background: var(--surface); border-radius: 16px; border: 1px solid var(--border); padding: 20px; box-shadow: 0 10px 30px rgba(0,0,0,0.3); display: flex; flex-direction: column; }
        .card-title { color: var(--accent); font-size: 14px; font-weight: bold; margin-bottom: 15px; text-transform: uppercase; letter-spacing: 1px; border-bottom: 1px solid var(--border); padding-bottom: 10px; }

        /* --- COMMON UI ELEMENTS --- */
        .btn-primary { background: var(--primary); color: #000; width: 100%; padding: 15px; border-radius: 12px; border: none; font-weight: 900; cursor: pointer; font-size: 16px; transition: 0.2s; text-transform: uppercase; margin-top: 15px; }
        .btn-primary:active { transform: scale(0.98); }
        
        .btn-danger { background: rgba(255, 71, 87, 0.1); color: var(--danger); border: 1px solid var(--danger); width: 100%; padding: 10px; border-radius: 8px; font-weight: bold; cursor: pointer; font-size: 12px; margin-top: 10px; }
        
        /* Input & Radios */
        .option-row { display: flex; align-items: center; padding: 10px; background: rgba(255,255,255,0.05); border-radius: 8px; margin-bottom: 8px; cursor: pointer; }
        .option-row input { margin-right: 10px; accent-color: var(--primary); transform: scale(1.2); }
        .option-row span { font-size: 14px; color: var(--text); }
        
        /* Number Grid */
        .num-grid { display: grid; grid-template-columns: repeat(4, 1fr); gap: 8px; margin-bottom: 20px; }
        .num-chk { display: none; }
        .num-box { background: rgba(255,255,255,0.05); padding: 15px 0; border-radius: 8px; text-align: center; font-weight: bold; cursor: pointer; border: 2px solid transparent; transition: 0.2s; }
        .num-chk:checked + .num-box { background: rgba(0, 255, 170, 0.15); color: var(--primary); border-color: var(--primary); }

        /* --- GAME UI (CLASSIC) --- */
        .game-header { display: flex; justify-content: space-between; background: #000; padding: 15px; border-radius: 12px; margin-bottom: 20px; border: 1px solid var(--border); }
        .stat-item { text-align: center; }
        .stat-label { font-size: 10px; color: var(--text-secondary); display: block; margin-bottom: 2px; }
        .stat-val { font-size: 16px; font-weight: bold; color: #fff; }
        
        .question-area { position: relative; height: 120px; display: flex; align-items: center; justify-content: center; margin-bottom: 20px; }
        #question-text { font-size: 80px; font-weight: 900; color: #fff; line-height: 1; }
        .blur { filter: blur(10px); opacity: 0.5; }
        
        #answer-input { 
            width: 100%; background: #000; border: 2px solid var(--border); color: var(--primary); 
            font-size: 40px; text-align: center; padding: 15px; border-radius: 12px; font-weight: bold; outline: none; font-family: monospace;
        }
        #answer-input:focus { border-color: var(--primary); }
        #feedback { height: 30px; margin-top: 10px; font-weight: bold; font-size: 18px; text-align: center; }

        /* --- RACER MODE UI --- */
        #racer-area { position: relative; width: 100%; height: 500px; background: #222; border-radius: 16px; overflow: hidden; border: 4px solid #333; }
        canvas { width: 100%; height: 100%; display: block; }
        .racer-overlay { position: absolute; top: 0; left: 0; width: 100%; padding: 15px; display: flex; justify-content: space-between; font-weight: bold; pointer-events: none; }
        .racer-score { color: var(--primary); font-size: 18px; text-shadow: 2px 2px 0 #000; }
        .racer-lives { color: var(--danger); font-size: 18px; text-shadow: 2px 2px 0 #000; }
        .racer-question { position: absolute; top: 60px; left: 50%; transform: translateX(-50%); background: rgba(0,0,0,0.8); border: 2px solid var(--primary); padding: 5px 20px; border-radius: 20px; font-size: 24px; font-weight: 900; color: #fff; }
        
        .mobile-controls { display: none; gap: 20px; margin-top: 15px; width: 100%; }
        .control-btn { flex: 1; padding: 20px; background: rgba(255,255,255,0.1); border: 1px solid var(--border); border-radius: 12px; color: #fff; font-size: 24px; cursor: pointer; touch-action: manipulation; }
        @media (max-width: 900px) { .mobile-controls { display: flex; } }

        /* --- LISTS --- */
        .list-container { max-height: 300px; overflow-y: auto; }
        .list-row { display: flex; justify-content: space-between; padding: 10px 0; border-bottom: 1px solid rgba(255,255,255,0.1); font-size: 13px; }
        .list-row b { color: var(--primary); }

        /* --- MODAL --- */
        .modal { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.9); z-index: 1000; justify-content: center; align-items: center; }
        .modal-content { background: var(--surface); padding: 30px; border-radius: 20px; border: 1px solid var(--border); width: 90%; max-width: 400px; text-align: center; }
        .modal-text { margin-bottom: 20px; font-size: 18px; line-height: 1.5; }
        .modal-actions { display: flex; gap: 10px; justify-content: center; }
        .modal-btn { padding: 10px 20px; border-radius: 8px; border: none; font-weight: bold; cursor: pointer; }
        .btn-confirm { background: var(--primary); color: #000; }
        .btn-cancel { background: #333; color: #fff; }

        /* --- FOOTER --- */
        footer { margin-top: auto; padding: 30px 0; text-align: center; font-size: 12px; color: var(--text-secondary); width: 100%; }
        footer a { color: var(--text-secondary); text-decoration: none; }
        footer a:hover { color: #fff; text-decoration: underline; }

        /* --- UTILS --- */
        .hidden { display: none !important; }
        .shake { animation: shake 0.5s; border-color: var(--danger) !important; }
        @keyframes shake { 0%, 100% {transform: translateX(0);} 25% {transform: translateX(-5px);} 75% {transform: translateX(5px);} }
    </style>
</head>
<body>

<header>
    <h1>√áARPTRƒ∞K</h1>
    <div class="lang-switch">
        <button class="lang-btn active" id="lang-tr" onclick="setLanguage('tr')">TR</button>
        <button class="lang-btn" id="lang-en" onclick="setLanguage('en')">EN</button>
    </div>
</header>

<div class="mode-tabs">
    <button class="tab-btn active" id="tab-classic" onclick="setMode('classic')">
        üìä KLASƒ∞K
    </button>
    <button class="tab-btn" id="tab-racer" onclick="setMode('racer')">
        üèéÔ∏è YARI≈û
    </button>
</div>

<div id="view-classic" class="app-container classic-layout">
    
    <div class="card" id="card-errors">
        <div class="card-title" data-i18n="hata_listesi">HATA Lƒ∞STESƒ∞</div>
        <div id="error-list" class="list-container" data-i18n="liste_temiz">Liste temiz.</div>
        
        <div style="margin-top: 20px;">
            <div style="font-size: 11px; color: var(--text-secondary); margin-bottom: 5px;" data-i18n="hata_tekrar">HATA TEKRARI</div>
            <label class="option-row">
                <input type="radio" name="errorMode" value="weighted" checked> <span>Puan Kadar</span>
            </label>
            <label class="option-row">
                <input type="radio" name="errorMode" value="single"> <span>1 Kez</span>
            </label>
        </div>

        <button class="btn-primary" style="background:var(--accent); color:#fff;" onclick="startErrorPractice()" data-i18n="hatalara_calis">HATALARA √áALI≈û</button>
        <button class="btn-danger" onclick="resetData()" data-i18n="listeyi_temizle">Lƒ∞STEYƒ∞ TEMƒ∞ZLE</button>
    </div>

    <div class="card" id="card-game">
        <div id="classic-setup">
            <div class="card-title" data-i18n="carp_sayilar">SAYI SE√áƒ∞Mƒ∞</div>
            <div class="num-grid">
                <label><input type="checkbox" class="num-chk" value="2" checked><div class="num-box">2</div></label>
                <label><input type="checkbox" class="num-chk" value="3" checked><div class="num-box">3</div></label>
                <label><input type="checkbox" class="num-chk" value="4" checked><div class="num-box">4</div></label>
                <label><input type="checkbox" class="num-chk" value="5" checked><div class="num-box">5</div></label>
                <label><input type="checkbox" class="num-chk" value="6" checked><div class="num-box">6</div></label>
                <label><input type="checkbox" class="num-chk" value="7" checked><div class="num-box">7</div></label>
                <label><input type="checkbox" class="num-chk" value="8" checked><div class="num-box">8</div></label>
                <label><input type="checkbox" class="num-chk" value="9" checked><div class="num-box">9</div></label>
            </div>
            
            <div style="display:flex; gap:10px; margin-bottom:20px;">
                <button class="lang-btn" onclick="toggleAll(true)" style="flex:1">T√úM√ú</button>
                <button class="lang-btn" onclick="toggleAll(false)" style="flex:1">TEMƒ∞ZLE</button>
            </div>

            <div class="card-title" data-i18n="oyun_modu">OYUN MODU</div>
            <label class="option-row">
                <input type="radio" name="gameMode" value="repeat" checked>
                <span>T√ºm√ºn√º <input type="number" id="inp-repeat" value="1" style="width:40px; background:transparent; border:none; color:var(--primary); font-weight:bold;"> kez sor</span>
            </label>
            <label class="option-row">
                <input type="radio" name="gameMode" value="limit">
                <span>Rastgele <input type="number" id="inp-limit" value="20" style="width:40px; background:transparent; border:none; color:var(--primary); font-weight:bold;"> soru</span>
            </label>

            <button class="btn-primary" onclick="startClassic()" data-i18n="baslat">BA≈ûLAT</button>
        </div>

        <div id="classic-play" class="hidden">
            <div class="game-header">
                <div class="stat-item"><span class="stat-label">PUAN</span><span class="stat-val" style="color:var(--primary); font-size:20px;" id="disp-score">100</span></div>
                <div class="stat-item"><span class="stat-label">SORU</span><span class="stat-val"><span id="disp-q">0</span>/<span id="disp-total">0</span></span></div>
                <div class="stat-item"><span class="stat-label">HIZ</span><span class="stat-val" id="disp-speed">0.0s</span></div>
            </div>

            <div class="question-area">
                <div id="question-text">2 x 2</div>
            </div>

            <input type="number" id="answer-input" placeholder="?" inputmode="numeric" autocomplete="off">
            <div id="feedback"></div>

            <div style="display:flex; gap:10px; margin-top:20px;">
                <button class="btn-danger" style="background:#333; border-color:#444; color:#fff;" onclick="pauseGame()">DURAKLAT</button>
                <button class="btn-danger" onclick="finishGameConfirm()">Bƒ∞Tƒ∞R</button>
            </div>
        </div>

        <div id="classic-result" class="hidden" style="text-align:center;">
            <div class="card-title" style="border:none; font-size:24px;">SEANS Bƒ∞TTƒ∞</div>
            <div style="font-size:60px; font-weight:900; color:var(--primary); margin:20px 0;" id="final-score">100</div>
            
            <div style="display:grid; grid-template-columns:1fr 1fr; gap:10px; margin-bottom:20px;">
                <div style="background:#222; padding:10px; border-radius:8px;">
                    <div style="font-size:10px; color:#888;">HIZ</div>
                    <div style="font-size:18px; font-weight:bold;" id="final-speed">0.0s</div>
                </div>
                <div style="background:#222; padding:10px; border-radius:8px;">
                    <div style="font-size:10px; color:#888;">HATA</div>
                    <div style="font-size:18px; font-weight:bold; color:var(--danger);" id="final-errors">0</div>
                </div>
            </div>

            <button class="btn-primary" onclick="backToSetup()">TAMAM</button>
        </div>
    </div>

    <div class="card" id="card-history">
        <div class="card-title" data-i18n="gecmis_skorlar">GE√áMƒ∞≈û</div>
        <div style="display:flex; font-size:10px; color:#666; font-weight:bold; padding-bottom:5px; border-bottom:1px solid #333; margin-bottom:5px;">
            <span style="flex:1; text-align:center;">PUAN</span>
            <span style="flex:1; text-align:center;">HIZ</span>
            <span style="flex:1; text-align:center;">HATA</span>
            <span style="flex:1; text-align:center;">SORU</span>
        </div>
        <div id="history-list" class="list-container" data-i18n="gecmis_yok">Kayƒ±t yok.</div>
        <button class="btn-danger" onclick="clearHistory()" data-i18n="gecmisi_sil">Sƒ∞L</button>
    </div>
</div>

<div id="view-racer" class="app-container racer-layout hidden">
    <div class="card" style="padding:0; border:none; background:transparent; box-shadow:none;">
        <div id="racer-area">
            <canvas id="racerCanvas"></canvas>
            <div class="racer-overlay">
                <span class="racer-score">PUAN: <span id="r-score">0</span></span>
                <span class="racer-lives">CAN: <span id="r-lives">3</span></span>
            </div>
            <div class="racer-question" id="r-question">HAZIR?</div>
            
            <div id="racer-menu" style="position:absolute; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.85); display:flex; flex-direction:column; align-items:center; justify-content:center; z-index:10;">
                <h1 style="font-size:32px; margin-bottom:10px;">YARI≈û MODU</h1>
                <p style="color:#aaa; text-align:center; padding:0 20px;">Arabayƒ± y√∂nlendir, doƒüru cevaba √ßarp!<br>Yanlƒ±≈ü cevap can g√∂t√ºr√ºr.</p>
                <button class="btn-primary" style="width:200px;" onclick="startRacer()">BA≈ûLA</button>
            </div>

            <div id="racer-over" style="position:absolute; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.9); display:none; flex-direction:column; align-items:center; justify-content:center; z-index:11;">
                <h1 style="color:var(--danger);">OYUN Bƒ∞TTƒ∞</h1>
                <div style="font-size:40px; font-weight:bold; color:var(--primary); margin-bottom:20px;" id="r-final-score">0</div>
                <button class="btn-primary" style="width:200px;" onclick="startRacer()">TEKRAR</button>
                <button class="btn-danger" style="width:200px; background:transparent;" onclick="document.getElementById('racer-menu').style.display='flex'; document.getElementById('racer-over').style.display='none';">MEN√ú</button>
            </div>
        </div>

        <div class="mobile-controls">
            <button class="control-btn" ontouchstart="moveCar(-1)" onmousedown="moveCar(-1)">‚¨ÖÔ∏è</button>
            <button class="control-btn" ontouchstart="moveCar(1)" onmousedown="moveCar(1)">‚û°Ô∏è</button>
        </div>
    </div>
</div>

<div id="mainModal" class="modal">
    <div class="modal-content">
        <div class="modal-text" id="modalMsg">...</div>
        <div class="modal-actions" id="modalActions"></div>
    </div>
</div>

<footer>
    <div>¬© 2026 √áarptrik.</div>
    <div style="margin-top:5px;">
        <span data-i18n="iletisim_text">√ñneri ve Hata:</span>
        <a href="mailto:carptrik@gmail.com">carptrik@gmail.com</a>
    </div>
</footer>

<script>
/* =========================================
   GLOBAL STATE & UTILS
   ========================================= */
const state = {
    mode: 'classic', // classic | racer
    lang: 'tr',
    db: JSON.parse(localStorage.getItem('carptrik_data')) || {},
    history: JSON.parse(localStorage.getItem('carptrik_history')) || [],
    classic: {
        activeList: [],
        total: 0,
        currentIdx: 0,
        score: 100,
        times: [],
        errors: 0,
        paused: false,
        startTime: 0,
        pauseTime: 0,
        currentQ: null
    },
    racer: {
        active: false,
        lane: 1,
        score: 0,
        lives: 3,
        speed: 5,
        cars: [],
        particles: [],
        q: null
    }
};

const text = {
    tr: {
        alert_sayi_sec: "L√ºtfen en az bir sayƒ± grubu se√ßin!",
        alert_hata_yok: "Hata listeniz temiz!",
        confirm_bitir: "Bitirmek istediƒüine emin misin?",
        confirm_sil: "T√ºm verileri silmek istiyor musun?",
        dogru: "DOƒûRU!", yanlis: "YANLI≈û!", yavas: "YAVA≈û!",
        hata_listesi: "HATA Lƒ∞STESƒ∞", liste_temiz: "Liste temiz.", hata_tekrar: "HATA √áALI≈ûMA",
        hatalara_calis: "HATALARA √áALI≈û", listeyi_temizle: "TEMƒ∞ZLE", carp_sayilar: "SAYI SE√áƒ∞Mƒ∞",
        oyun_modu: "OYUN MODU", baslat: "BA≈ûLAT", seans_bitti: "SEANS Bƒ∞TTƒ∞",
        gecmis_skorlar: "GE√áMƒ∞≈û", gecmis_yok: "Kayƒ±t yok.", gecmisi_sil: "Sƒ∞L",
        iletisim_text: "√ñneri ve Hata:"
    },
    en: {
        alert_sayi_sec: "Please select numbers!",
        alert_hata_yok: "No errors recorded!",
        confirm_bitir: "Are you sure you want to finish?",
        confirm_sil: "Delete all data?",
        dogru: "CORRECT!", yanlis: "WRONG!", yavas: "SLOW!",
        hata_listesi: "ERROR LIST", liste_temiz: "Clean list.", hata_tekrar: "ERROR MODE",
        hatalara_calis: "PRACTICE ERRORS", listeyi_temizle: "CLEAR", carp_sayilar: "NUMBERS",
        oyun_modu: "GAME MODE", baslat: "START", seans_bitti: "SESSION END",
        gecmis_skorlar: "HISTORY", gecmis_yok: "No records.", gecmisi_sil: "CLEAR",
        iletisim_text: "Contact:"
    }
};

function init() {
    // Load Lang
    const savedLang = localStorage.getItem('carptrik_lang');
    if (savedLang) state.lang = savedLang;
    setLanguage(state.lang);

    // Load Settings
    const savedSettings = JSON.parse(localStorage.getItem('carptrik_settings'));
    if (savedSettings) applySettings(savedSettings);

    updateLists();
}

function setLanguage(l) {
    state.lang = l;
    localStorage.setItem('carptrik_lang', l);
    document.querySelectorAll('.lang-btn').forEach(b => b.classList.remove('active'));
    document.getElementById('lang-'+l).classList.add('active');
    
    document.querySelectorAll('[data-i18n]').forEach(el => {
        const k = el.getAttribute('data-i18n');
        if(text[l][k]) el.innerText = text[l][k];
    });
    updateLists();
}

function setMode(m) {
    state.mode = m;
    document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
    document.getElementById('tab-'+m).classList.add('active');
    
    document.getElementById('view-classic').classList.add('hidden');
    document.getElementById('view-racer').classList.add('hidden');
    document.getElementById('view-'+m).classList.remove('hidden');

    // Container sƒ±nƒ±flarƒ±nƒ± ayarla (layout i√ßin)
    const container = document.querySelector('.app-container');
    container.className = `app-container ${m}-layout`;

    if(m === 'racer') {
        setTimeout(initRacerCanvas, 100); // Wait for flex layout
    } else {
        state.racer.active = false;
    }
}

function modal(msg, onYes) {
    const m = document.getElementById('mainModal');
    document.getElementById('modalMsg').innerText = msg;
    const acts = document.getElementById('modalActions');
    
    if(onYes) {
        acts.innerHTML = `
            <button class="modal-btn btn-confirm" onclick="confirmAction()">EVET</button>
            <button class="modal-btn btn-cancel" onclick="closeModal()">ƒ∞PTAL</button>
        `;
        window.confirmAction = () => { onYes(); closeModal(); };
    } else {
        acts.innerHTML = `<button class="modal-btn btn-confirm" onclick="closeModal()">TAMAM</button>`;
    }
    m.style.display = 'flex';
}
function closeModal() { document.getElementById('mainModal').style.display = 'none'; }

/* =========================================
   CLASSIC MODE LOGIC
   ========================================= */
const inputEl = document.getElementById('answer-input');

function toggleAll(val) {
    document.querySelectorAll('.num-chk').forEach(c => c.checked = val);
}

function getSelectedNumbers() {
    return Array.from(document.querySelectorAll('.num-chk:checked')).map(c => parseInt(c.value));
}

function startClassic() {
    const nums = getSelectedNumbers();
    if(nums.length === 0) return modal(text[state.lang].alert_sayi_sec);
    
    // Save Settings
    localStorage.setItem('carptrik_settings', JSON.stringify({
        nums: nums,
        mode: document.querySelector('input[name="gameMode"]:checked').value,
        repeat: document.getElementById('inp-repeat').value,
        limit: document.getElementById('inp-limit').value
    }));

    // Build Questions
    state.classic.activeList = [];
    const mode = document.querySelector('input[name="gameMode"]:checked').value;
    
    let pool = [];
    nums.forEach(n1 => {
        nums.forEach(n2 => {
            pool.push({n1, n2});
        });
    });

    if(mode === 'repeat') {
        const count = parseInt(document.getElementById('inp-repeat').value) || 1;
        for(let i=0; i<count; i++) state.classic.activeList.push(...pool);
    } else {
        const limit = parseInt(document.getElementById('inp-limit').value) || 20;
        for(let i=0; i<limit; i++) {
            state.classic.activeList.push(pool[Math.floor(Math.random() * pool.length)]);
        }
    }
    state.classic.activeList.sort(() => Math.random() - 0.5);

    // Reset State
    state.classic.total = state.classic.activeList.length;
    state.classic.currentIdx = 0;
    state.classic.score = 100;
    state.classic.times = [];
    state.classic.errors = 0;
    state.classic.paused = false;

    // UI Switch
    document.getElementById('classic-setup').classList.add('hidden');
    document.getElementById('classic-result').classList.add('hidden');
    document.getElementById('classic-play').classList.remove('hidden');
    
    nextQuestion();
}

function nextQuestion() {
    if(state.classic.currentIdx >= state.classic.total) return finishGame();
    
    const q = state.classic.activeList[state.classic.currentIdx];
    state.classic.currentQ = q;
    
    document.getElementById('question-text').innerText = `${q.n1} x ${q.n2}`;
    document.getElementById('disp-q').innerText = state.classic.currentIdx + 1;
    document.getElementById('disp-total').innerText = state.classic.total;
    document.getElementById('disp-score').innerText = state.classic.score;
    document.getElementById('feedback').innerText = "";
    
    inputEl.value = '';
    inputEl.disabled = false;
    inputEl.focus();
    state.classic.startTime = Date.now();
}

function checkAnswer() {
    const val = inputEl.value;
    if(!val) return;
    
    const userAns = parseInt(val);
    const realAns = state.classic.currentQ.n1 * state.classic.currentQ.n2;
    const time = (Date.now() - state.classic.startTime) / 1000;
    const key = `${state.classic.currentQ.n1}x${state.classic.currentQ.n2}`;
    
    if(!state.db[key]) state.db[key] = {score: 0};

    const fb = document.getElementById('feedback');
    
    if(userAns === realAns) {
        state.classic.times.push(time);
        fb.innerText = text[state.lang].dogru;
        fb.style.color = 'var(--primary)';
        if(state.db[key].score > 0) state.db[key].score--;
        
        // Speed Calculation
        const avg = state.classic.times.reduce((a,b)=>a+b,0) / state.classic.times.length;
        document.getElementById('disp-speed').innerText = avg.toFixed(1) + 's';
        
        state.classic.currentIdx++;
        setTimeout(nextQuestion, 500);
    } else {
        fb.innerText = text[state.lang].yanlis;
        fb.style.color = 'var(--danger)';
        state.db[key].score += 2;
        state.classic.score = Math.max(0, state.classic.score - 5);
        state.classic.errors++;
        
        // Retry delay
        setTimeout(nextQuestion, 1000);
    }
    
    if(state.db[key].score <= 0) delete state.db[key];
    saveDB();
}

inputEl.addEventListener('input', () => {
    const realAns = state.classic.currentQ.n1 * state.classic.currentQ.n2;
    if(inputEl.value.length >= realAns.toString().length) checkAnswer();
});

function finishGameConfirm() {
    modal(text[state.lang].confirm_bitir, finishGame);
}

function finishGame() {
    // Proportional Score Logic
    if (state.classic.total > 0 && state.classic.currentIdx < state.classic.total) {
        const ratio = state.classic.currentIdx / state.classic.total;
        state.classic.score = Math.round(state.classic.score * ratio);
    }

    const avg = state.classic.times.length ? (state.classic.times.reduce((a,b)=>a+b,0)/state.classic.times.length).toFixed(2) : "0.0";
    
    // Save History
    state.history.unshift({
        score: state.classic.score,
        speed: avg,
        errors: state.classic.errors,
        q: state.classic.currentIdx,
        date: new Date().toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'})
    });
    if(state.history.length > 20) state.history.pop();
    localStorage.setItem('carptrik_history', JSON.stringify(state.history));
    updateLists();

    // Show Result
    document.getElementById('classic-play').classList.add('hidden');
    document.getElementById('classic-result').classList.remove('hidden');
    
    document.getElementById('final-score').innerText = state.classic.score;
    document.getElementById('final-speed').innerText = avg + 's';
    document.getElementById('final-errors').innerText = state.classic.errors;
}

function backToSetup() {
    document.getElementById('classic-result').classList.add('hidden');
    document.getElementById('classic-setup').classList.remove('hidden');
}

function startErrorPractice() {
    const keys = Object.keys(state.db);
    if(keys.length === 0) return modal(text[state.lang].alert_hata_yok);
    
    state.classic.activeList = [];
    const mode = document.querySelector('input[name="errorMode"]:checked').value;
    
    keys.forEach(k => {
        const [n1, n2] = k.split('x').map(Number);
        const count = mode === 'single' ? 1 : state.db[k].score;
        for(let i=0; i<count; i++) state.classic.activeList.push({n1, n2});
    });
    
    state.classic.activeList.sort(() => Math.random() - 0.5);
    
    // Setup UI
    state.classic.total = state.classic.activeList.length;
    state.classic.currentIdx = 0;
    state.classic.score = 100;
    state.classic.times = [];
    state.classic.errors = 0;
    
    document.getElementById('classic-setup').classList.add('hidden');
    document.getElementById('classic-play').classList.remove('hidden');
    nextQuestion();
}

function pauseGame() {
    if(state.classic.paused) {
        state.classic.paused = false;
        document.getElementById('question-text').classList.remove('blur');
        inputEl.disabled = false;
        inputEl.focus();
        state.classic.startTime += (Date.now() - state.classic.pauseTime);
    } else {
        state.classic.paused = true;
        document.getElementById('question-text').classList.add('blur');
        inputEl.disabled = true;
        state.classic.pauseTime = Date.now();
        modal("OYUN DURAKLATILDI", pauseGame); // Using modal to resume
    }
}

/* =========================================
   RACER MODE LOGIC
   ========================================= */
const canvas = document.getElementById('racerCanvas');
const ctx = canvas.getContext('2d');
let racerLoopId;

function initRacerCanvas() {
    const container = document.getElementById('racer-area');
    canvas.width = container.offsetWidth;
    canvas.height = container.offsetHeight;
}

function startRacer() {
    const nums = getSelectedNumbers();
    if(nums.length === 0) return modal(text[state.lang].alert_sayi_sec);

    document.getElementById('racer-menu').style.display = 'none';
    document.getElementById('racer-over').style.display = 'none';
    
    state.racer.active = true;
    state.racer.score = 0;
    state.racer.lives = 3;
    state.racer.speed = 4;
    state.racer.cars = [];
    state.racer.particles = [];
    state.racer.lane = 1;
    
    updateRacerStats();
    spawnRacerQ();
    racerLoopId = requestAnimationFrame(racerLoop);
}

function spawnRacerQ() {
    const nums = getSelectedNumbers();
    const n1 = nums[Math.floor(Math.random() * nums.length)];
    const n2 = Math.floor(Math.random() * 9) + 2;
    const ans = n1 * n2;
    
    state.racer.q = { ans: ans };
    document.getElementById('r-question').innerText = `${n1} x ${n2}`;

    // Generate Answers
    let answers = [ans];
    while(answers.length < 4) {
        let fake = ans + (Math.floor(Math.random() * 10) - 5);
        if(fake !== ans && fake > 0 && !answers.includes(fake)) answers.push(fake);
    }
    answers.sort(() => Math.random() - 0.5);

    // Create Cars
    for(let i=0; i<4; i++) {
        state.racer.cars.push({
            lane: i,
            y: -200, // Start way above
            val: answers[i],
            isCorrect: answers[i] === ans,
            color: answers[i] === ans ? '#ffaa00' : ['#ff4757','#2ed573','#1e90ff'][Math.floor(Math.random()*3)]
        });
    }
}

function racerLoop() {
    if(!state.racer.active) return;

    ctx.clearRect(0, 0, canvas.width, canvas.height);
    const laneW = canvas.width / 4;

    // Draw Road
    ctx.fillStyle = "#222";
    ctx.fillRect(0,0,canvas.width, canvas.height);
    ctx.strokeStyle = "#444";
    ctx.setLineDash([20, 20]);
    ctx.lineWidth = 2;
    for(let i=1; i<4; i++) {
        ctx.beginPath(); ctx.moveTo(i*laneW, 0); ctx.lineTo(i*laneW, canvas.height); ctx.stroke();
    }

    // Player
    const pX = (state.racer.lane * laneW) + (laneW/2);
    const pY = canvas.height - 100;
    
    // Draw Player Car
    ctx.fillStyle = "#00ffaa";
    ctx.fillRect(pX - 20, pY, 40, 70); // Body
    ctx.fillStyle = "#000";
    ctx.fillRect(pX - 15, pY + 10, 30, 15); // Windshield
    // Headlights
    ctx.fillStyle = "rgba(0, 255, 170, 0.5)";
    ctx.beginPath(); ctx.moveTo(pX-15, pY); ctx.lineTo(pX-30, pY-100); ctx.lineTo(pX+30, pY-100); ctx.lineTo(pX+15, pY); ctx.fill();

    // Enemy Cars
    for(let i = state.racer.cars.length - 1; i >= 0; i--) {
        let c = state.racer.cars[i];
        c.y += state.racer.speed;
        
        const cX = (c.lane * laneW) + (laneW/2);
        
        // Draw Enemy
        ctx.fillStyle = c.color;
        ctx.fillRect(cX - 20, c.y, 40, 70);
        ctx.fillStyle = "#fff";
        ctx.font = "bold 20px Arial";
        ctx.textAlign = "center";
        ctx.fillText(c.val, cX, c.y + 45);

        // Collision Check
        if(c.y + 70 > pY && c.y < pY + 70 && c.lane === state.racer.lane) {
            // HIT!
            if(c.isCorrect) {
                state.racer.score += 10;
                state.racer.speed += 0.2;
                createExplosion(cX, c.y);
                state.racer.cars = []; // Clear others
                setTimeout(spawnRacerQ, 500);
            } else {
                state.racer.lives--;
                shakeScreen();
                state.racer.cars.splice(i, 1);
                if(state.racer.lives <= 0) return gameOverRacer();
            }
            updateRacerStats();
        } 
        // Missed (Fell off screen)
        else if(c.y > canvas.height) {
            state.racer.cars.splice(i, 1);
            if(c.isCorrect && state.racer.cars.length === 0) spawnRacerQ(); // Missed correct one, respawn
        }
    }

    // Particles
    for(let i=state.racer.particles.length-1; i>=0; i--) {
        let p = state.racer.particles[i];
        p.x += p.vx; p.y += p.vy; p.life--;
        ctx.fillStyle = p.color;
        ctx.fillRect(p.x, p.y, p.size, p.size);
        if(p.life <= 0) state.racer.particles.splice(i, 1);
    }

    requestAnimationFrame(racerLoop);
}

function moveCar(dir) {
    let newLane = state.racer.lane + dir;
    if(newLane >= 0 && newLane <= 3) state.racer.lane = newLane;
}

// Keyboard controls
window.addEventListener('keydown', (e) => {
    if(!state.racer.active) return;
    if(e.key === 'ArrowLeft' || e.key === 'a') moveCar(-1);
    if(e.key === 'ArrowRight' || e.key === 'd') moveCar(1);
});

function createExplosion(x, y) {
    for(let i=0; i<15; i++) {
        state.racer.particles.push({
            x: x, y: y,
            vx: (Math.random()-0.5)*10, vy: (Math.random()-0.5)*10,
            life: 30, size: Math.random()*5+2, color: '#fff'
        });
    }
}

function shakeScreen() {
    const el = document.getElementById('racer-area');
    el.classList.add('shake');
    setTimeout(() => el.classList.remove('shake'), 500);
}

function updateRacerStats() {
    document.getElementById('r-score').innerText = state.racer.score;
    document.getElementById('r-lives').innerText = state.racer.lives;
}

function gameOverRacer() {
    state.racer.active = false;
    document.getElementById('r-final-score').innerText = state.racer.score;
    document.getElementById('racer-over').style.display = 'flex';
}

/* =========================================
   DATA & UI HELPERS
   ========================================= */
function updateLists() {
    // Errors
    const list = document.getElementById('error-list');
    let html = "";
    if(Object.keys(state.db).length === 0) {
        list.innerHTML = `<div style="text-align:center; color:#555; padding:10px;">${text[state.lang].liste_temiz}</div>`;
    } else {
        Object.keys(state.db).sort((a,b) => state.db[b].score - state.db[a].score).forEach(k => {
            html += `<div class="list-row"><span>${k}</span><b>+${state.db[k].score}</b></div>`;
        });
        list.innerHTML = html;
    }

    // History
    const hist = document.getElementById('history-list');
    let hHtml = "";
    if(state.history.length === 0) {
        hist.innerHTML = `<div style="text-align:center; color:#555; padding:10px;">${text[state.lang].gecmis_yok}</div>`;
    } else {
        state.history.forEach(h => {
            hHtml += `<div class="list-row">
                <b style="color:var(--primary);">${h.score}</b>
                <span>${h.speed}s</span>
                <span style="color:${h.errors>0?'var(--danger)':'#666'}">${h.errors}</span>
                <span style="color:#666;">${h.q}</span>
            </div>`;
        });
        hist.innerHTML = hHtml;
    }
}

function saveDB() {
    localStorage.setItem('carptrik_data', JSON.stringify(state.db));
    updateLists();
}

function resetData() {
    modal(text[state.lang].confirm_sil, () => {
        state.db = {};
        saveDB();
    });
}

function clearHistory() {
    modal(text[state.lang].confirm_sil, () => {
        state.history = [];
        localStorage.setItem('carptrik_history', JSON.stringify([]));
        updateLists();
    });
}

function applySettings(s) {
    if(s.nums) {
        document.querySelectorAll('.num-chk').forEach(c => {
            c.checked = s.nums.includes(parseInt(c.value));
        });
    }
    // Other simple settings can be added here
}

// Init
init();
window.addEventListener('resize', () => {
    if(state.mode === 'racer' && state.racer.active) initRacerCanvas();
});

</script>
</body>
</html>
